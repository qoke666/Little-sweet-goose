<!DOCTYPE html>
<html lang="ru">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width, initial-scale=1,maximum-scale=1,user-scalable=no" />
<title>Little Sweet Goose — manual filling offsets</title>
<script src="https://cdn.tailwindcss.com"></script>
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.15.4/css/all.min.css">
<style>
  body { font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, sans-serif; margin:0; background:#f3f4f6; }
  .header-elements { position: fixed; top:0; left:0; right:0; z-index:40; padding:16px; display:flex; align-items:center; justify-content:space-between; background:#fff; box-shadow:0 2px 4px rgba(0,0,0,.08); }
  .product-image-carousel { position: relative; width:100%; height:288px; overflow:hidden; border-radius:12px; background:#e5e7eb; margin-bottom:16px; }
  .product-image-carousel img { width:100%; height:100%; object-fit:cover; position:absolute; top:0; left:0; opacity:0; transition:opacity .38s ease, transform .38s ease; }
  .product-image-carousel img.active { opacity:1; z-index:1; transform:translateX(0); }
  .product-image-dots { position:absolute; bottom:8px; left:50%; transform:translateX(-50%); display:flex; gap:5px; z-index:2; }
  .product-image-dots .dot { width:6px; height:6px; border-radius:50%; background:rgba(255,255,255,.5); }
  .product-image-dots .dot.active { background:#fff; }

  /* Контейнер для картинки начинки — картинка центрируется, затем применяется офсет */
  .filling-image-container { position: relative; aspect-ratio:4/3; max-height:140px; overflow:hidden; border-radius:8px; background:#fff; display:block; }
  .filling-image {
    position: absolute;
    left: 50%;
    top: 50%;
    /* По умолчанию центрируем (-50%,-50%), и прибавляем смещение offsetX/offsetY в процентах */
    transform: translate(calc(-50% + var(--fx, 0%)), calc(-50% + var(--fy, 0%)));
    max-width: 85%;
    max-height: 88px;
    object-fit: contain;
    border-radius:8px;
    transition: transform .12s linear;
    user-select: none;
    pointer-events: none; /* чтобы не мешала кликам по кнопкам вокруг */
  }

  .filling-btn { cursor:pointer; }
  .size-btn { cursor:pointer; }
  .cart-modal, .product-detail { height:100dvh; max-height:100dvh; overflow-y:auto; }
  .input-field { width:100%; box-sizing:border-box; transition:border-color .2s; }
  .input-field:focus { outline: none; border-color: #db2777; }
  .quantity-btn { display:flex; align-items:center; justify-content:center; width:32px; height:32px; border-radius:50%; background:#f3f4f6; }
  .hot-badge { position:absolute; top:8px; left:8px; background:#dc2626; color:#fff; padding:4px 8px; border-radius:12px; font-size:10px; font-weight:700; }
  .btn-primary { transition: all .18s ease; box-shadow:0 2px 6px rgba(0,0,0,.08); }
  #checkout-modal { position: fixed; left:0; right:0; bottom:0; z-index:60; transform:translateY(110%); transition: transform .28s ease; background:#fff; border-top-left-radius:12px; border-top-right-radius:12px; max-height:85vh; overflow:auto; }
  #checkout-modal.open { transform: translateY(0); }
  .cart-list { max-height: calc(100vh - 220px); overflow:auto; padding:1rem; }
</style>
</head>
<body class="bg-gray-100">

  <div class="header-elements">
    <div class="flex items-center gap-3">
      <button id="cart-btn" class="p-2 hover:bg-gray-100 rounded-full" title="Корзина">
        <svg class="w-7 h-7" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M3 3h2l.4 2M7 13h10l4-8H5.4M7 13L5.4 5M7 13l-2.293 2.293c-.63.63-.184 1.707.707 1.707H17"/></svg>
      </button>
      <h1 class="text-xl font-bold">Little Sweet Goose</h1>
    </div>
    <div class="flex items-center gap-3">
      <a href="#" class="text-gray-500"><i class="fab fa-telegram-plane"></i></a>
      <a href="#" class="text-gray-500"><i class="fab fa-instagram"></i></a>
    </div>
  </div>

  <main class="pt-24 pb-20 px-4 max-w-7xl mx-auto relative">
    <div class="flex items-center justify-between my-5">
      <h2 class="text-xl font-bold text-gray-800">Товары</h2>
      <span id="products-count" class="text-sm text-gray-600">0 товаров</span>
    </div>
    <div id="products-grid" class="grid grid-cols-2 gap-4 md:grid-cols-3 lg:grid-cols-4 mb-10"></div>
  </main>

  <!-- cart modal -->
  <div id="cart-modal" class="fixed inset-0 bg-white z-50 transform translate-y-full transition-transform duration-300">
    <div class="flex flex-col h-full">
      <div class="flex items-center justify-between p-4 border-b bg-white shadow-sm sticky top-0">
        <button id="cart-back-btn" title="Назад"><svg class="w-7 h-7" viewBox="0 0 24 24" fill="none" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 19l-7-7 7-7"/></svg></button>
        <h2 class="text-xl font-bold">Корзина</h2>
        <button id="cart-close-btn" title="Закрыть"><svg class="w-7 h-7" viewBox="0 0 24 24" fill="none" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"/></svg></button>
      </div>
      <div id="cart-content" class="flex-grow flex flex-col"></div>
    </div>
  </div>

  <!-- product detail -->
  <div id="product-detail" class="fixed inset-0 bg-white z-50 transform translate-y-full transition-transform duration-300">
    <div class="flex flex-col h-full">
      <div class="flex items-center justify-between p-4 border-b bg-white shadow-sm sticky top-0">
        <button id="detail-back-btn" title="Назад"><svg class="w-7 h-7" viewBox="0 0 24 24" fill="none" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 19l-7-7 7-7"/></svg></button>
        <h2 id="detail-title" class="text-xl font-bold"></h2>
        <button id="detail-close-btn" title="Закрыть"><svg class="w-7 h-7" viewBox="0 0 24 24" fill="none" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"/></svg></button>
      </div>
      <div id="detail-content" class="flex-1 overflow-auto p-4"></div>
    </div>
  </div>

  <!-- checkout modal -->
  <div id="checkout-modal" aria-hidden="true">
    <div class="p-4 border-b flex items-start gap-3">
      <div class="flex-1">
        <h3 class="text-lg font-bold">Оформление заказа</h3>
        <p class="text-sm text-gray-600">Самовывоз: <strong>Алексеева 43</strong></p>
      </div>
      <button id="checkout-close" class="text-gray-500" title="Закрыть"><svg class="w-6 h-6" viewBox="0 0 24 24" fill="none" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"/></svg></button>
    </div>
    <div class="p-4 space-y-4">
      <div class="grid grid-cols-1 gap-3">
        <label class="text-sm font-semibold">Дата самовывоза</label>
        <input id="checkout-date" type="date" class="input-field border rounded-lg p-3 text-sm w-full" min="" required>
        <label class="text-sm font-semibold">Время</label>
        <input id="checkout-time" type="time" class="input-field border rounded-lg p-3 text-sm w-full" min="09:00" max="21:00" required>
        <label class="text-sm font-semibold">Телефон для связи</label>
        <input id="checkout-phone" type="tel" placeholder="+7 (999) 123-45-67" class="input-field border rounded-lg p-3 text-sm w-full" required>
      </div>

      <div class="flex items-center justify-between font-bold text-base text-gray-800 pt-3 border-t">
        <span>Итого</span><span id="checkout-total" class="text-pink-600">0 ₽</span>
      </div>

      <div class="space-y-2">
        <button id="place-order-btn" class="btn-primary w-full h-12 bg-pink-600 text-white rounded-lg text-base font-semibold flex items-center justify-center gap-2 shadow-md">Оформить заказ</button>
        <button id="checkout-back-btn" class="w-full h-12 border rounded-lg text-base">Вернуться к корзине</button>
      </div>
    </div>
  </div>

<script>
/*
  Инструкция:
  - Чтобы вручную сдвинуть картинку начинки, открой этот файл в редакторе.
  - Найди массив `products` ниже. Внутри каждого объекта начинки (`fillings`) есть поля
    offsetX и offsetY (в процентах).
  - Пример: { name: 'Маковый лимон', image: '...', offsetX: -10, offsetY: 5 }
    — сдвинет картинку на 10% влево и на 5% вниз от центра.
*/

const appState = {
  cart: [],
  selectedProduct: null,
  selectedSize: 'S',
  selectedFilling: null,
  detailQuantity: 1
};

// ================== PRODUCTS (редактируй offsetX/offsetY тут) ==================
const products = [
  {
    id: '1',
    name: 'Бенто-торт',
    description: 'Компактный торт с индивидуальным дизайном',
    price: 1400,
    sizes: [{size:'S',diameter:'10 см',weight:'450-550 г',price:1400}],
    fillings: [
      { name: 'Маковый лимон с клубникой', image: 'https://i.postimg.cc/2S7kFCFG/image.webp', offsetX: 50, offsetY: 0 },
      { name: 'Тропики манго-маракуйя', image: 'https://i.postimg.cc/nzCnJB8S/image.webp', offsetX: 50, offsetY: 0 },
      { name: 'Пломбир малина-апельсин', image: 'https://i.postimg.cc/Kj6VCgFT/image.webp', offsetX: 50, offsetY: 0 }
    ],
    images: ['https://i.postimg.cc/Wznctb7p/photo-2024-11-25-07-51-57.jpg'],
    cartImage: 'https://i.postimg.cc/Wznctb7p/photo-2024-11-25-07-51-57.jpg',
    category: 'bento', isHot: true
  },
  {
    id: '2',
    name: 'Моти',
    description: 'Нежные японские рисовые пирожные',
    price: 100,
    fillings: [
      { name: 'смородина', image: 'https://i.postimg.cc/kXVgzs0r/photo-2024-11-25-07-59-12.jpg', offsetX: 0, offsetY: 0 },
      { name: 'банан', image: 'https://i.postimg.cc/bwkNNJY3/photo-2024-11-25-07-59-11.jpg', offsetX: 0, offsetY: 0 },
      { name: 'апельсиновый мокко', image: 'https://i.postimg.cc/Kj6VCgFT/image.webp', offsetX: 0, offsetY: 0 },
      { name: 'баунти', image: 'https://i.postimg.cc/nzCnJB8S/image.webp', offsetX: 0, offsetY: 0 },
      { name: 'медовик', image: 'https://i.postimg.cc/2S7kFCFG/image.webp', offsetX: 0, offsetY: 0 }
    ],
    images: ['https://i.postimg.cc/kXVgzs0r/photo-2024-11-25-07-59-12.jpg'],
    cartImage: 'https://i.postimg.cc/kXVgzs0r/photo-2024-11-25-07-59-12.jpg',
    category: 'mochi', isHot: true
  },
  {
    id: '3',
    name: 'Картошка',
    description: 'Классическое пирожное',
    price: 120,
    images: ['https://i.postimg.cc/yxGYW3Sr/photo-2024-11-25-08-45-29.jpg'],
    cartImage: 'https://i.postimg.cc/yxGYW3Sr/photo-2024-11-25-08-45-29.jpg',
    category: 'kartoshka'
  },
  {
    id: '4',
    name: 'Трюфели',
    description: 'Шоколадные трюфели ручной работы',
    price: 150,
    fillings: [
      { name: 'Апельсиновый', image: 'https://i.postimg.cc/qR9Z0t66/photo-2025-04-25-20-09-35.jpg', offsetX: 0, offsetY: 0 },
      { name: 'Лимонный', image: 'https://i.postimg.cc/xCkFWG8S/photo-2025-04-25-20-09-36.jpg', offsetX: 0, offsetY: 0 },
      { name: 'Фисташковый', image: 'https://i.postimg.cc/tgvMSvX5/photo-2025-04-25-20-09-38.jpg', offsetX: 0, offsetY: 0 },
      { name: 'малиновый', image: 'https://i.postimg.cc/7h3T2VwQ/photo-2024-12-09-17-53-44.jpg', offsetX: 0, offsetY: 0 },
      { name: 'Ореховый', image: 'https://i.postimg.cc/Kj6VCgFT/image.webp', offsetX: 0, offsetY: 0 }
    ],
    images: ['https://i.postimg.cc/qR9Z0t66/photo-2025-04-25-20-09-35.jpg'],
    cartImage: 'https://i.postimg.cc/qR9Z0t66/photo-2025-04-25-20-09-35.jpg',
    category: 'truffles'
  },
  {
    id: '5',
    name: 'Мадлен',
    description: 'Нежные французские бисквитные печенья',
    price: 80,
    fillings: [
      { name: 'Красный бархат с малиной', image: 'https://via.placeholder.com/300?text=Red+Velvet', offsetX: 0, offsetY: 0 },
      { name: 'Шоколад-кофе-апельсин', image: 'https://via.placeholder.com/300?text=Choco+Coffee', offsetX: 0, offsetY: 0 },
      { name: 'Фисташка-малина', image: 'https://via.placeholder.com/300?text=Pistachio+Raspberry', offsetX: 0, offsetY: 0 },
      { name: 'Маковый лимон', image: 'https://via.placeholder.com/300?text=Poppy+Lemon', offsetX: 0, offsetY: 0 }
    ],
    images: ['https://via.placeholder.com/150?text=Madeleine1'],
    cartImage: 'https://via.placeholder.com/150?text=Madeleine1',
    category: 'madeleine'
  }
];
// =============================================================================

// элементы
const els = {
  productsGrid: document.getElementById('products-grid'),
  productsCount: document.getElementById('products-count'),
  detailContent: document.getElementById('detail-content'),
  detailTitle: document.getElementById('detail-title'),
  productDetail: document.getElementById('product-detail'),
  cartBtn: document.getElementById('cart-btn'),
  cartModal: document.getElementById('cart-modal'),
  cartContent: document.getElementById('cart-content'),
  cartCloseBtn: document.getElementById('cart-close-btn'),
  cartBackBtn: document.getElementById('cart-back-btn'),
  checkoutModal: document.getElementById('checkout-modal'),
  checkoutDate: document.getElementById('checkout-date'),
  checkoutTime: document.getElementById('checkout-time'),
  checkoutPhone: document.getElementById('checkout-phone'),
  checkoutTotal: document.getElementById('checkout-total'),
  placeOrderBtn: document.getElementById('place-order-btn'),
  checkoutClose: document.getElementById('checkout-close'),
  checkoutBackBtn: document.getElementById('checkout-back-btn'),
  cartBadge: document.getElementById('cart-btn') // unused visual badge omitted for brevity
};

// рендер списка товаров
function renderProducts() {
  els.productsCount.textContent = `${products.length} товаров`;
  els.productsGrid.innerHTML = products.map(p => productCard(p)).join('');
}

// карточка товара
function productCard(p) {
  const price = p.sizes ? p.sizes[0].price : p.price;
  return `
    <div class="product-card bg-white rounded-lg shadow-sm flex flex-col relative cursor-pointer" data-id="${p.id}">
      <div class="relative h-36 bg-gray-200 rounded-t-lg overflow-hidden">
        <img src="${p.cartImage||p.images[0]||''}" class="w-full h-full object-cover" />
        ${p.isHot ? '<div class="hot-badge">HOT</div>' : ''}
      </div>
      <div class="p-4 flex flex-col flex-grow">
        <h3 class="font-semibold text-base mb-1">${escapeHtml(p.name)}</h3>
        <p class="text-sm text-gray-600 line-clamp-2 mb-2 h-10">${escapeHtml(p.description||'')}</p>
        <div class="mt-auto"><div class="font-bold text-pink-600">${price} ₽</div></div>
      </div>
    </div>
  `;
}

// события
function initEvents() {
  // клик на карточке открывает деталь
  els.productsGrid.addEventListener('click', e => {
    const card = e.target.closest('.product-card');
    if (!card) return;
    openProductDetailById(card.dataset.id);
  });
  document.getElementById('detail-close-btn').addEventListener('click', closeProductDetail);
  document.getElementById('detail-back-btn').addEventListener('click', closeProductDetail);
  els.cartBtn.addEventListener('click', openCart);
  els.cartCloseBtn.addEventListener('click', closeCart);
  els.cartBackBtn.addEventListener('click', closeCart);
  els.checkoutClose.addEventListener('click', closeCheckout);
  els.checkoutBackBtn.addEventListener('click', closeCheckout);
  els.placeOrderBtn.addEventListener('click', placeOrderFromCheckout);
}

// открыть деталь
function openProductDetailById(id) {
  const p = products.find(x => x.id === id);
  if (!p) return;
  appState.selectedProduct = p;
  appState.selectedSize = p.sizes ? p.sizes[0].size : null;
  appState.selectedFilling = (p.fillings && p.fillings[0]) ? p.fillings[0].name : null;
  appState.detailQuantity = 1;
  els.detailTitle.textContent = p.name;
  els.productDetail.style.transform = 'translateY(0)';
  renderProductDetail();
}

// закрыть деталь
function closeProductDetail() { els.productDetail.style.transform = 'translateY(100%)'; }

// рендер детали товара
function renderProductDetail() {
  const p = appState.selectedProduct;
  if (!p) return;
  const size = p.sizes ? p.sizes.find(s => s.size === appState.selectedSize) : null;
  const price = size ? size.price : p.price;

  // fillings UI (if present)
  let fillingsHtml = '';
  if (p.fillings && p.fillings.length) {
    fillingsHtml = `
      <div class="space-y-2">
        <h3 class="font-semibold text-base">Начинка</h3>
        <div class="grid grid-cols-2 gap-3 mb-2">
          ${p.fillings.map(f => `<button class="filling-btn p-3 rounded-lg border text-center ${appState.selectedFilling===f.name?'bg-pink-50 border-pink-300':''}" data-filling="${escapeHtml(f.name)}">${escapeHtml(f.name)}</button>`).join('')}
        </div>

        <div class="filling-image-container" id="filling-container">
          <!-- картинка начинки — позиция задаётся через offsetX/offsetY внутри products (в процентах) -->
          <img id="filling-image" class="filling-image" src="${(p.fillings.find(f=>f.name===appState.selectedFilling)||p.fillings[0]).image}" alt="Начинка">
        </div>
      </div>
    `;
  }

  els.detailContent.innerHTML = `
    <div class="product-image-carousel">
      ${(p.images||[]).map((img,i)=>`<img src="${img}" class="${i===0?'active':''}">`).join('')}
      <div class="product-image-dots">${(p.images||[]).map((_,i)=>`<div class="dot ${i===0?'active':''}"></div>`).join('')}</div>
    </div>

    <div class="space-y-4">
      <h1 class="text-xl font-bold">${escapeHtml(p.name)}</h1>
      ${p.sizes ? `<div><h3 class="font-semibold">Размер</h3><div class="grid grid-cols-3 gap-3">${p.sizes.map(s=>`<button class="size-btn p-3 border rounded ${appState.selectedSize===s.size?'bg-pink-50':''}" data-size="${s.size}">${s.size} (${s.diameter})<div class="text-xs text-gray-600">${s.weight} / ${s.price} ₽</div></button>`).join('')}</div></div>` : ''}
      ${fillingsHtml}
      <p class="text-gray-600 text-sm">${escapeHtml(p.description||'')}</p>

      <div class="space-y-3 pt-3">
        <div class="flex items-center justify-center gap-4">
          <button id="detail-qty-dec" class="quantity-btn">-</button>
          <span id="detail-quantity" class="font-semibold text-lg">${appState.detailQuantity}</span>
          <button id="detail-qty-inc" class="quantity-btn">+</button>
        </div>
        <button id="add-to-cart-detail" class="btn-primary w-full h-12 bg-pink-600 text-white rounded-lg">${price} ₽ — Добавить</button>
      </div>
    </div>
  `;

  // повесим обработчики
  // size buttons
  const sizeBtns = els.detailContent.querySelectorAll('.size-btn');
  sizeBtns.forEach(b => b.addEventListener('click', () => {
    const s = b.dataset.size; appState.selectedSize = s; renderProductDetail();
  }));

  // filling buttons
  const fillingBtns = els.detailContent.querySelectorAll('.filling-btn');
  fillingBtns.forEach(b => b.addEventListener('click', () => {
    const f = b.dataset.filling;
    appState.selectedFilling = f;
    // обновляем src и позицию
    const imgEl = document.getElementById('filling-image');
    const fObj = p.fillings.find(ff => ff.name === f);
    if (fObj) {
      imgEl.src = fObj.image;
      // применяем офсеты (берём поля offsetX, offsetY внутри объекта начинки)
      const ox = (typeof fObj.offsetX === 'number') ? fObj.offsetX : 0;
      const oy = (typeof fObj.offsetY === 'number') ? fObj.offsetY : 0;
      imgEl.style.setProperty('--fx', (ox) + '%');
      imgEl.style.setProperty('--fy', (oy) + '%');
    }
    // обновим active-класс кнопок
    fillingBtns.forEach(btn => btn.classList.toggle('bg-pink-50 border-pink-300', btn.dataset.filling === f));
  }));

  // quantity
  document.getElementById('detail-qty-dec').addEventListener('click', () => changeDetailQuantity(-1));
  document.getElementById('detail-qty-inc').addEventListener('click', () => changeDetailQuantity(1));

  // add to cart
  document.getElementById('add-to-cart-detail').addEventListener('click', () => {
    addToCart(p.id, appState.detailQuantity);
    closeProductDetail();
  });

  // применим офсет для текущей выбранной начинки (при открытии)
  const initialFilling = p.fillings && p.fillings.find(f => f.name === appState.selectedFilling) ? appState.selectedFilling : (p.fillings && p.fillings[0] && p.fillings[0].name);
  if (initialFilling) {
    const fObj = p.fillings.find(ff => ff.name === initialFilling);
    const imgEl = document.getElementById('filling-image');
    if (fObj && imgEl) {
      const ox = (typeof fObj.offsetX === 'number') ? fObj.offsetX : 0;
      const oy = (typeof fObj.offsetY === 'number') ? fObj.offsetY : 0;
      imgEl.style.setProperty('--fx', (ox) + '%');
      imgEl.style.setProperty('--fy', (oy) + '%');
    }
  }

  // небольшой swipe для product images (не трогаем логику, просто базовый)
  startProductImageCarouselInDetail();
}

// простой слайдер картинок в деталке (та же логика, что раньше)
function startProductImageCarouselInDetail() {
  const carousel = document.querySelector('.product-image-carousel');
  if (!carousel) return;
  const imgs = Array.from(carousel.querySelectorAll('img'));
  const dots = Array.from(carousel.querySelectorAll('.dot'));
  let idx = 0;
  function show(i) {
    imgs.forEach((im, j) => im.classList.toggle('active', j === i));
    dots.forEach((d, j) => d.classList.toggle('active', j === i));
    idx = i;
  }
  dots.forEach((d, i) => d.addEventListener('click', () => show(i)));
  let sx = 0;
  carousel.addEventListener('touchstart', e => { sx = e.touches[0].clientX; });
  carousel.addEventListener('touchend', e => {
    const ex = e.changedTouches[0].clientX;
    const delta = sx - ex;
    if (Math.abs(delta) > 40) {
      if (delta > 0 && idx < imgs.length - 1) show(idx + 1);
      else if (delta < 0 && idx > 0) show(idx - 1);
    }
  });
  show(0);
}

// количество в детальной
function changeDetailQuantity(delta) {
  appState.detailQuantity = Math.max(1, (appState.detailQuantity || 1) + delta);
  const el = document.getElementById('detail-quantity'); if (el) el.textContent = appState.detailQuantity;
}

// ========== CART minimal ==========
function addToCart(productId, quantity = 1) {
  const p = products.find(x => x.id === productId); if (!p) return;
  const selSize = p.sizes ? appState.selectedSize : null;
  const selFilling = p.fillings ? appState.selectedFilling : null;
  const existing = appState.cart.find(i => String(i.id) === String(productId) && (i.selectedSize||'') === (selSize||'') && (i.selectedFilling||'') === (selFilling||''));
  if (existing) existing.quantity += quantity;
  else appState.cart.push({ id: p.id, name: p.name, price: p.price, selectedSize: selSize, selectedFilling: selFilling, quantity });
  try { localStorage.setItem('cart', JSON.stringify(appState.cart)); } catch (e) {}
  renderCart();
}

function openCart() { document.getElementById('cart-modal').style.transform = 'translateY(0)'; renderCart(); }
function closeCart() { document.getElementById('cart-modal').style.transform = 'translateY(100%)'; }

function renderCart() {
  const c = appState.cart;
  if (!c || c.length === 0) {
    els.cartContent.innerHTML = `<div class="flex-1 flex flex-col items-center justify-center p-6"><p class="text-xl font-semibold">Корзина пуста</p><p class="text-sm text-gray-600">Добавьте вкусные десерты</p><button onclick="closeCart()" class="btn-primary mt-4 bg-pink-600 text-white rounded-lg p-3">Продолжить покупки</button></div>`;
    return;
  }
  const total = c.reduce((s, i) => {
    const prod = products.find(p => p.id === i.id);
    const sizeObj = prod && prod.sizes ? prod.sizes.find(s=>s.size===i.selectedSize) : null;
    const price = sizeObj ? sizeObj.price : (prod ? prod.price : i.price);
    return s + price * i.quantity;
  }, 0);

  els.cartContent.innerHTML = `
    <div class="cart-list">
      ${c.map(item => {
        const prod = products.find(p => p.id === item.id) || {};
        const sizeObj = prod.sizes ? prod.sizes.find(s=>s.size===item.selectedSize) : null;
        const price = sizeObj ? sizeObj.price : (prod.price||0);
        const fillingText = item.selectedFilling ? `, ${item.selectedFilling}` : '';
        return `<div class="flex gap-4 bg-white p-4 rounded-lg shadow-sm mb-3">
          <div class="w-20 h-20 bg-gray-100 rounded-lg flex-shrink-0 flex items-center justify-center overflow-hidden"><img src="${prod.cartImage||''}" class="w-full h-full object-cover"></div>
          <div class="flex-1 min-w-0">
            <div class="font-semibold">${item.name}${item.selectedSize?` (${item.selectedSize}${fillingText})`:''}</div>
            <div class="text-pink-600 font-semibold">${price} ₽ × ${item.quantity} = ${price * item.quantity} ₽</div>
            <div class="flex items-center justify-between mt-2">
              <div class="flex items-center gap-3">
                <button class="quantity-btn" onclick="updateCartQuantity('${item.id}', ${item.quantity - 1}, '${item.selectedSize||''}', '${item.selectedFilling||''}')">-</button>
                <div class="w-8 text-center font-semibold">${item.quantity}</div>
                <button class="quantity-btn" onclick="updateCartQuantity('${item.id}', ${item.quantity + 1}, '${item.selectedSize||''}', '${item.selectedFilling||''}')">+</button>
              </div>
              <button onclick="removeFromCart('${item.id}', '${item.selectedSize||''}', '${item.selectedFilling||''}')" class="text-red-500">Удалить</button>
            </div>
          </div>
        </div>`;
      }).join('')}
    </div>

    <div class="border-t p-4 sticky bottom-0 bg-white">
      <div class="flex justify-between items-center mb-3">
        <div>Товаров: <strong>${c.length}</strong></div>
        <div class="text-lg font-bold text-pink-600">${total} ₽</div>
      </div>
      <div class="grid grid-cols-2 gap-3">
        <button id="checkout-open-btn" class="col-span-2 bg-pink-600 text-white h-12 rounded-lg">Перейти к оформлению</button>
        <button onclick="clearCart()" class="h-12 border rounded-lg">Очистить</button>
        <button onclick="closeCart()" class="h-12 border rounded-lg">Продолжить покупки</button>
      </div>
    </div>
  `;
  const checkoutBtn = document.getElementById('checkout-open-btn');
  if (checkoutBtn) checkoutBtn.addEventListener('click', () => {
    openCheckout();
  });
}

function updateCartQuantity(productId, newQ, size, filling) {
  const idx = appState.cart.findIndex(i => String(i.id) === String(productId) && (i.selectedSize||'') === (size||'') && (i.selectedFilling||'') === (filling||''));
  if (idx === -1) return;
  if (newQ <= 0) { removeFromCart(productId, size, filling); return; }
  appState.cart[idx].quantity = newQ;
  try { localStorage.setItem('cart', JSON.stringify(appState.cart)); } catch (e) {}
  renderCart();
}
function removeFromCart(productId, size, filling) {
  appState.cart = appState.cart.filter(i => !(String(i.id) === String(productId) && (i.selectedSize||'') === (size||'') && (i.selectedFilling||'') === (filling||'')));
  try { localStorage.setItem('cart', JSON.stringify(appState.cart)); } catch (e) {}
  renderCart();
}
function clearCart() { appState.cart = []; try { localStorage.setItem('cart', JSON.stringify(appState.cart)); } catch (e) {} renderCart(); }

// ================= Checkout (минимально) =================
function openCheckout() {
  els.checkoutDate.min = new Date(Date.now() + 24*60*60*1000).toISOString().split('T')[0];
  els.checkoutDate.value = els.checkoutDate.min;
  updateCheckoutTotal();
  document.getElementById('checkout-modal').classList.add('open');
}
function closeCheckout() { document.getElementById('checkout-modal').classList.remove('open'); }
function updateCheckoutTotal() {
  const t = appState.cart.reduce((s,i)=> {
    const prod = products.find(p=>p.id===i.id);
    const sizeObj = prod && prod.sizes ? prod.sizes.find(s=>s.size===i.selectedSize) : null;
    const price = sizeObj ? sizeObj.price : (prod ? prod.price : 0);
    return s + price * i.quantity;
  },0);
  document.getElementById('checkout-total').textContent = `${t} ₽`;
}
function placeOrderFromCheckout() {
  if (!els.checkoutDate.value || !els.checkoutTime.value || !els.checkoutPhone.value) {
    alert('Заполните все поля');
    return;
  }
  if (!appState.cart.length) { alert('Корзина пуста'); return; }
  // тут можно отправлять на сервер — пока минимально:
  alert('Заказ оформлен. Спасибо!');
  appState.cart = []; try { localStorage.setItem('cart', JSON.stringify(appState.cart)); } catch (e) {}
  renderCart(); closeCheckout(); closeCart();
}

// утилиты
function escapeHtml(s){ return (s||'').replace(/&/g,'&amp;').replace(/</g,'&lt;').replace(/>/g,'&gt;').replace(/"/g,'&quot;'); }

// init
document.addEventListener('DOMContentLoaded', () => {
  // restore cart if present
  try { const c = localStorage.getItem('cart'); if (c) appState.cart = JSON.parse(c); } catch(e){}
  renderProducts(); initEvents();
  // if there is saved cart, render badge
  renderCart();
});
</script>
</body>
</html>
