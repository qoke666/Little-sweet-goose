<!DOCTYPE html>
<html lang="ru">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Детская школа карате</title>
  <link href="https://unpkg.com/aos@2.3.1/dist/aos.css" rel="stylesheet">
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css" defer>
  <script src="https://cdn.tailwindcss.com" defer></script>
  <style>
    @import url('https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600&family=Noto+Sans+JP:wght@400;500;700&display=swap');
    body { margin: 0; font-family: 'Inter', sans-serif; background: #1F2937; color: #F3F4F6; }
    #tsparticles { position: fixed; top: 0; left: 0; width: 100%; height: 100%; z-index: -1; }
    .menu-top { display: flex; justify-content: space-between; align-items: center; padding: 8px 16px; background: rgba(31, 41, 55, 0.9); backdrop-filter: blur(8px); position: sticky; top: 0; z-index: 20; }
    .menu { display: flex; justify-content: center; background: rgba(31, 41, 55, 0.9); backdrop-filter: blur(8px); padding: 6px 0; position: sticky; top: 48px; z-index: 10; }
    .menu ul { display: inline-flex; gap: 10px; padding: 0 16px; overflow-x: auto; white-space: nowrap; list-style: none; margin: 0; }
    .menu ul::-webkit-scrollbar { display: none; }
    .menu-item { padding: 6px 12px; border-radius: 6px; font-family: 'Noto Sans JP', sans-serif; font-weight: 600; font-size: 14px; cursor: pointer; color: #6B7280; transition: all 0.3s; }
    .menu-item.active, .menu-item:hover { background: #14B8A6; color: #F3F4F6; transform: scale(1.05); }
    .section { display: none; padding: 8px 16px; }
    .section.active { display: block; }
    .section-title { font-family: 'Noto Sans JP', sans-serif; font-size: 24px; font-weight: 700; margin: 16px 0; color: #14B8A6; text-align: center; }
    .card { background: rgba(55, 65, 81, 0.3); backdrop-filter: blur(8px); border: 1px solid rgba(20, 184, 166, 0.3); border-radius: 12px; padding: 12px; }
    .calendar-grid { display: grid; grid-template-columns: repeat(7, 1fr); gap: 8px; }
    .calendar-day { padding: 8px; border-radius: 6px; text-align: center; font-size: 12px; font-weight: 500; cursor: pointer; transition: all 0.2s; position: relative; }
    .calendar-day.available:hover { transform: scale(1.1); box-shadow: 0 4px 12px rgba(20, 184, 166, 0.3); }
    .calendar-day.available { background: #34d399; color: #1F2937; }
    .calendar-day.limited { background: #f59e0b; color: #1F2937; }
    .calendar-day.full { background: #ef4444; color: #F3F4F6; }
    .calendar-day.past { background: rgba(243, 244, 246, 0.1); color: #6B7280; cursor: not-allowed; }
    .calendar-header { display: grid; grid-template-columns: repeat(7, 1fr); gap: 8px; margin-bottom: 12px; text-align: center; font-size: 12px; font-weight: 600; color: #6B7280; }
    .modal { visibility: hidden; opacity: 0; position: fixed; top: 50%; left: 50%; transform: translate(-50%, -50%) scale(0.8); background: #2a374a; border: 1px solid #14B8A6; border-radius: 16px; padding: 20px; z-index: 1000; width: 90%; max-width: 400px; transition: all 0.3s; }
    .modal.active { visibility: visible; opacity: 1; transform: translate(-50%, -50%) scale(1); }
    .modal-overlay { visibility: hidden; opacity: 0; position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0, 0, 0, 0.7); backdrop-filter: blur(5px); z-index: 999; transition: all 0.3s; }
    .modal-overlay.active { visibility: visible; opacity: 1; }
    .modal h3 { margin: 0 0 10px; color: #14B8A6; font-size: 18px; text-align: center; }
    .modal .apply-form { display: flex; flex-direction: column; gap: 10px; }
    .modal .apply-form label { font-size: 13px; color: #9CA3AF; }
    .modal .apply-form input, .modal .apply-form select, .modal .apply-form textarea { padding: 8px; border: 1px solid #4B5563; border-radius: 5px; background: #374151; color: #F3F4F6; width: 100%; }
    .modal .apply-form button { padding: 10px; background: #14B8A6; color: #F3F4F6; border: none; border-radius: 5px; font-weight: 600; cursor: pointer; transition: background 0.3s; }
    .modal .apply-form button:disabled { background: #4B5563; cursor: not-allowed; }
    .modal .close-button { margin-top: 10px; padding: 10px; background: #4B5563; }
    .spinner { border: 3px solid rgba(20, 184, 166, 0.2); border-top: 3px solid #14B8A6; border-radius: 50%; width: 24px; height: 24px; animation: spin 1s linear infinite; margin: 12px auto; }
    @keyframes spin { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } }
  </style>
</head>
<body>
  <div id="tsparticles"></div>
  <div class="modal-overlay" id="modal-overlay"></div>
  <div class="menu-top">
    <div class="text-sm font-semibold">Красноярск, ул. Сакура, 12</div>
    <div class="flex items-center gap-2">
      <a href="#" class="text-teal-400 hover:text-orange-400"><i class="fab fa-telegram-plane"></i></a>
    </div>
  </div>
  <nav class="menu">
    <ul>
      <li class="menu-item active" data-section="booking">Запись на занятия</li>
    </ul>
  </nav>
  <main>
    <section id="booking" class="section active">
      <div class="card" data-aos="fade-up">
        <div class="flex items-center justify-between mb-4">
          <h3 class="text-lg font-semibold text-white" id="booking-calendar-title">Загрузка...</h3>
          <div class="flex space-x-2">
            <button class="prev-month p-2 rounded-full hover:bg-white/10"><i class="fas fa-chevron-left"></i></button>
            <button class="next-month p-2 rounded-full hover:bg-white/10"><i class="fas fa-chevron-right"></i></button>
          </div>
        </div>
        <div class="calendar-header"><div>Пн</div><div>Вт</div><div>Ср</div><div>Чт</div><div>Пт</div><div>Сб</div><div>Вс</div></div>
        <div class="calendar-grid" id="booking-calendar-grid"><div class="spinner"></div></div>
        <div class="flex flex-wrap gap-x-4 gap-y-2 mt-4 text-xs text-gray-400">
          <div class="flex items-center gap-2"><div class="w-3 h-3 rounded-full bg-emerald-500"></div><span>Свободно</span></div>
          <div class="flex items-center gap-2"><div class="w-3 h-3 rounded-full bg-amber-500"></div><span>Мало мест</span></div>
          <div class="flex items-center gap-2"><div class="w-3 h-3 rounded-full bg-red-500"></div><span>Мест нет</span></div>
        </div>
      </div>
    </section>
  </main>
  <div id="booking-modal" class="modal">
    <h3>Запись на занятие</h3>
    <p id="modal-date" class="text-gray-400 mb-4"></p>
    <form id="booking-form" class="apply-form" autocomplete="off">
      <input type="hidden" id="selected-date" name="selectedDate">
      <input type="hidden" id="username" name="username">
      <div class="full-form">
        <div><label for="child-name">Имя и фамилия ребенка</label><input type="text" id="child-name" name="childName" required></div>
        <div><label for="child-age">Возраст ребенка</label><input type="number" id="child-age" name="childAge" required></div>
        <div><label for="group-select">Выберите группу</label><select id="group-select" name="selectedGroup" required>
          <option value="Младшая (4-6 лет)">Младшая (4-6 лет)</option>
          <option value="Средняя (7-10 лет)">Средняя (7-10 лет)</option>
          <option value="Старшая (11-14 лет)">Старшая (11-14 лет)</option>
        </select></div>
        <div><label for="contact-info">Ваш контакт (Телефон/Telegram)</label><input type="text" id="contact-info" name="contactInfo" required></div>
        <div><label for="comments">Комментарии</label><textarea id="comments" name="comments" rows="2" placeholder="Например, есть ли у ребенка опыт..."></textarea></div>
      </div>
      <div class="simple-form" style="display: none;">
        <div><label for="child-name-simple">Имя и фамилия ребенка</label><input type="text" id="child-name-simple" name="childName" required></div>
        <div><label for="group-select-simple">Выберите группу</label><select id="group-select-simple" name="selectedGroup" required>
          <option value="Младшая (4-6 лет)">Младшая (4-6 лет)</option>
          <option value="Средняя (7-10 лет)">Средняя (7-10 лет)</option>
          <option value="Старшая (11-14 лет)">Старшая (11-14 лет)</option>
        </select></div>
      </div>
      <button type="submit" id="submit-booking">Записаться</button>
      <button type="button" class="close-button" id="close-modal-button">Отмена</button>
      <div id="modal-spinner" class="spinner" style="display: none;"></div>
    </form>
  </div>
  <script src="https://telegram.org/js/telegram-web-app.js" defer></script>
  <script src="https://cdn.jsdelivr.net/npm/tsparticles@2.12.0/tsparticles.bundle.min.js" defer></script>
  <script src="https://unpkg.com/aos@2.3.1/dist/aos.js" defer></script>
  <script>
    document.addEventListener('DOMContentLoaded', () => {
      console.log('Страница загружена, инициализация начата');
      // Замените на ваш URL Google Apps Script
      const WEB_APP_URL = 'https://script.google.com/macros/s/AKfycbysJxowCL4FiPooWHw4APxlGhO4CxAgb_9b8hU3HtNfGcYSgjD5_84sRp-xYpUHEmaUwg/exec';
      const tg = window.Telegram?.WebApp;
      if (tg) {
        console.log('Telegram Web App инициализирован', tg.initDataUnsafe);
        tg.expand();
      } else {
        console.warn('Telegram Web App не доступен');
      }
      const userData = (tg?.initDataUnsafe?.user) ? { id: tg.initDataUnsafe.user.id, username: tg.initDataUnsafe.user.username } : { id: 'N/A', username: 'N/A' };
      console.log('Данные пользователя:', userData);
      let currentDate = new Date();
      let bookingsData = {};
      const MAX_SPOTS = 3;
      const LIMITED_SPOTS = 1;

      AOS.init({ duration: 600, once: true, offset: 20 });
      if (typeof tsParticles !== 'undefined') {
        tsParticles.load("tsparticles", { particles: { number: { value: 30 }, color: { value: "#14B8A6" }, opacity: { value: 0.3 }, size: { value: 2 }, move: { enable: true, speed: 0.3 } } });
      } else {
        console.warn('tsParticles не загружен');
      }

      async function trackEvent(eventName, additionalData = {}) {
        console.log('Отправка события:', eventName, additionalData);
        const payload = { event: eventName, ...userData, timestamp: new Date().toISOString(), additional: additionalData };
        try {
          const response = await fetch(WEB_APP_URL, {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify(payload)
          });
          if (!response.ok) throw new Error(`HTTP error! status: ${response.status}`);
          const result = await response.json();
          if (result.status !== 'success') throw new Error(result.message || 'Неизвестная ошибка сервера');
          console.log('Событие успешно отправлено:', result);
          return result;
        } catch (error) {
          console.error('Ошибка при отправке события:', error);
          throw error;
        }
      }

      async function fetchBookings() {
        console.log('Загрузка данных о записях...');
        try {
          const response = await fetch(WEB_APP_URL);
          if (!response.ok) throw new Error(`HTTP error! status: ${response.status}`);
          const result = await response.json();
          if (result.status === 'success') {
            bookingsData = result.data;
            console.log('Данные о записях загружены:', bookingsData);
          } else {
            throw new Error(result.message || 'Неизвестная ошибка сервера');
          }
        } catch (error) {
          console.error('Не удалось загрузить записи:', error);
          alert('Ошибка: не удалось загрузить расписание. Проверьте соединение и попробуйте снова.');
        } finally {
          updateCalendar();
        }
      }

      async function checkUserExists(username) {
        console.log('Проверка существования пользователя:', username);
        try {
          const response = await fetch(WEB_APP_URL + '?action=checkUser&username=' + encodeURIComponent(username));
          if (!response.ok) throw new Error(`HTTP error! status: ${response.status}`);
          const result = await response.json();
          console.log('Результат проверки пользователя:', result);
          return result.exists;
        } catch (error) {
          console.error('Ошибка при проверке пользователя:', error);
          return false;
        }
      }

      const modal = document.getElementById('booking-modal');
      const modalOverlay = document.getElementById('modal-overlay');
      const bookingForm = document.getElementById('booking-form');
      const modalSpinner = document.getElementById('modal-spinner');
      const submitButton = document.getElementById('submit-booking');
      const fullForm = bookingForm.querySelector('.full-form');
      const simpleForm = bookingForm.querySelector('.simple-form');

      function updateCalendar() {
        console.log('Обновление календаря...');
        const grid = document.getElementById('booking-calendar-grid');
        const title = document.getElementById('booking-calendar-title');
        grid.innerHTML = '';
        const month = currentDate.getMonth();
        const year = currentDate.getFullYear();
        title.textContent = `${currentDate.toLocaleString('ru', { month: 'long' })} ${year}`;
        const firstDayOfMonth = new Date(year, month, 1);
        const daysInMonth = new Date(year, month + 1, 0).getDate();
        const startDayOfWeek = (firstDayOfMonth.getDay() + 6) % 7;

        for (let i = 0; i < startDayOfWeek; i++) grid.insertAdjacentHTML('beforeend', '<div></div>');

        for (let day = 1; day <= daysInMonth; day++) {
          const dayDate = new Date(year, month, day);
          const today = new Date();
          today.setHours(0, 0, 0, 0);
          const dayElement = document.createElement('div');
          dayElement.textContent = day;
          dayElement.classList.add('calendar-day');
          const dateString = dayDate.toLocaleDateString('ru');
          const spotsTaken = bookingsData[dateString] || 0;

          if (dayDate < today) {
            dayElement.classList.add('past');
          } else {
            if (spotsTaken >= MAX_SPOTS) {
              dayElement.classList.add('full');
            } else if (spotsTaken >= LIMITED_SPOTS) {
              dayElement.classList.add('limited');
            } else {
              dayElement.classList.add('available');
            }
            dayElement.addEventListener('click', () => openModal(dayDate));
          }
          grid.appendChild(dayElement);
        }
        console.log('Календарь обновлен');
      }

      async function openModal(date) {
        console.log('Открытие модального окна для даты:', date);
        document.getElementById('modal-date').textContent = `на ${date.toLocaleDateString('ru')}`;
        document.getElementById('selected-date').value = date.toLocaleDateString('ru');
        document.getElementById('username').value = userData.username || 'N/A';
        const isReturningUser = userData.username ? await checkUserExists(userData.username) : false;
        console.log('Пользователь возвращающийся:', isReturningUser);
        fullForm.style.display = isReturningUser ? 'none' : 'block';
        simpleForm.style.display = isReturningUser ? 'block' : 'none';
        modal.classList.add('active');
        modalOverlay.classList.add('active');
        submitButton.disabled = false;
        console.log('Кнопка "Записаться" активирована');
      }

      function closeModal() {
        console.log('Закрытие модального окна');
        modal.classList.remove('active');
        modalOverlay.classList.remove('active');
        bookingForm.reset();
        submitButton.disabled = false;
      }

      document.querySelector('.prev-month').addEventListener('click', () => {
        console.log('Переключение на предыдущий месяц');
        currentDate.setMonth(currentDate.getMonth() - 1);
        updateCalendar();
      });

      document.querySelector('.next-month').addEventListener('click', () => {
        console.log('Переключение на следующий месяц');
        currentDate.setMonth(currentDate.getMonth() + 1);
        updateCalendar();
      });

      document.getElementById('close-modal-button').addEventListener('click', closeModal);
      modalOverlay.addEventListener('click', closeModal);

      bookingForm.addEventListener('submit', async (e) => {
        e.preventDefault();
        console.log('Форма отправлена');
        if (!bookingForm.checkValidity()) {
          console.warn('Форма не прошла валидацию');
          alert('Пожалуйста, заполните все обязательные поля.');
          return;
        }
        modalSpinner.style.display = 'block';
        submitButton.disabled = true;
        const data = Object.fromEntries(new FormData(bookingForm).entries());
        console.log('Данные формы:', data);
        try {
          const result = await trackEvent('booking_request', data);
          console.log('Успешная отправка:', result);
          if (tg) {
            tg.showPopup({ title: 'Успешно!', message: 'Вы записаны! Мы скоро с вами свяжемся.' });
          } else {
            alert('Вы записаны! Мы скоро с вами свяжемся.');
          }
          closeModal();
          fetchBookings();
        } catch (error) {
          console.error('Ошибка при отправке формы:', error);
          if (tg) {
            tg.showPopup({ title: 'Ошибка', message: `Не удалось отправить заявку. ${error.message}` });
          } else {
            alert(`Не удалось отправить заявку. ${error.message}`);
          }
        } finally {
          modalSpinner.style.display = 'none';
          submitButton.disabled = false;
          console.log('Отправка формы завершена');
        }
      });

      console.log('Инициализация приложения...');
      fetchBookings();
      trackEvent('webapp_open');
    });
  </script>
</body>
</html>
