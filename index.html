<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no" />
    <title>Cenelle</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.15.4/css/all.min.css">
    <link href="https://unpkg.com/aos@2.3.1/dist/aos.css" rel="stylesheet">
    
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Montserrat:wght@400;500;600&family=Playfair+Display:wght@700&display=swap" rel="stylesheet">

    <style>
        :root { --dark-green: #1E2A25; --dark-green-light: #25352F; --antique-gold: #B89A6A; --terracotta: #A15E49; --cream: #FAF3EC; }
        body { font-family: 'Montserrat', sans-serif; margin:0; padding:0; background:var(--dark-green); color:var(--cream); -webkit-font-smoothing:antialiased; -moz-osx-font-smoothing:grayscale; }
        .header-elements { position: fixed; top: 0; left:0; right:0; height:64px; display:flex; align-items:center; justify-content:space-between; padding:8px 16px; z-index:100; background: linear-gradient(180deg, rgba(10,12,10,0.55), rgba(10,12,10,0.15)); backdrop-filter: blur(4px); border-bottom: 1px solid rgba(255,255,255,0.02); }
        .icon-btn { display:inline-flex; align-items:center; justify-content:center; width:40px; height:40px; border-radius:8px; background:transparent; color:var(--cream); cursor:pointer; border:1px solid rgba(255,255,255,0.02); }
        .header-title { font-family: 'Playfair Display', serif; font-size:20px; color:var(--antique-gold); letter-spacing:0.4px; }

        main { padding-top:88px; padding-bottom:48px; }

        .carousel { position:relative; height:220px; border-radius: 8px; overflow: hidden; max-width: 100%; }
        .carousel a { display: block; width: 100%; height: 100%; opacity: .5; transition: opacity .5s linear, transform .5s linear; transform: scale(1); }
        .carousel a.active { opacity: 1; z-index: 1; transform: scale(1.02); }
        .carousel img { width: 100%; height: 100%; object-fit: cover; display: block; }
        .carousel .hot { position: absolute; top: 8px; left: 16px; background: rgba(0,0,0,0.25); padding:6px 10px; border-radius: 999px; font-size: 14px; font-weight: 500; color: #ffffff; z-index: 2; }
        .carousel-dots { position: absolute; bottom: 8px; left: 50%; transform: translateX(-50%); display: flex; gap: 5px; z-index: 2; }
        .carousel-dots .dot { width: 8px; height: 8px; border-radius: 50%; background: rgba(255,255,255,0.2); cursor: pointer; transition: background .3s; }
        .carousel-dots .dot.active { background: var(--antique-gold); }

        #products-grid { margin-top: 12px; }

        .product-card { background: linear-gradient(180deg, rgba(255,255,255,0.02), rgba(255,255,255,0.01)); border-radius: 12px; padding: 12px; display:flex;flex-direction:column; gap: 8px; transition: transform .15s; border:1px solid rgba(184,154,106,0.06); }
        .product-card:hover { transform: translateY(-4px); }
        .product-image { width:100%; height:140px; border-radius:10px; overflow:hidden; background:#111; display:flex;align-items:center;justify-content:center; }
        .product-image img { width:100%; height:100%; object-fit:cover; }

        .order-card { background: var(--dark-green-light); border-radius: 8px; padding: 12px; border: 1px solid rgba(184,154,106,0.12); }
        .order-status { font-weight: 700; }

        .modal-backdrop, .modal-backdrop.visible { display:block; }
        #modal-backdrop { position: fixed; inset: 0; background: rgba(0,0,0,0.45); z-index: 140; display:none; }

        /* responsive */
        @media (min-width:768px){
            main { padding-left: 28px; padding-right: 28px; }
            .carousel { height:300px; }
        }
    </style>
</head>
<body class="relative">
    <div id="tsparticles"></div>

    <div id="modal-backdrop" class="modal-backdrop" aria-hidden="true"></div>

    <main class="pt-24 pb-20 px-4 max-w-7xl mx-auto relative">
        <div class="header-elements" id="top-bar">
             <div class="cart-edge">
                 <button id="cart-btn" class="icon-btn p-0 hover:bg-transparent rounded-md" aria-label="Корзина">
                     <svg class="w-6 h-6" style="width:18px;height:18px" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                         <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M3 3h2l.4 2M7 13h10l4-8H5.4M7 13L5.4 5M7 13l-2.293 2.293c-.63.63-.184 1.707.707 1.707H17m0 0a2 2 0 100 4 2 2 0 000-4zm-8 2a2 2 0 11-4 0 2 2 0 014 0z"/>
                     </svg>
                     <span id="cart-badge" class="absolute -top-1 -right-1 bg-pink-600 text-white text-xs rounded-full w-5 h-5 flex items-center justify-center hidden">0</span>
                 </button>
             </div>

             <div class="header-title">Cenelle</div>

             <div class="social-edge">
                 <div class="social-links flex items-center gap-3">
                     <a href="https://t.me/sweetworkshopp" target="_blank" class="icon-btn" data-social="telegram" title="Telegram">
                         <i class="fab fa-telegram-plane"></i>
                     </a>
                     <a href="https://www.instagram.com/thelimitedclub.cpa" target="_blank" class="icon-btn" data-social="instagram" title="Instagram">
                         <i class="fab fa-instagram"></i>
                     </a>
                     <!-- Кнопка Профиль -->
                     <button id="profile-btn" class="icon-btn" title="Профиль">
                         <i class="fas fa-user"></i>
                     </button>
                 </div>
             </div>
        </div>

        <div class="carousel" style="margin-bottom:14px;">
            <a href="#" class="active"><img src="https://i.postimg.cc/vBRkRQ2m/Group-7.png" alt="promo"></a>
            <a href="#"><img src="https://i.postimg.cc/wBN4QCxY/Group-8.png" alt="promo2"></a>
            <div class="hot">Хит</div>
            <div class="carousel-dots"><div class="dot active"></div><div class="dot"></div></div>
        </div>

        <div class="flex items-center justify-between my-5">
            <h2 class="text-xl font-bold">Товары</h2>
            <span id="products-count" class="text-sm">0 товаров</span>
        </div>
        <div id="products-grid" class="grid grid-cols-2 gap-4 md:grid-cols-3 lg:grid-cols-4 mb-10"></div>
    </main>

    <!-- PROFILE MODAL (вставлено) -->
    <div id="profile-modal" class="fixed inset-0 transform transition-transform duration-300" aria-hidden="true" style="display:none;">
        <div class="flex flex-col h-full">
            <div class="flex items-center justify-between p-4 border-b sticky top-0 bg-[#1E2A25]">
                <button id="profile-back-btn" aria-label="Назад">
                    <svg class="w-7 h-7" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 19l-7-7 7-7"/></svg>
                </button>
                <h2 class="text-xl font-bold">Профиль — Мои заказы</h2>
                <button id="profile-close-btn" class="" aria-label="Закрыть">
                    <svg class="w-7 h-7" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"/></svg>
                </button>
            </div>
            <div id="profile-content" class="flex-1 overflow-auto p-4 space-y-4">
                <div id="profile-info" class="p-3 order-card">
                    <div id="profile-name" class="font-semibold"></div>
                    <div id="profile-username" class="text-sm text-gray-400"></div>
                </div>

                <div id="orders-list" class="space-y-3">
                    <div class="text-sm text-gray-400">Загрузка заказов…</div>
                </div>
            </div>
        </div>
    </div>

    <script src="https://telegram.org/js/telegram-web-app.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/tsparticles@2.12.0/tsparticles.bundle.min.js"></script>
    <script src="https://unpkg.com/aos@2.3.1/dist/aos.js"></script>

<script>
/* === PROFILE MODULE (встроен в главный скрипт) === */
 // APPS_SCRIPT_WEB_APP_URL по умолчанию указывает на тот URL, который был в вашем исходном файле.
const APPS_SCRIPT_WEB_APP_URL = 'https://script.google.com/macros/s/AKfycbyAq2_5piTuUqFu4FxAc1I-3I31nS6SBFxbZVDDbkIPgKyqT3QdcdxjPX8QXIcgjnpS-g/exec';

(function(){
  // Elements that will be present in DOM (created above)
  function $(id){ return document.getElementById(id); }

  const elems = {};
  function refs() {
    elems.profileBtn = elems.profileBtn || $('profile-btn');
    elems.profileModal = elems.profileModal || $('profile-modal');
    elems.profileCloseBtn = elems.profileCloseBtn || $('profile-close-btn');
    elems.profileBackBtn = elems.profileBackBtn || $('profile-back-btn');
    elems.ordersList = elems.ordersList || $('orders-list');
    elems.profileName = elems.profileName || $('profile-name');
    elems.profileUsername = elems.profileUsername || $('profile-username');
    elems.modalBackdrop = elems.modalBackdrop || $('modal-backdrop');
    elems.cartBadge = elems.cartBadge || $('cart-badge');
    return elems;
  }

  document.addEventListener('DOMContentLoaded', function() {
    const e = refs();
    if (e.profileBtn) e.profileBtn.addEventListener('click', openProfile);
    if (e.profileCloseBtn) e.profileCloseBtn.addEventListener('click', closeProfile);
    if (e.profileBackBtn) e.profileBackBtn.addEventListener('click', closeProfile);
    if (e.modalBackdrop) e.modalBackdrop.addEventListener('click', ()=>{ if (e.profileModal && e.profileModal.style.display==='block') closeProfile(); });
  });

  function openProfile() {
    const tg = window.Telegram?.WebApp;
    const user = tg?.initDataUnsafe?.user || {};
    const e = refs();
    if (e.profileName) e.profileName.textContent = `${user.first_name || ''} ${user.last_name || ''}`.trim() || 'Гость';
    if (e.profileUsername) e.profileUsername.textContent = user.username ? `@${user.username}` : '';
    if (e.profileModal) e.profileModal.style.display = 'block';
    if (e.modalBackdrop) { e.modalBackdrop.classList.add('visible'); e.modalBackdrop.setAttribute('aria-hidden','false'); }

    const userId = user.id || null;
    if (!userId) {
      renderOrdersError('Не удалось определить пользователя (user.id отсутствует). Откройте приложение через Telegram.');
      return;
    }
    fetchOrdersForUser(userId);
  }

  function closeProfile(){
    const e = refs();
    if (e.profileModal) e.profileModal.style.display = 'none';
    if (e.modalBackdrop) { e.modalBackdrop.classList.remove('visible'); e.modalBackdrop.setAttribute('aria-hidden','true'); }
    if (e.ordersList) e.ordersList.innerHTML = '';
  }

  function renderOrdersError(message) {
    const e = refs();
    if (e.ordersList) e.ordersList.innerHTML = `<div class="text-sm text-red-400">${message}</div>`;
  }

  // JSONP helper
  function fetchJSONP(url, timeout = 8000) {
    return new Promise((resolve, reject)=>{
      const cbName = 'cb_' + Math.random().toString(36).slice(2,9);
      window[cbName] = function(data){ resolve(data); cleanup(); };
      function cleanup(){ try{ delete window[cbName]; }catch(e){}; const s = document.getElementById(cbName); if (s) s.remove(); clearTimeout(t); }
      const script = document.createElement('script');
      script.src = url + (url.indexOf('?')===-1 ? '?' : '&') + 'callback=' + cbName;
      script.id = cbName;
      script.onerror = ()=>{ reject(new Error('JSONP script error')); cleanup(); };
      document.body.appendChild(script);
      const t = setTimeout(()=>{ reject(new Error('JSONP timeout')); cleanup(); }, timeout);
    });
  }

  async function fetchOrdersForUser(userId){
    const e = refs();
    if (e.ordersList) e.ordersList.innerHTML = `<div class="text-sm text-gray-400">Загрузка заказов…</div>`;
    try {
      const url = `${APPS_SCRIPT_WEB_APP_URL}?action=get_user_orders&user_id=${encodeURIComponent(userId)}`;
      const data = await fetchJSONP(url);
      if (!data || data.status !== 'ok') {
        renderOrdersError('Ошибка при получении заказов — попробуйте позже.');
        return;
      }
      renderOrdersList(data.orders || []);
    } catch (err) {
      console.error('fetchOrdersForUser error', err);
      renderOrdersError('Не удалось загрузить заказы. Проверьте URL APPS_SCRIPT_WEB_APP_URL и доступность веб-приложения.');
    }
  }

  function renderOrdersList(orders) {
    const e = refs();
    if (!e.ordersList) return;
    if (!orders || orders.length === 0) { e.ordersList.innerHTML = `<div class="text-sm text-gray-400">У вас ещё нет заказов.</div>`; return; }
    e.ordersList.innerHTML = '';
    orders.sort((a,b)=> new Date(b.timestamp) - new Date(a.timestamp)).forEach(order => {
      const total = order.final_amount || order.total_amount || 0;
      const status = order.status || 'unknown';
      const orderEl = document.createElement('div');
      orderEl.className = 'order-card';
      orderEl.innerHTML = `
        <div class="flex items-start justify-between gap-3">
          <div>
            <div class="text-sm text-gray-300">Заказ <span class="font-semibold">${order.order_id}</span></div>
            <div class="text-xs text-gray-400 mt-1">${new Date(order.timestamp).toLocaleString()}</div>
            <div class="text-sm mt-2">Итого: <span class="font-semibold">${total} ₽</span></div>
            <div class="text-sm text-gray-400 mt-1">Дата: ${order.date || '—'} ${order.time || ''}</div>
          </div>
          <div class="text-right">
            <div class="order-status" style="color:${statusColor(status)}">${statusLabel(status)}</div>
            <button class="btn-view-order mt-3 px-3 py-1 rounded border" data-order-id="${order.order_id}">Подробнее</button>
          </div>
        </div>
      `;
      e.ordersList.appendChild(orderEl);
      orderEl.querySelector('.btn-view-order').addEventListener('click', ()=> showOrderDetail(order));
    });
  }

  function statusLabel(status){ const map = { pending: 'В ожидании', accepted: 'Принят', ready: 'Готов', cancelled: 'Отменён' }; return map[status] || status; }
  function statusColor(status){ if (status === 'ready') return '#6EE7B7'; if (status === 'accepted') return '#FBBF24'; if (status === 'pending') return '#F87171'; return '#D1D5DB'; }

  function showOrderDetail(order){
    const details = Array.isArray(order.order_details) ? order.order_details : (function(){ try{ return JSON.parse(order.order_details||'[]'); }catch(e){ return []; } })();
    const html = `
      <div class="p-4 space-y-2">
        <div class="text-sm">Заказ <strong>${order.order_id}</strong></div>
        <div class="text-xs text-gray-400">${new Date(order.timestamp).toLocaleString()}</div>
        <div class="mt-2"><strong>Состав:</strong></div>
        <div class="space-y-1 text-sm">${details.map(d=>`<div>• ${d.name} x${d.quantity} ${d.size?`(${d.size})`:''} ${d.filling?`— ${d.filling}`:''} — ${ (d.price||0)*(d.quantity||1)} ₽</div>`).join('')}</div>
        <div class="mt-2 text-sm">Итого: <strong>${order.final_amount || order.total_amount} ₽</strong></div>
        <div class="mt-2 text-sm">Статус: <strong>${statusLabel(order.status)}</strong></div>
        <div class="mt-2 text-sm">Телефон: ${order.phone || '-'}</div>
        <div class="mt-2"><button id="close-order-detail" class="btn-primary w-full h-10">Закрыть</button></div>
      </div>
    `;
    const overlay = document.createElement('div');
    overlay.className = 'fixed inset-0 z-200 p-4 flex items-end';
    overlay.style.background = 'linear-gradient(rgba(0,0,0,0.6), rgba(0,0,0,0.6))';
    overlay.innerHTML = `<div class="w-full max-w-lg mx-auto bg-[#1B2A26] rounded-t-2xl">${html}</div>`;
    document.body.appendChild(overlay);
    overlay.querySelector('#close-order-detail').addEventListener('click', ()=> overlay.remove());
    overlay.addEventListener('click', (e)=> { if (e.target===overlay) overlay.remove(); });
  }

})(); // profile module end

        // All your Javascript code remains unchanged.
        // I've copied it here exactly as you provided, with the particle animation added back.

        AOS.init({ duration: 800, once: true, offset: 100 });
        window.addEventListener('load', () => { AOS.refresh(); });
        
        // --- ADDED BACK AND RECONFIGURED PARTICLE ANIMATION ---
        if (typeof tsParticles !== 'undefined') {
            tsParticles.load("tsparticles", {
                fpsLimit: 60,
                particles: {
                    number: { value: 60, density: { enable: true, value_area: 800 } },
                    color: { value: "#B89A6A" }, // Gold color
                    shape: { type: "circle" },
                    opacity: { value: 0.4, random: true }, // Subtle opacity
                    size: { value: 1.5, random: { enable: true, minimumValue: 0.5 } },
                    move: { enable: true, speed: 0.3, random: true, outModes: { default: "out" } }
                },
                interactivity: { events: { onHover: { enable: false } } },
                detect_retina: true,
            });
        }

        if (window.Telegram?.WebApp) {
            window.Telegram.WebApp.ready();
            window.Telegram.WebApp.expand();
        }

        const appState = {
            cart: [], selectedProduct: null, selectedSize: 'S', selectedFilling: null, productImageIndex: 0, detailQuantity: 1
        };

        const products = [
             { id: '1', name: 'Бенто-торт', description: 'Компактный праздничный торт в бенто-стиле', images: ['https://i.postimg.cc/76t1WzY5/Layer-6.png'], price: 1400, sizes: [{name:'S', diameter: '9 см'},{name:'M', diameter:'12 см'}], fillings: ['Клубника','Шоколад'] },
             { id: '2', name: 'Набор макарун', description: 'Набор ярких макарун с несколькими вкусами', images: ['https://i.postimg.cc/4y0mZk2M/macaron.png'], price: 900, sizes: [{name:'S'},{name:'M'}], fillings: [] },
             { id: '3', name: 'Чизкейк мини', description: 'Нежный мини чизкейк, идеально для дегустации', images: ['https://i.postimg.cc/mg3Vd3G6/Layer-5.png'], price: 650, sizes: [{name:'S'}], fillings: ['Карамель','Черника'] },
             { id: '4', name: 'Праздничный торт 1кг', description: 'Классический белый торт для праздников', images: ['https://i.postimg.cc/Hn2vW4B9/Layer-3.png'], price: 3200, sizes: [{name:'M'},{name:'L'}], fillings: ['Шоколад','Ваниль'] },
             { id: '5', name: 'Трайфл банановый', description: 'Пасхальный трайфл с бананом и кремом', images: ['https://i.postimg.cc/0yWKtSDp/Layer-4.png'], price: 1200, sizes: [{name:'S'}], fillings: ['Банан','Шоколад'] },
             { id: '6', name: 'Капкейки 6 шт', description: 'Набор капкейков с различными топпингами', images: ['https://i.postimg.cc/9Q4QmD6p/cupcake.png'], price: 750, sizes: [{name:'S'}], fillings: ['Крем','Шоколад'] }
        ];

        // Рендер карусели точек
        (function initCarousel(){
            const dots = document.querySelectorAll('.carousel-dots .dot');
            const items = document.querySelectorAll('.carousel a');
            if (!items.length) return;
            items.forEach((it, idx) => {
                it.addEventListener('click', (e)=>{ e.preventDefault(); items.forEach(x=>x.classList.remove('active')); dots.forEach(d=>d.classList.remove('active')); it.classList.add('active'); dots[idx].classList.add('active'); });
            });
            dots.forEach((dot, idx)=> dot.addEventListener('click', ()=> { items.forEach(x=>x.classList.remove('active')); dots.forEach(d=>d.classList.remove('active')); items[idx].classList.add('active'); dot.classList.add('active'); }));
        })();

        function moneyFmt(n){ return (n||0) + ' ₽'; }

        // Рендер товаров
        function renderProducts() {
            const grid = document.getElementById('products-grid');
            const countEl = document.getElementById('products-count');
            if(!grid) return;
            grid.innerHTML = '';
            products.forEach(p => {
                const card = document.createElement('div');
                card.className = 'product-card';
                card.innerHTML = `
                    <div class="product-image">
                        <img src="${p.images && p.images[0] ? p.images[0] : 'https://i.postimg.cc/76t1WzY5/Layer-6.png'}" alt="${p.name}">
                    </div>
                    <div class="flex-1">
                        <div class="text-sm font-medium">${p.name}</div>
                        <div class="text-xs text-gray-400 mt-1">${p.description}</div>
                        <div class="flex items-center justify-between mt-3">
                            <div class="text-sm font-semibold">${moneyFmt(p.price)}</div>
                            <div>
                                <button class="add-to-cart-btn px-3 py-1 rounded" data-id="${p.id}">В корзину</button>
                            </div>
                        </div>
                    </div>
                `;
                grid.appendChild(card);
            });
            if(countEl) countEl.textContent = products.length + ' товаров';
            // add handlers
            document.querySelectorAll('.add-to-cart-btn').forEach(btn => {
                btn.addEventListener('click', (e)=> {
                    const id = btn.dataset.id;
                    const prod = products.find(x=>x.id===id);
                    if(prod) addToCart(prod, 1);
                });
            });
        }

        function addToCart(product, qty){
            const existing = appState.cart.find(x=>x.id===product.id);
            if(existing) existing.quantity += qty; else appState.cart.push({ ...product, quantity: qty });
            updateCartBadge();
            // небольшая анимация для пользовательского удовольствия
            const badge = document.getElementById('cart-badge');
            if(badge) { badge.classList.remove('hidden'); badge.textContent = appState.cart.reduce((s,i)=>s+i.quantity,0); badge.animate([{ transform:'scale(0.8)'},{ transform:'scale(1.15)'},{ transform:'scale(1)' }], { duration: 350 }); }
        }

        function updateCartBadge(){
            const badge = document.getElementById('cart-badge');
            if(!badge) return;
            const total = appState.cart.reduce((s,i)=>s+i.quantity,0);
            if(total>0){ badge.classList.remove('hidden'); badge.textContent = total; } else { badge.classList.add('hidden'); }
        }

        // Простая функция отправки заказа на Apps Script (fetch POST)
        function submitOrder(orderData) {
            // ВВАЖНО: заменить URL на ваш Apps Script URL, если надо
            const url = 'https://script.google.com/macros/s/AKfycbyAq2_5piTuUqFu4FxAc1I-3I31nS6SBFxbZVDDbkIPgKyqT3QdcdxjPX8QXIcgjnpS-g/exec';
            const payload = {
                event: 'order_submit',
                user_id: (window.Telegram?.WebApp?.initDataUnsafe?.user?.id) || 'unknown',
                username: (window.Telegram?.WebApp?.initDataUnsafe?.user?.username) || '',
                first_name: (window.Telegram?.WebApp?.initDataUnsafe?.user?.first_name) || '',
                last_name: (window.Telegram?.WebApp?.initDataUnsafe?.user?.last_name) || '',
                additional: orderData
            };
            try {
                fetch(url, { method: 'POST', headers: { 'Content-Type':'application/json' }, body: JSON.stringify(payload) })
                    .then(res => res.text()).then(t => { console.log('order submit response', t); alert('Заказ отправлен!'); appState.cart = []; updateCartBadge(); renderProducts(); })
                    .catch(err => { console.error('submitOrder error', err); alert('Ошибка отправки заказа.'); });
            } catch(e){ console.error(e); alert('Ошибка отправки заказа'); }
        }

        // Простая форма оформления — демонстрационная
        function openCheckoutDemo(){
            const date = prompt('Введите желаемую дату (например 2025-10-15):', '');
            if(!date) return;
            const time = prompt('Введите желаемое время (например 15:00):', '');
            const phone = prompt('Введите телефон для связи:', '');
            const address = prompt('Введите адрес (если нужна доставка) или оставьте пустым для самовывоза:', '');
            const orderId = 'ORD' + Math.random().toString(36).slice(2,9).toUpperCase();
            const details = appState.cart.map(i => ({ id:i.id, name:i.name, quantity:i.quantity, price:i.price, size:i.size||null, filling:i.filling||null }));
            const totalAmount = appState.cart.reduce((s,i)=> s + (i.price*(i.quantity||1)), 0);
            const totalObj = { order_id: orderId, order_details: details, total_amount: totalAmount, delivery_type: address? 'delivery' : 'pickup', delivery_fee: address? 250 : 0, final_amount: address? totalAmount+250 : totalAmount, date, time, address, phone };
            submitOrder(totalObj);
        }

        // quick demo: двойной клик по шапке откроет чек-аут (удобно для тестирования)
        document.addEventListener('dblclick', (e)=>{ if(e.target.closest('.header-title')) openCheckoutDemo(); });

        // Start
        document.addEventListener('DOMContentLoaded', ()=> {
            renderProducts();
            updateCartBadge();
        });
    </script>

</body>
</html>
