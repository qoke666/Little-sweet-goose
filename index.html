<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Little Sweet Goose</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.15.4/css/all.min.css">
    <link href="https://unpkg.com/aos@2.3.1/dist/aos.css" rel="stylesheet">
    <style>
        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
            overscroll-behavior: none;
            margin: 0;
            padding: 0;
            -webkit-tap-highlight-color: transparent;
            background-color: #f3f4f6;
            position: relative;
        }
        #tsparticles {
            position: fixed; top: 0; left: 0; width: 100%; height: 100%; z-index: -1;
        }
        .animate-zoom-in { animation: zoomIn 0.3s ease forwards; }
        .animate-fade-in { animation: fadeIn 0.3s ease forwards; }
        @keyframes zoomIn {
            from { transform: scale(0.8); opacity: 0; }
            to { transform: scale(1); opacity: 1; }
        }
        @keyframes fadeIn {
            from { opacity: 0; }
            to { opacity: 1; }
        }
        .carousel {
            display: flex; overflow-x: auto; white-space: nowrap; scroll-behavior: smooth;
            touch-action: pan-x; -webkit-overflow-scrolling: touch; scroll-snap-type: x mandatory;
            scrollbar-width: none; -ms-overflow-style: none; position: relative;
            width: 343px; height: 136px; margin: 8px auto; border-radius: 6px;
            overflow: hidden; background: #000; max-width: 100%;
        }
        .carousel::-webkit-scrollbar { display: none; }
        .carousel a {
            display: block; width: 100%; height: 100%; position: absolute; top: 0; left: 0;
            opacity: 0; transition: opacity .5s linear, transform .5s linear; transform: scale(1);
        }
        .carousel a.active { opacity: 1; z-index: 1; transform: scale(1.02); }
        .carousel img { width: 100%; height: 100%; object-fit: cover; display: block; }
        .carousel .hot {
            position: absolute; top: 8px; left: 16px; font-size: 20px; font-weight: 500;
            color: #ffffff; z-index: 2;
        }
        .carousel-dots {
            position: absolute; bottom: 8px; left: 50%; transform: translateX(-50%);
            display: flex; gap: 5px; z-index: 2;
        }
        .carousel-dots .dot {
            width: 5px; height: 5px; border-radius: 50%; background: rgba(255,255,255,0.3);
            cursor: pointer; transition: background .3s;
        }
        .carousel-dots .dot.active { background: #d5fd02; }
        .product-image-carousel {
            position: relative; width: 100%; height: 288px; display: flex;
            overflow-x: auto; scroll-snap-type: x mandatory; scroll-behavior: smooth;
            touch-action: pan-x; -webkit-overflow-scrolling: touch; scrollbar-width: none;
            -ms-overflow-style: none; border-radius: 12px; background: #e5e7eb; margin-bottom: 16px;
        }
        .product-image-carousel::-webkit-scrollbar { display: none; }
        .product-image-carousel img {
            width: 100%; height: 100%; object-fit: cover; flex-shrink: 0; scroll-snap-align: center;
        }
        .product-image-dots {
            position: absolute; bottom: 8px; left: 50%; transform: translateX(-50%);
            display: flex; gap: 5px; z-index: 2;
        }
        .product-image-dots .dot {
            width: 6px; height: 6px; border-radius: 50%; background: rgba(255,255,255,0.5);
            cursor: pointer; transition: background .3s;
        }
        .product-image-dots .dot.active { background: #ffffff; }
        .cart-modal, .product-detail { height: 100dvh; max-height: 100dvh; overflow-y: auto; }
        .input-field { width: 100%; box-sizing: border-box; transition: border-color 0.2s ease; }
        .input-field:focus { border-color: #db2777; outline: none; }
        .quantity-btn {
            display: flex; align-items: center; justify-content: center; width: 32px; height: 32px;
            border-radius: 50%; background: #f3f4f6; transition: background 0.2s;
        }
        .quantity-btn:hover { background: #e5e7eb; }
        .quantity-btn svg { width: 16px; height: 16px; }
        .discount-badge {
            position: absolute; top: 8px; left: 8px; background: #dc2626; color: white;
            padding: 4px 8px; border-radius: 12px; font-size: 10px; font-weight: bold;
        }
        .social-links a {
            display: inline-flex; align-items: center; justify-content: center;
            width: 36px; height: 36px; border-radius: 50%;
            transition: background-color 0.2s, transform 0.2s;
        }
        .social-links a:hover { background-color: #e5e7eb; transform: scale(1.1); }
        .social-links i { font-size: 22px; color: #4b5563; }
        .header-elements {
            position: fixed; top: 0; left: 0; right: 0; z-index: 40; padding: 16px;
            display: flex; align-items: center; justify-content: space-between;
            background: #fff; box-shadow: 0 2px 4px rgba(0,0,0,0.1);
        }
        .size-btn.active, .filling-btn.active { background-color: #fce7f3; border-color: #db2777; }
        .filling-image-container {
            aspect-ratio: 4/3; max-height: 96px; overflow: hidden;
            display: flex; justify-content: center;
        }
        .btn-primary {
            transition: all 0.2s ease; box-shadow: 0 2px 4px rgba(0, 0, 0, 0.1);
        }
        .btn-primary:hover:not(:disabled) {
            transform: translateY(-2px); box-shadow: 0 4px 8px rgba(0, 0, 0, 0.15);
        }
        .btn-primary:disabled {
            background-color: #f8b4d9; cursor: not-allowed;
        }
        /* === НОВЫЕ СТИЛИ ДЛЯ КРУГЛОЙ КНОПКИ "+" === */
        .add-to-cart-btn-plus {
            position: absolute;
            bottom: -16px; /* Немного выдвигаем вниз */
            right: 12px;
            width: 40px;
            height: 40px;
            background-color: #db2777;
            border-radius: 50%;
            color: white;
            display: flex;
            align-items: center;
            justify-content: center;
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.15);
            transition: all 0.2s ease-in-out;
            border: none;
            z-index: 10;
        }
        .add-to-cart-btn-plus:hover {
            transform: scale(1.1);
            background-color: #c41d68;
        }
        .add-to-cart-btn-plus svg {
            width: 24px;
            height: 24px;
        }
        /* === Улучшения для иконок в корзине === */
        .cart-item .quantity-btn {
            background-color: #f9fafb;
            border: 1px solid #e5e7eb;
        }
        .cart-item .quantity-btn:hover {
            background-color: #f3f4f6;
        }

        @media (min-width: 768px) {
            .product-card { transition: transform 0.2s ease; }
            .product-card:hover { transform: translateY(-4px); }
        }
    </style>
</head>
<body class="bg-gray-100 relative">
    <div id="tsparticles"></div>
    <main class="pt-24 pb-20 px-4 max-w-7xl mx-auto relative">
        <div class="header-elements">
            <div class="relative">
                <button id="cart-btn" class="p-2 hover:bg-gray-100 rounded-full">
                    <svg class="w-7 h-7" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M3 3h2l.4 2M7 13h10l4-8H5.4M7 13L5.4 5M7 13l-2.293 2.293c-.63.63-.184 1.707.707 1.707H17m0 0a2 2 0 100 4 2 2 0 000-4zm-8 2a2 2 0 11-4 0 2 2 0 014 0z"/>
                    </svg>
                    <span id="cart-badge" class="absolute -top-1 -right-1 bg-pink-600 text-white text-xs rounded-full w-5 h-5 flex items-center justify-center hidden">0</span>
                </button>
            </div>
            <h1 class="text-xl font-bold text-gray-800">Little Sweet Goose</h1>
            <div class="social-links flex items-center gap-3">
                <a href="https://t.me/limitedclubcpa" target="_blank" class="social-link tg-link" data-social="telegram">
                    <i class="fab fa-telegram-plane"></i>
                </a>
                <a href="https://www.instagram.com/thelimitedclub.cpa?igsh=MXkwcXppMWtlZGtm" target="_blank" class="social-link" data-social="instagram">
                    <i class="fab fa-instagram"></i>
                </a>
            </div>
        </div>

        <div class="carousel">
            <a href="https://telegra.ph/SCAM-kejs-ot-AMERIOBET-hronologiya-prufy-i-dolg-na-90-000-03-18" target="_blank" class="active">
                <img src="https://i.postimg.cc/bJqQWjv5/photo-2025-03-18-15-18-14.jpg" alt="скам" />
            </a>
            <a href="https://www.instagram.com/reel/DKHZPnYtjQD/?igsh=1234567890" target="_blank">
                <img src="https://i.postimg.cc/Z57qjBRv/feat-mac.jpg" alt="мак" />
            </a>
            <div class="hot"></div>
            <div class="carousel-dots">
                <div class="dot active"></div>
                <div class="dot"></div>
            </div>
        </div>

        <div class="flex items-center justify-between my-5">
            <h2 class="text-xl font-bold text-gray-800">Новинки</h2>
            <span id="new-products-count" class="text-sm text-gray-600">0 товаров</span>
        </div>
        <div id="new-products-grid" class="grid grid-cols-2 gap-x-4 gap-y-8 md:grid-cols-3 lg:grid-cols-4 mb-10"></div>

        <div class="flex items-center justify-between my-5">
            <h2 class="text-xl font-bold text-gray-800">Топ-позиции</h2>
            <span id="top-products-count" class="text-sm text-gray-600">0 товаров</span>
        </div>
        <div id="top-products-grid" class="grid grid-cols-2 gap-x-4 gap-y-8 md:grid-cols-3 lg:grid-cols-4 mb-10"></div>
    </main>

    <div id="cart-modal" class="fixed inset-0 bg-white z-50 transform translate-y-full transition-transform duration-300">
        <div class="flex flex-col h-full">
            <div class="flex items-center justify-between p-4 border-b bg-white shadow-sm sticky top-0">
                <button id="cart-back-btn">
                    <svg class="w-7 h-7" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 19l-7-7 7-7"/></svg>
                </button>
                <h2 class="text-xl font-bold text-gray-800">Корзина</h2>
                <button id="cart-close-btn">
                    <svg class="w-7 h-7" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"/></svg>
                </button>
            </div>
            <div id="cart-content" class="flex-grow flex flex-col"></div>
        </div>
    </div>

    <div id="product-detail" class="fixed inset-0 bg-white z-50 transform translate-y-full transition-transform duration-300">
        <div class="flex flex-col h-full">
            <div class="flex items-center justify-between p-4 border-b bg-white shadow-sm sticky top-0">
                <button id="detail-back-btn">
                    <svg class="w-7 h-7" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 19l-7-7 7-7"/></svg>
                </button>
                <h2 id="detail-title" class="text-xl font-bold text-gray-800"></h2>
                <button id="detail-close-btn">
                    <svg class="w-7 h-7" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"/></svg>
                </button>
            </div>
            <div id="detail-content" class="flex-1 overflow-auto p-4"></div>
        </div>
    </div>

    <script src="https://telegram.org/js/telegram-web-app.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/tsparticles@2.12.0/tsparticles.bundle.min.js"></script>
    <script src="https://unpkg.com/aos@2.3.1/dist/aos.js"></script>
    <script>
        AOS.init({ duration: 800, once: true, offset: 100 });
        window.addEventListener('load', () => { AOS.refresh(); });

        if (typeof tsParticles !== 'undefined') {
            tsParticles.load("tsparticles", {
                fpsLimit: 60,
                particles: {
                    number: { value: 150, density: { enable: true, value_area: 800 } },
                    color: { value: "#FF69B4" },
                    shape: { type: "circle" },
                    opacity: { value: 0.5, random: true },
                    size: { value: 2, random: { enable: true, minimumValue: 0.5 } },
                    move: {
                        enable: true, speed: 0.5, direction: "none",
                        random: true, outModes: { default: "out" }
                    }
                },
                interactivity: { events: { onHover: { enable: false } } },
                detect_retina: true
            });
        }

        if (window.Telegram?.WebApp) {
            window.Telegram.WebApp.ready();
            window.Telegram.WebApp.expand();
        }

        const appState = {
            cart: [], selectedProduct: null, selectedSize: 'S',
            selectedFilling: null, productImageIndex: 0
        };

        const products = [
             {
                id: '1', name: 'Бенто-торт', description: 'Компактный торт с индивидуальным дизайном, идеальный для одного-двух человек',
                price: 1400,
                sizes: [
                    { size: 'S', diameter: '10 см', weight: '450-550 г', price: 1400 },
                    { size: 'M', diameter: '12 см', weight: '850-950 г', price: 2250 },
                    { size: 'L', diameter: '14 см', weight: '1.2-1.3 кг', price: 2750 }
                ],
                fillings: [
                    { name: 'Маковый лимон с клубникой', image: 'https://i.postimg.cc/2S7kFCFG/image.webp' },
                    { name: 'Тропики манго-маракуйя', image: 'https://i.postimg.cc/nzCnJB8S/image.webp' },
                    { name: 'Пломбир малина-апельсин', image: 'https://i.postimg.cc/Kj6VCgFT/image.webp' },
                    { name: 'Медовик', image: 'https://i.postimg.cc/2S7kFCFG/image.webp' },
                    { name: 'Шоколадно-кофейный с крошкой Орео', image: 'https://i.postimg.cc/nzCnJB8S/image.webp' },
                    { name: 'Три шоколада', image: 'https://i.postimg.cc/2S7kFCFG/image.webp' },
                    { name: 'Морковный', image: 'https://i.postimg.cc/nzCnJB8S/image.webp' },
                    { name: 'Ореховый со сгущёнкой', image: 'https://i.postimg.cc/Kj6VCgFT/image.webp' }
                ],
                images: [
                    'https://i.postimg.cc/Wznctb7p/photo-2024-11-25-07-51-57.jpg', 'https://i.postimg.cc/MTjqdSmq/photo-2024-11-21-06-43-06.jpg',
                    'https://i.postimg.cc/7h3T2VwQ/photo-2024-12-09-17-53-44.jpg', 'https://i.postimg.cc/sfmjvqrC/photo-2024-12-09-18-02-26.jpg'
                ],
                cartImage: 'https://i.postimg.cc/Wznctb7p/photo-2024-11-25-07-51-57.jpg',
                category: 'bento', isNew: true, discount: 10, volume: '450 г',
                ingredients: ['Бисквит ванильный', 'Крем сливочный', 'Фрукты свежие', 'Сахарная мастика'],
                included: 'В стоимость входит покрытие любого цвета, транспортировочная красивая коробка, лента и свечка.',
                extra: 'Дизайн, ягоды, фотопечать, цветы оплачиваются отдельно.'
            },
            {
                id: '2', name: 'Моти', description: 'Нежные японские рисовые пирожные с начинкой',
                price: 100,
                images: ['https://i.postimg.cc/kXVgzs0r/photo-2024-11-25-07-59-12.jpg', 'https://i.postimg.cc/bwkNNJY3/photo-2024-11-25-07-59-11.jpg'],
                cartImage: 'https://i.postimg.cc/kXVgzs0r/photo-2024-11-25-07-59-12.jpg',
                category: 'mochi', isNew: false, volume: '1 шт',
                ingredients: ['Рисовая мука', 'Сливочная начинка', 'Фруктовое пюре']
            },
            {
                id: '3', name: 'Картошка', description: 'Классическое пирожное из бисквита и какао',
                price: 120,
                images: [
                    'https://i.postimg.cc/yxGYW3Sr/photo-2024-11-25-08-45-29.jpg', 'https://i.postimg.cc/ZYsqw2DF/photo-2024-11-25-08-45-29-2.jpg',
                    'https://i.postimg.cc/xTW12HQX/photo-2024-11-25-08-45-30.jpg', 'https://i.postimg.cc/XvWNZbp3/photo-2024-11-25-08-45-30-2.jpg'
                ],
                cartImage: 'https://i.postimg.cc/yxGYW3Sr/photo-2024-11-25-08-45-29.jpg',
                category: 'kartoshka', isNew: false, volume: '1 шт',
                ingredients: ['Бисквит шоколадный', 'Какао', 'Сгущенное молоко', 'Масло сливочное']
            },
            {
                id: '4', name: 'Трюфели', description: 'Шоколадные трюфели ручной работы с насыщенным вкусом',
                price: 150,
                images: [
                    'https://i.postimg.cc/qR9Z0t66/photo-2025-04-25-20-09-35.jpg', 'https://i.postimg.cc/xCkFWG8S/photo-2025-04-25-20-09-36.jpg',
                    'https://i.postimg.cc/tgvMSvX5/photo-2025-04-25-20-09-38.jpg'
                ],
                cartImage: 'https://i.postimg.cc/qR9Z0t66/photo-2025-04-25-20-09-35.jpg',
                category: 'truffles', isNew: true, discount: 5, volume: '100 г',
                ingredients: ['Темный шоколад', 'Сливки', 'Какао-порошок']
            }
        ];

        const elements = {
            cartBtn: document.getElementById('cart-btn'),
            cartBadge: document.getElementById('cart-badge'),
            promoCarousel: document.querySelector('.carousel'),
            newProductsGrid: document.getElementById('new-products-grid'),
            topProductsGrid: document.getElementById('top-products-grid'),
            newProductsCount: document.getElementById('new-products-count'),
            topProductsCount: document.getElementById('top-products-count'),
            cartModal: document.getElementById('cart-modal'),
            cartBackBtn: document.getElementById('cart-back-btn'),
            cartCloseBtn: document.getElementById('cart-close-btn'),
            cartContent: document.getElementById('cart-content'),
            productDetail: document.getElementById('product-detail'),
            detailBackBtn: document.getElementById('detail-back-btn'),
            detailCloseBtn: document.getElementById('detail-close-btn'),
            detailTitle: document.getElementById('detail-title'),
            detailContent: document.getElementById('detail-content')
        };

        function initEventListeners() {
            elements.cartBtn.addEventListener('click', openCart);
            elements.cartBackBtn.addEventListener('click', closeCart);
            elements.cartCloseBtn.addEventListener('click', closeCart);
            elements.detailBackBtn.addEventListener('click', closeProductDetail);
            elements.detailCloseBtn.addEventListener('click', closeProductDetail);
            startCarousel();
        }

        function startCarousel() {
            const slides = elements.promoCarousel.querySelectorAll('a');
            const dots = elements.promoCarousel.querySelectorAll('.dot');
            let currentIndex = 0;
            function showSlide(index) {
                slides.forEach((s, i) => s.classList.toggle('active', i === index));
                dots.forEach((d, i) => d.classList.toggle('active', i === index));
                currentIndex = index;
            }
            setInterval(() => showSlide((currentIndex + 1) % slides.length), 3000);
            showSlide(currentIndex);
        }
        
        // === ОБНОВЛЕННАЯ ФУНКЦИЯ ПРОКРУТКИ ФОТО ===
        function startProductImageCarousel() {
            const carousel = elements.detailContent.querySelector('.product-image-carousel');
            if (!carousel) return;
            const dotsContainer = elements.detailContent.querySelector('.product-image-dots');
            if (!dotsContainer) return;
            const dots = dotsContainer.querySelectorAll('.dot');
            let currentIndex = 0;

            function updateDots(index) {
                dots.forEach((dot, i) => dot.classList.toggle('active', i === index));
            }

            const handleScroll = debounce(() => {
                const index = Math.round(carousel.scrollLeft / carousel.offsetWidth);
                if (index !== currentIndex) {
                    currentIndex = index;
                    updateDots(currentIndex);
                }
            }, 50);

            carousel.addEventListener('scroll', handleScroll);

            dots.forEach((dot, i) => {
                dot.addEventListener('click', () => {
                    carousel.scrollTo({ left: i * carousel.offsetWidth, behavior: 'smooth' });
                });
            });
            updateDots(0);
        }

        function openCart() {
            elements.cartModal.style.transform = 'translateY(0)';
            renderCart();
        }

        function closeCart() {
            elements.cartModal.style.transform = 'translateY(100%)';
        }

        function addToCartById(productId, quantity = 1) {
            const product = products.find(p => p.id === productId);
            if (!product) return;
            
            appState.selectedSize = product.sizes ? appState.selectedSize || 'S' : null;
            appState.selectedFilling = product.fillings ? appState.selectedFilling || product.fillings[0].name : null;

            const existingItem = appState.cart.find(item =>
                item.id === product.id &&
                item.selectedSize === appState.selectedSize &&
                item.selectedFilling === appState.selectedFilling
            );

            if (existingItem) {
                existingItem.quantity += quantity;
            } else {
                appState.cart.push({
                    ...product, quantity,
                    selectedSize: appState.selectedSize,
                    selectedFilling: appState.selectedFilling
                });
            }
            localStorage.setItem('cart', JSON.stringify(appState.cart));
            updateCartBadge();
            showNotification(`${product.name} добавлен в корзину`, 'success');
        }

        function updateCartQuantity(productId, newQuantity, size, filling) {
            const item = appState.cart.find(i => i.id === productId && i.selectedSize == size && i.selectedFilling == (filling === 'null' ? null : filling));
            if (!item) return;
            if (newQuantity <= 0) {
                removeFromCart(productId, size, filling);
                return;
            }
            item.quantity = newQuantity;
            localStorage.setItem('cart', JSON.stringify(appState.cart));
            updateCartBadge();
            renderCart();
        }

        function removeFromCart(productId, size, filling) {
            appState.cart = appState.cart.filter(item =>
                !(item.id === productId && item.selectedSize == size && item.selectedFilling == (filling === 'null' ? null : filling))
            );
            localStorage.setItem('cart', JSON.stringify(appState.cart));
            updateCartBadge();
            renderCart();
        }

        function clearCart() {
            appState.cart = [];
            localStorage.setItem('cart', JSON.stringify(appState.cart));
            updateCartBadge();
            renderCart();
        }

        function updateCartBadge() {
            const totalItems = appState.cart.reduce((sum, item) => sum + item.quantity, 0);
            elements.cartBadge.textContent = totalItems;
            elements.cartBadge.classList.toggle('hidden', totalItems === 0);
        }

        function getMinOrderDate() {
            const today = new Date();
            today.setDate(today.getDate() + 1);
            return today.toISOString().split('T')[0];
        }
        
        // === ОБНОВЛЕННАЯ ФУНКЦИЯ RENDER CART С ЧЕКБОКСОМ ===
        function renderCart() {
            const cartContent = elements.cartContent;
            const hasBento = appState.cart.some(item => item.category === 'bento');
            
            if (appState.cart.length === 0) {
                cartContent.innerHTML = `<div class="flex-1 flex flex-col items-center justify-center text-center p-6">
                    <svg class="w-16 h-16 text-gray-300" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="1" d="M3 3h2l.4 2M7 13h10l4-8H5.4M7 13L5.4 5M7 13l-2.293 2.293c-.63.63-.184 1.707.707 1.707H17m0 0a2 2 0 100 4 2 2 0 000-4zm-8 2a2 2 0 11-4 0 2 2 0 014 0z"></path></svg>
                    <p class="mt-4 text-xl font-semibold text-gray-800">Корзина пуста</p>
                    <p class="text-sm text-gray-600">Добавьте вкусные десерты</p>
                </div>`;
                return;
            }

            const totalAmount = appState.cart.reduce((sum, item) => {
                const product = products.find(p => p.id === item.id);
                const size = product.sizes ? product.sizes.find(s => s.size === item.selectedSize) : null;
                return sum + (size ? size.price : item.price) * item.quantity;
            }, 0);

            cartContent.innerHTML = `
                <div class="flex-1 overflow-auto space-y-4 p-4">
                    ${appState.cart.map(item => {
                        const product = products.find(p => p.id === item.id);
                        const size = product.sizes ? product.sizes.find(s => s.size === item.selectedSize) : null;
                        const price = size ? size.price : item.price;
                        return `
                            <div class="cart-item flex gap-4 bg-white p-3 rounded-lg shadow-sm">
                                <img src="${item.cartImage || item.images[0]}" alt="${item.name}" class="w-20 h-20 object-cover rounded-md flex-shrink-0">
                                <div class="flex-1 min-w-0">
                                    <h4 class="font-semibold text-gray-800 truncate">${item.name}</h4>
                                    <p class="text-sm text-gray-500">${item.selectedSize ? `Размер: ${item.selectedSize}` : ''}${item.selectedFilling ? `, ${item.selectedFilling}` : ''}</p>
                                    <div class="flex items-center justify-between mt-2">
                                        <div class="flex items-center gap-2">
                                            <button class="quantity-btn" onclick="updateCartQuantity('${item.id}', ${item.quantity - 1}, '${item.selectedSize}', '${item.selectedFilling}')">-</button>
                                            <span class="w-8 text-center font-semibold">${item.quantity}</span>
                                            <button class="quantity-btn" onclick="updateCartQuantity('${item.id}', ${item.quantity + 1}, '${item.selectedSize}', '${item.selectedFilling}')">+</button>
                                        </div>
                                        <p class="font-bold text-pink-600">${price * item.quantity} ₽</p>
                                    </div>
                                </div>
                                <button onclick="removeFromCart('${item.id}', '${item.selectedSize}', '${item.selectedFilling}')" class="p-2 text-gray-400 hover:text-red-500 rounded-lg self-start">
                                    <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"></path></svg>
                                </button>
                            </div>`;
                    }).join('')}
                </div>
                
                <div class="border-t bg-white p-4 space-y-4 sticky bottom-0">
                    ${hasBento ? `
                    <div class="border-b pb-4">
                      <label class="flex items-center space-x-3 cursor-pointer">
                        <input type="checkbox" id="individual-design-checkbox" class="h-5 w-5 rounded border-gray-300 text-pink-600 focus:ring-pink-500">
                        <span class="text-gray-700 font-medium">Индивидуальный дизайн для бенто</span>
                      </label>
                      <p id="individual-design-notice" class="mt-2 text-sm text-red-600 hidden">
                        Стоимость рассчитывается отдельно менеджером.
                      </p>
                    </div>` : ''}

                    <h3 class="font-bold text-gray-800">Оформление заказа</h3>
                    <div class="grid grid-cols-2 gap-4">
                        <input type="date" class="input-field border rounded-lg p-3 text-sm w-full" min="${getMinOrderDate()}" required>
                        <input type="time" class="input-field border rounded-lg p-3 text-sm w-full" min="09:00" max="21:00" value="12:00" required>
                    </div>
                    <input type="tel" placeholder="+7 (___) ___-__-__" class="input-field border rounded-lg p-3 text-sm w-full" required>
                    
                    <div class="flex justify-between font-bold text-lg text-gray-800 pt-3 border-t">
                        <span>Итого:</span>
                        <span class="text-pink-600">${totalAmount} ₽</span>
                    </div>
                    
                    <button id="checkout-btn" class="btn-primary w-full h-12 bg-pink-600 text-white rounded-lg font-semibold flex items-center justify-center shadow-md">
                        Оформить заказ
                    </button>
                </div>
            `;

            if (hasBento) {
                const checkbox = document.getElementById('individual-design-checkbox');
                checkbox.addEventListener('change', () => {
                    document.getElementById('individual-design-notice').classList.toggle('hidden', !checkbox.checked);
                });
            }

            document.getElementById('checkout-btn').addEventListener('click', placeOrder);
        }

        function openProductDetailById(productId) {
            const product = products.find(p => p.id === productId);
            if (!product) return;
            appState.selectedProduct = product;
            appState.selectedSize = product.sizes ? 'S' : null;
            appState.selectedFilling = product.fillings ? product.fillings[0].name : null;
            appState.productImageIndex = 0;
            elements.detailTitle.textContent = product.name;
            elements.productDetail.style.transform = 'translateY(0)';
            renderProductDetail();
        }

        function closeProductDetail() {
            elements.productDetail.style.transform = 'translateY(100%)';
            detailQuantity = 1;
        }

        function selectSize(size) {
            appState.selectedSize = size;
            renderProductDetail();
        }

        function selectFilling(filling) {
            appState.selectedFilling = filling;
            renderProductDetail();
        }

        function renderProductDetail() {
            if (!appState.selectedProduct) return;
            const product = appState.selectedProduct;
            const size = product.sizes ? product.sizes.find(s => s.size === appState.selectedSize) : null;
            const price = size ? size.price : product.price;
            const discountedPrice = product.discount ? Math.round(price * (1 - product.discount / 100)) : price;

            elements.detailContent.innerHTML = `
                <div class="product-image-carousel">
                    ${product.images.map(img => `<img src="${img}" alt="${product.name}">`).join('')}
                    ${product.discount ? `<div class="discount-badge">Скидка -${product.discount}%</div>` : ''}
                    <div class="product-image-dots">
                        ${product.images.map((_, i) => `<div class="dot ${i === 0 ? 'active' : ''}"></div>`).join('')}
                    </div>
                </div>
                <div class="space-y-4">
                    <h1 class="text-2xl font-bold text-gray-800">${product.name}</h1>
                    ${product.sizes ? `<div class="space-y-2">
                        <h3 class="font-semibold text-gray-800">Размер</h3>
                        <div class="grid grid-cols-3 gap-3">
                            ${product.sizes.map(s => `
                                <button class="size-btn p-3 rounded-lg border text-left shadow-sm ${appState.selectedSize === s.size ? 'active' : 'hover:border-pink-300'}" onclick="selectSize('${s.size}')">
                                    <div class="font-semibold text-sm">${s.size} (${s.diameter})</div>
                                    <div class="text-xs text-gray-600">${s.weight} / ${s.price} ₽</div>
                                </button>
                            `).join('')}
                        </div>
                    </div>` : ''}
                     ${product.fillings ? `<div class="space-y-2">
                        <h3 class="font-semibold text-gray-800">Начинка</h3>
                        <div class="grid grid-cols-2 gap-3">
                            ${product.fillings.map(f => `
                                <button class="filling-btn p-3 rounded-lg border text-center shadow-sm ${appState.selectedFilling === f.name ? 'active' : 'hover:border-pink-300'}" onclick="selectFilling('${f.name}')">
                                    <div class="font-semibold text-sm">${f.name}</div>
                                </button>
                            `).join('')}
                        </div>
                        <div class="mt-2 filling-image-container">
                            <img src="${product.fillings.find(f => f.name === appState.selectedFilling).image}" alt="${appState.selectedFilling}" class="w-full h-full object-contain rounded-lg">
                        </div>
                    </div>` : ''}
                    <p class="text-gray-600">${product.description}</p>
                    <div class="space-y-3 pt-4 mt-auto">
                        <div class="flex items-center justify-center gap-4">
                            <button class="quantity-btn" onclick="changeDetailQuantity(-1)">-</button>
                            <span id="detail-quantity" class="font-semibold text-lg">1</span>
                            <button class="quantity-btn" onclick="changeDetailQuantity(1)">+</button>
                        </div>
                        <button onclick="addToCartFromDetail()" class="btn-primary w-full h-12 bg-pink-600 text-white rounded-lg font-semibold shadow-md">
                            Добавить за <span id="detail-total-price">${discountedPrice}</span> ₽
                        </button>
                    </div>
                </div>`;
            startProductImageCarousel();
        }

        function renderProducts() {
            const newProducts = products.filter(p => p.isNew);
            elements.newProductsCount.textContent = `${newProducts.length} товаров`;
            elements.newProductsGrid.innerHTML = newProducts.map(renderProductCard).join('');

            const topProducts = products.filter(p => !p.isNew); // Пример: остальные как топ
            elements.topProductsCount.textContent = `${topProducts.length} товаров`;
            elements.topProductsGrid.innerHTML = topProducts.map(renderProductCard).join('');
        }
        
        // === ОБНОВЛЕННАЯ КАРТОЧКА ТОВАРА С НОВОЙ КНОПКОЙ "+" ===
        function renderProductCard(product) {
            const price = product.sizes ? product.sizes.find(s => s.size === 'S').price : product.price;
            const discountedPrice = product.discount ? Math.round(price * (1 - product.discount / 100)) : price;
            return `
                <div class="product-card bg-white rounded-lg shadow-sm overflow-hidden flex flex-col">
                    <div class="relative h-40 bg-gray-200 cursor-pointer" onclick="openProductDetailById('${product.id}')">
                        <img src="${product.cartImage || product.images[0]}" alt="${product.name}" class="w-full h-full object-cover">
                        ${product.discount ? `<div class="discount-badge">-${product.discount}%</div>` : ''}
                    </div>
                    <div class="p-4 flex flex-col flex-grow relative">
                        <h3 class="font-semibold text-gray-800 truncate mb-1">${product.name}</h3>
                        <p class="text-sm text-gray-500 mb-2 flex-grow">${product.description}</p>
                        <div class="flex items-center justify-between mt-2">
                           ${product.discount ? `<div>
                                <span class="font-bold text-lg text-pink-600">${discountedPrice} ₽</span>
                                <span class="text-sm text-gray-500 line-through ml-2">${price} ₽</span>
                            </div>` : `<span class="font-bold text-lg text-pink-600">${price} ₽</span>`}
                        </div>
                        <button onclick="addToCartById('${product.id}'); event.stopPropagation();" class="add-to-cart-btn-plus">
                           <svg fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 6v6m0 0v6m0-6h6m-6 0H6"></path></svg>
                        </button>
                    </div>
                </div>`;
        }
        
        // === ОБНОВЛЕННАЯ ФУНКЦИЯ ОФОРМЛЕНИЯ ЗАКАЗА С ИЗМЕНЕНИЕМ КНОПКИ ===
        async function placeOrder() {
            const checkoutButton = document.getElementById('checkout-btn');
            const dateInput = document.querySelector('#cart-content input[type="date"]');
            const timeInput = document.querySelector('#cart-content input[type="time"]');
            const phoneInput = document.querySelector('#cart-content input[type="tel"]');

            if (!dateInput.value || !timeInput.value || !phoneInput.value) {
                showNotification('Заполните все поля для заказа', 'error');
                return;
            }
            
            // 1. Блокируем кнопку и меняем ее вид
            checkoutButton.disabled = true;
            checkoutButton.innerHTML = `<svg class="animate-spin -ml-1 mr-3 h-5 w-5 text-white" fill="none" viewBox="0 0 24 24"><circle class="opacity-25" cx="12" cy="12" r="10" stroke="currentColor" stroke-width="4"></circle><path class="opacity-75" fill="currentColor" d="M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4zm2 5.291A7.962 7.962 0 014 12H0c0 3.042 1.135 5.824 3 7.938l3-2.647z"></path></svg>Заказ формируется...`;

            try {
                // ... (здесь ваш код для сборки orderData и отправки fetch)
                const orderData = { /* ... */ }; // Соберите данные как в вашем оригинальном коде
                const response = await fetch('https://script.google.com/macros/s/AKfycbyAq2_5piTuUqFu4FxAc1I-3I31nS6SBFxbZVDDbkIPgKyqT3QdcdxjPX8QXIcgjnpS-g/exec', {
                    method: 'POST', body: JSON.stringify(orderData), mode: 'no-cors'
                });

                showNotification('Заказ успешно оформлен! Ожидайте подтверждения.', 'success');
                clearCart();
                closeCart();
            } catch (error) {
                console.error('Error sending order:', error);
                showNotification('Ошибка при отправке заказа', 'error');
                // 3. Возвращаем кнопку в исходное состояние в случае ошибки
                checkoutButton.disabled = false;
                checkoutButton.innerHTML = 'Оформить заказ';
            }
        }

        function showNotification(message, type = 'success') {
            const notification = document.createElement('div');
            notification.className = `fixed bottom-4 left-1/2 -translate-x-1/2 z-50 px-5 py-3 rounded-lg text-white font-semibold animate-zoom-in shadow-lg ${type === 'success' ? 'bg-green-500' : 'bg-red-500'}`;
            notification.textContent = message;
            document.body.appendChild(notification);
            setTimeout(() => notification.remove(), 3000);
        }

        function debounce(func, wait) {
            let timeout;
            return function executedFunction(...args) {
                const later = () => { clearTimeout(timeout); func(...args); };
                clearTimeout(timeout);
                timeout = setTimeout(later, wait);
            };
        }
        
        let detailQuantity = 1;
        function changeDetailQuantity(change) {
            detailQuantity = Math.max(1, detailQuantity + change);
            document.getElementById('detail-quantity').textContent = detailQuantity;
            if (appState.selectedProduct) {
                const size = appState.selectedProduct.sizes ? appState.selectedProduct.sizes.find(s => s.size === appState.selectedSize) : null;
                const price = size ? size.price : appState.selectedProduct.price;
                const discountedPrice = appState.selectedProduct.discount ? Math.round(price * (1 - appState.selectedProduct.discount / 100)) : price;
                document.getElementById('detail-total-price').textContent = discountedPrice * detailQuantity;
            }
        }

        function addToCartFromDetail() {
            if (appState.selectedProduct) {
                addToCartById(appState.selectedProduct.id, detailQuantity);
                closeProductDetail();
            }
        }
        
        function init() {
            const savedCart = localStorage.getItem('cart');
            if (savedCart) {
                try {
                    const parsedCart = JSON.parse(savedCart);
                    if (Array.isArray(parsedCart)) appState.cart = parsedCart;
                } catch (e) { console.error('Could not parse cart from localStorage'); }
            }
            initEventListeners();
            renderProducts();
            updateCartBadge();
        }

        document.addEventListener('DOMContentLoaded', init);
    </script>
</body>
</html>
