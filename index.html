<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no" />
    <title>Cenelle</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.15.4/css/all.min.css">
    <link href="https://unpkg.com/aos@2.3.1/dist/aos.css" rel="stylesheet">
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Montserrat:wght@400;500;600&family=Playfair+Display:wght@700&display=swap" rel="stylesheet">

    <style>
        :root {
            --dark-green: #1E2A25;
            --dark-green-light: #25352F;
            --antique-gold: #B89A6A;
            --terracotta: #A15E49;
            --cream: #FAF3EC;
            --font-headings: 'Playfair Display', serif;
            --font-body: 'Montserrat', sans-serif;
        }

        body {
            font-family: var(--font-body);
            overscroll-behavior: none;
            margin: 0;
            padding: 0;
            -webkit-tap-highlight-color: transparent;
            background-color: var(--dark-green);
            color: var(--cream);
            position: relative;
        }

        #tsparticles { position: fixed; top: 0; left: 0; width: 100%; height: 100%; z-index: -1; }

        .animate-zoom-in { animation: zoomIn 0.3s ease forwards; }
        .animate-fade-in { animation: fadeIn 0.3s ease forwards; }
        @keyframes zoomIn { from { transform: scale(0.8); opacity: 0; } to { transform: scale(1); opacity: 1; } }
        @keyframes fadeIn { from { opacity: 0; } to { opacity: 1; } }

        h1, h2, h3, h4, .header-title {
            font-family: var(--font-headings);
            color: var(--cream);
        }

        /* Промо-карусель */
        .carousel {
            display: flex; overflow-x: auto; white-space: nowrap; scroll-behavior: smooth;
            touch-action: pan-x; -webkit-overflow-scrolling: touch; scroll-snap-type: x mandatory;
            scrollbar-width: none; -ms-overflow-style: none; position: relative;
            width: 343px; height: 136px; margin: 12px auto; border-radius: 8px; overflow: hidden; max-width: 100%;
        }
        .carousel::-webkit-scrollbar { display: none; }
        .carousel a { display: block; width: 100%; height: 100%; position: absolute; top: 0; left: 0; opacity: 0; transition: opacity .5s linear; }
        .carousel a.active { opacity: 1; z-index: 1; }
        .carousel img { width: 100%; height: 100%; object-fit: cover; }
        .carousel-dots { position: absolute; bottom: 8px; left: 50%; transform: translateX(-50%); display: flex; gap: 5px; z-index: 2; }
        .carousel-dots .dot { width: 5px; height: 5px; border-radius: 50%; background: rgba(255,255,255,0.2); transition: background .3s; }
        .carousel-dots .dot.active { background: var(--antique-gold); }

        /* Шапка — фиксированная, без лишних отступов */
        .header-elements {
            position: fixed;
            top: 0; left: 0; right: 0;
            height: 68px;
            background: var(--dark-green);
            z-index: 130;
            display: flex;
            align-items: center;
            justify-content: space-between;
            padding: 0 16px;
            transition: transform 0.28s cubic-bezier(0.4, 0, 0.2, 1);
            border-bottom: 1px solid rgba(184, 154, 106, 0.15);
        }
        .header-elements.header-hidden { transform: translateY(-100%); }
        .header-title { font-size: 24px; font-weight: 700; color: var(--cream); }
        .icon-btn {
            width: 44px; height: 44px;
            display: flex; align-items: center; justify-content: center;
            border-radius: 8px; background: transparent; color: var(--antique-gold);
            transition: all 0.2s ease;
        }
        .icon-btn:hover { background: rgba(184, 154, 106, 0.15); transform: scale(1.08); }
        #cart-badge {
            position: absolute; top: -4px; right: -4px;
            background: var(--terracotta); color: white; font-size: 10px;
            width: 18px; height: 18px; border-radius: 50%;
            display: flex; align-items: center; justify-content: center; font-weight: bold;
        }

        main { padding-top: 80px; padding-bottom: 20px; }

        .product-card {
            background-color: var(--dark-green-light);
            border-radius: 8px;
            border: 1px solid rgba(184, 154, 106, 0.2);
            transition: all 0.25s ease;
            overflow: hidden;
        }
        .product-card:hover {
            transform: translateY(-6px);
            border-color: rgba(184, 154, 106, 0.5);
            box-shadow: 0 12px 30px rgba(0,0,0,0.25);
        }
        .add-to-cart-btn {
            position: absolute; bottom: 12px; right: 12px;
            width: 42px; height: 42px;
            background: rgba(184, 154, 106, 0.12);
            border-radius: 50%;
            display: flex; align-items: center; justify-content: center;
            transition: all 0.2s ease;
            z-index: 10;
            backdrop-filter: blur(4px);
        }
        .add-to-cart-btn:hover { background: var(--antique-gold); transform: scale(1.15); }
        .add-to-cart-btn svg { width: 22px; height: 22px; stroke: var(--terracotta); transition: stroke 0.2s; }
        .add-to-cart-btn:hover svg { stroke: white; }

        .modal-backdrop {
            position: fixed; inset: 0; background: rgba(0,0,0,0.5); backdrop-filter: blur(6px);
            z-index: 90; opacity: 0; pointer-events: none; transition: opacity .25s ease;
        }
        .modal-backdrop.visible { opacity: 1; pointer-events: auto; }

        #cart-modal, #product-detail {
            position: fixed; inset: 0; background: var(--dark-green);
            transform: translateY(100%); transition: transform .32s cubic-bezier(0.4, 0, 0.2, 1);
            z-index: 100;
        }
        #cart-modal.open, #product-detail.open { transform: translateY(0); }

        #checkout-modal {
            position: fixed; bottom: 0; left: 0; right: 0;
            background: var(--dark-green);
            border-top: 1px solid rgba(184, 154, 106, 0.3);
            border-top-left-radius: 16px; border-top-right-radius: 16px;
            z-index: 102; transform: translateY(100%);
            transition: transform .32s cubic-bezier(0.4, 0, 0.2, 1);
            max-height: 90vh; overflow: auto;
        }
        #checkout-modal.open { transform: translateY(0); }

        .btn-primary {
            background: var(--terracotta); color: white;
            border-radius: 8px; height: 48px; font-weight: 600;
            transition: all 0.2s;
        }
        .btn-primary:hover:not(:disabled) { background: #8a4e3c; transform: translateY(-2px); }

        .fly-img {
            position: fixed; pointer-events: none; z-index: 2200;
            border-radius: 12px; box-shadow: 0 10px 30px rgba(0,0,0,0.3);
            transition: transform 0.8s cubic-bezier(0.2, 0.8, 0.3, 1), opacity 0.6s ease;
        }
    </style>
</head>
<body class="relative">
    <div id="tsparticles"></div>
    <div id="modal-backdrop" class="modal-backdrop" aria-hidden="true"></div>

    <!-- Шапка -->
    <div class="header-elements" id="top-bar">
        <button id="cart-btn" class="icon-btn relative" aria-label="Корзина">
            <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M3 3h2l.4 2M7 13h10l4-8H5.4M7 13L5.4 5M7 13l-2.293 2.293c-.63.63-.184 1.707.707 1.707H17m0 0a2 2 0 100 4 2 2 0 000-4zm-8 2a2 2 0 11-4 0 2 2 0 014 0z"/>
            </svg>
            <span id="cart-badge" class="hidden">0</span>
        </button>

        <div class="header-title">Cenelle</div>

        <div class="flex items-center gap-3">
            <a href="https://t.me/sweetworkshopp" target="_blank" class="icon-btn" title="Telegram">
                <i class="fab fa-telegram-plane"></i>
            </a>
            <a href="https://www.instagram.com/thelimitedclub.cpa" target="_blank" class="icon-btn" title="Instagram">
                <i class="fab fa-instagram"></i>
            </a>
        </div>
    </div>

    <main class="px-4 max-w-7xl mx-auto">
        <div class="carousel mt-2">
            <a href="#" class="active"><img src="https://i.postimg.cc/vBRkRQ2m/Group-7.png" alt="promo"></a>
            <a href="#"><img src="https://i.postimg.cc/wBN4QCxY/Group-8.png" alt="promo2"></a>
            <div class="carousel-dots"><div class="dot active"></div><div class="dot"></div></div>
        </div>

        <div class="flex items-center justify-between my-5">
            <h2 class="text-xl font-bold">Товары</h2>
            <span id="products-count" class="text-sm opacity-70">0 товаров</span>
        </div>
        <div id="products-grid" class="grid grid-cols-2 gap-4 mb-10"></div>
    </main>

    <!-- Корзина -->
    <div id="cart-modal" aria-hidden="true">
        <div class="flex flex-col h-full">
            <div class="flex items-center justify-between p-4 border-b sticky top-0 bg-var(--dark-green)">
                <button id="cart-back-btn" aria-label="Назад">
                    <svg class="w-7 h-7" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 19l-7-7 7-7"/></svg>
                </button>
                <h2 class="text-xl font-bold">Корзина</h2>
                <button id="cart-close-btn" aria-label="Закрыть">
                    <svg class="w-7 h-7" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"/></svg>
                </button>
            </div>
            <div id="cart-content" class="flex-grow"></div>
        </div>
    </div>

    <!-- Детали товара -->
    <div id="product-detail" aria-hidden="true">
        <div class="flex flex-col h-full">
            <div class="flex items-center justify-between p-4 border-b sticky top-0 bg-var(--dark-green)">
                <button id="detail-back-btn" aria-label="Назад">
                    <svg class="w-7 h-7" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 19l-7-7 7-7"/></svg>
                </button>
                <h2 id="detail-title" class="text-xl font-bold"></h2>
                <button id="detail-close-btn" aria-label="Закрыть">
                    <svg class="w-7 h-7" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"/></svg>
                </button>
            </div>
            <div id="detail-content" class="flex-1 overflow-auto p-4"></div>
        </div>
    </div>

    <!-- Оформление заказа -->
    <div id="checkout-modal" aria-hidden="true">
        <div class="p-4 border-b flex items-start gap-3">
            <div class="flex-1">
                <h3 class="text-lg font-bold">Оформление заказа</h3>
                <p class="text-sm">Самовывоз: <strong>Алексеева 43</strong></p>
            </div>
            <button id="checkout-close" class="text-gray-500" aria-label="Закрыть">
                <svg class="w-6 h-6" viewBox="0 0 24 24" fill="none" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"/></svg>
            </button>
        </div>
        <div class="p-4 space-y-4">
            <div class="grid grid-cols-1 gap-3">
                <label class="text-sm font-semibold">Дата самовывоза</label>
                <input id="checkout-date" type="date" class="input-field p-3 text-sm w-full" required>
                <label class="text-sm font-semibold">Время</label>
                <input id="checkout-time" type="time" class="input-field p-3 text-sm w-full" min="09:00" max="21:00" required>
                <label class="text-sm font-semibold">Телефон для связи</label>
                <input id="checkout-phone" type="tel" placeholder="+7 (999) 123-45-67" class="input-field p-3 text-sm w-full" required>
            </div>

            <div class="flex items-center justify-between font-bold text-base pt-3 border-t" style="border-color: rgba(184, 154, 106, 0.2);">
                <span>Итого</span><span id="checkout-total">0 ₽</span>
            </div>

            <div class="space-y-2">
                <button id="place-order-btn" class="btn-primary w-full text-base font-semibold flex items-center justify-center gap-2">Оформить заказ</button>
                <button id="checkout-back-btn" class="w-full h-12 text-base">Вернуться к корзине</button>
            </div>
        </div>
    </div>

    <script src="https://telegram.org/js/telegram-web-app.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/tsparticles@2.12.0/tsparticles.bundle.min.js"></script>
    <script>
        tsParticles.load("tsparticles", {
            fpsLimit: 60,
            particles: {
                number: { value: 60, density: { enable: true, value_area: 800 } },
                color: { value: "#B89A6A" },
                shape: { type: "circle" },
                opacity: { value: 0.4, random: true },
                size: { value: 1.5, random: { enable: true, minimumValue: 0.5 } },
                move: { enable: true, speed: 0.3, direction: "none", random: true, outModes: { default: "out" } }
            },
            detect_retina: true
        });

        if (window.Telegram?.WebApp) {
            window.Telegram.WebApp.ready();
            window.Telegram.WebApp.expand();
        }

        const appState = {
            cart: [], selectedProduct: null, selectedSize: 'S', selectedFilling: null,
            productImageIndex: 0, detailQuantity: 1, usePoints: false
        };

        const products = [
            { id: '1', name: 'Бенто-торт', description: 'Компактный торт с индивидуальным дизайном, идеальный для одного-двух человек', price: 1400, sizes: [{ size: 'S', diameter: '10 см', weight: '450-550 г', price: 1400 },{ size: 'M', diameter: '12 см', weight: '850-950 г', price: 2250 },{ size: 'L', diameter: '14 см', weight: '1.2-1.3 кг', price: 2750 }], fillings: [{ name: 'Маковый лимон с клубникой', image: 'https://i.postimg.cc/2S7kFCFG/image.webp' },{ name: 'Тропики манго-маракуйя', image: 'https://i.postimg.cc/nzCnJB8S/image.webp' },{ name: 'Пломбир малина-апельсин', image: 'https://i.postimg.cc/Kj6VCgFT/image.webp' },{ name: 'Медовик', image: 'https://i.postimg.cc/2S7kFCFG/image.webp' },{ name: 'Шоколадно-кофейный с крошкой Орео', image: 'https://i.postimg.cc/nzCnJB8S/image.webp' },{ name: 'Три шоколада', image: 'https://i.postimg.cc/2S7kFCFG/image.webp' },{ name: 'Морковный', image: 'https://i.postimg.cc/nzCnJB8S/image.webp' },{ name: 'Ореховый со сгущёнкой', image: 'https://i.postimg.cc/Kj6VCgFT/image.webp' }], images: ['https://i.postimg.cc/Wznctb7p/photo-2024-11-25-07-51-57.jpg', 'https://i.postimg.cc/MTjqdSmq/photo-2024-11-21-06-43-06.jpg', 'https://i.postimg.cc/7h3T2VwQ/photo-2024-12-09-17-53-44.jpg', 'https://i.postimg.cc/sfmjvqrC/photo-2024-12-09-18-02-26.jpg'], cartImage: 'https://i.postimg.cc/Wznctb7p/photo-2024-11-25-07-51-57.jpg', category: 'bento', isHot: true, volume: '450 г', ingredients: ['Бисквит ванильный', 'Крем сливочный', 'Фрукты свежие', 'Сахарная мастика'], included: 'В стоимость входит покрытие любого цвета, транспортировочная красивая коробка, лента и свечка.', extra: 'Дизайн, ягоды, фотопечать, цветы оплачиваются отдельно.' },
            { id: '2', name: 'Моти', description: 'Нежные японские рисовые пирожные с начинкой', price: 100, fillings: [ { name: 'смородина', image: 'https://i.postimg.cc/kXVgzs0r/photo-2024-11-25-07-59-12.jpg' }, { name: 'банан', image: 'https://i.postimg.cc/bwkNNJY3/photo-2024-11-25-07-59-11.jpg' }, { name: 'апельсиновый мокко', image: 'https://i.postimg.cc/Kj6VCgFT/image.webp' }, { name: 'баунти', image: 'https://i.postimg.cc/nzCnJB8S/image.webp' }, { name: 'медовик', image: 'https://i.postimg.cc/2S7kFCFG/image.webp' } ], images: ['https://i.postimg.cc/kXVgzs0r/photo-2024-11-25-07-59-12.jpg', 'https://i.postimg.cc/bwkNNJY3/photo-2024-11-25-07-59-11.jpg'], cartImage: 'https://i.postimg.cc/kXVgzs0r/photo-2024-11-25-07-59-12.jpg', category: 'mochi', isHot: true, volume: '1 шт', ingredients: ['Рисовая мука', 'Сливочная начинка', 'Фруктовое пюре'] },
            { id: '3', name: 'Картошка', description: 'Классическое пирожное из бисквита и какао', price: 120, images: ['https://i.postimg.cc/yxGYW3Sr/photo-2024-11-25-08-45-29.jpg', 'https://i.postimg.cc/ZYsqw2DF/photo-2024-11-25-08-45-29-2.jpg', 'https://i.postimg.cc/xTW12HQX/photo-2024-11-25-08-45-30.jpg', 'https://i.postimg.cc/XvWNZbp3/photo-2024-11-25-08-45-30-2.jpg'], cartImage: 'https://i.postimg.cc/yxGYW3Sr/photo-2024-11-25-08-45-29.jpg', category: 'kartoshka', isHot: true, volume: '1 шт', ingredients: ['Бисквит шоколадный', 'Какао', 'Сгущенное молоко', 'Масло сливочное'] },
            { id: '4', name: 'Трюфели', description: 'Шоколадные трюфели ручной работы с насыщенным вкусом', price: 150, fillings: [ { name: 'Апельсиновый', image: 'https://i.postimg.cc/qR9Z0t66/photo-2025-04-25-20-09-35.jpg' }, { name: 'Лимонный', image: 'https://i.postimg.cc/xCkFWG8S/photo-2025-04-25-20-09-36.jpg' }, { name: 'Фисташковый', image: 'https://i.postimg.cc/tgvMSvX5/photo-2025-04-25-20-09-38.jpg' }, { name: 'малиновый', image: 'https://i.postimg.cc/7h3T2VwQ/photo-2024-12-09-17-53-44.jpg' }, { name: 'Ореховый', image: 'https://i.postimg.cc/Kj6VCgFT/image.webp' } ], images: ['https://i.postimg.cc/qR9Z0t66/photo-2025-04-25-20-09-35.jpg', 'https://i.postimg.cc/xCkFWG8S/photo-2025-04-25-20-09-36.jpg', 'https://i.postimg.cc/tgvMSvX5/photo-2025-04-25-20-09-38.jpg'], cartImage: 'https://i.postimg.cc/qR9Z0t66/photo-2025-04-25-20-09-35.jpg', category: 'truffles', isHot: false, volume: '100 г', ingredients: ['Темный шоколад', 'Сливки', 'Какао-порошок'] },
            { id: '5', name: 'Мадлен', description: 'Нежные французские бисквитные печенья в форме ракушек', price: 80, fillings: [ { name: 'Красный бархат с малиной', image: 'https://i.postimg.cc/4yq0XsBy/photo-2024-12-09-18-40-29.jpg' }, { name: 'Шоколад-кофе-апельсин', image: 'https://via.placeholder.com/300?text=Choco+Coffee+Orange' }, { name: 'Фисташка-малина', image: 'https://via.placeholder.com/300?text=Pistachio+Raspberry' }, { name: 'Маковый лимон', image: 'https://via.placeholder.com/300?text=Poppy+Lemon' } ], images: ['https://via.placeholder.com/150?text=Madeleine1', 'https://via.placeholder.com/150?text=Madeleine2'], cartImage: 'https://i.postimg.cc/4yq0XsBy/photo-2024-12-09-18-40-29.jpg', category: 'madeleine', isHot: false, volume: '1 шт', ingredients: ['Пшеничная мука', 'Сливочное масло', 'Яйца', 'Сахар', 'Лимонная цедра'] }
        ];

        const elements = {
            header: document.getElementById('top-bar'),
            cartBtn: document.getElementById('cart-btn'),
            cartBadge: document.getElementById('cart-badge'),
            promoCarousel: document.querySelector('.carousel'),
            productsGrid: document.getElementById('products-grid'),
            productsCount: document.getElementById('products-count'),
            cartModal: document.getElementById('cart-modal'),
            cartBackBtn: document.getElementById('cart-back-btn'),
            cartCloseBtn: document.getElementById('cart-close-btn'),
            cartContent: document.getElementById('cart-content'),
            productDetail: document.getElementById('product-detail'),
            detailBackBtn: document.getElementById('detail-back-btn'),
            detailCloseBtn: document.getElementById('detail-close-btn'),
            detailTitle: document.getElementById('detail-title'),
            detailContent: document.getElementById('detail-content'),
            checkoutModal: document.getElementById('checkout-modal'),
            checkoutClose: document.getElementById('checkout-close'),
            checkoutBackBtn: document.getElementById('checkout-back-btn'),
            placeOrderBtn: document.getElementById('place-order-btn'),
            checkoutTotal: document.getElementById('checkout-total'),
            checkoutDate: document.getElementById('checkout-date'),
            checkoutTime: document.getElementById('checkout-time'),
            checkoutPhone: document.getElementById('checkout-phone'),
            modalBackdrop: document.getElementById('modal-backdrop')
        };

        const modalState = { cart: false, detail: false, checkout: false };

        function updateHeaderVisibility() {
            const anyOpen = modalState.cart || modalState.detail || modalState.checkout;
            elements.header.classList.toggle('header-hidden', anyOpen);
            elements.modalBackdrop.classList.toggle('visible', anyOpen);
        }

        // Плавное скрытие шапки без дребезга
        let lastScrollTop = 0;
        window.addEventListener('scroll', () => {
            const st = window.pageYOffset || document.documentElement.scrollTop;
            if (modalState.cart || modalState.detail || modalState.checkout) {
                elements.header.classList.add('header-hidden');
                lastScrollTop = st;
                return;
            }
            if (st > lastScrollTop && st > 100) {
                elements.header.classList.add('header-hidden');
            } else if (st < lastScrollTop || st <= 60) {
                elements.header.classList.remove('header-hidden');
            }
            lastScrollTop = st <= 0 ? 0 : st;
        }, { passive: true });

        // Открытие/закрытие модалок
        function openCart() { modalState.cart = true; elements.cartModal.classList.add('open'); updateHeaderVisibility(); renderCart(); }
        function closeCart() { modalState.cart = false; elements.cartModal.classList.remove('open'); setTimeout(updateHeaderVisibility, 50); }
        function openProductDetailById(id) {
            const p = products.find(x => x.id === id);
            if (!p) return;
            appState.selectedProduct = p;
            appState.selectedSize = p.sizes ? 'S' : null;
            appState.selectedFilling = p.fillings ? p.fillings[0].name : null;
            appState.detailQuantity = 1;
            elements.detailTitle.textContent = p.name;
            modalState.detail = true;
            elements.productDetail.classList.add('open');
            updateHeaderVisibility();
            renderProductDetail();
        }
        function closeProductDetail() { modalState.detail = false; elements.productDetail.classList.remove('open'); setTimeout(updateHeaderVisibility, 50); }
        function openCheckout() {
            modalState.checkout = true;
            elements.checkoutDate.min = new Date(Date.now() + 86400000).toISOString().split('T')[0];
            elements.checkoutDate.value = elements.checkoutDate.min;
            elements.checkoutModal.classList.add('open');
            updateHeaderVisibility();
            updateCheckoutTotal();
        }
        function closeCheckout() { modalState.checkout = false; elements.checkoutModal.classList.remove('open'); setTimeout(updateHeaderVisibility, 50); }

        // Карусель промо
        const slides = elements.promoCarousel.querySelectorAll('a');
        const dots = elements.promoCarousel.querySelectorAll('.dot');
        let currentSlide = 0;
        setInterval(() => {
            currentSlide = (currentSlide + 1) % slides.length;
            slides.forEach((s, i) => s.classList.toggle('active', i === currentSlide));
            dots.forEach((d, i) => d.classList.toggle('active', i === currentSlide));
        }, 3000);

        // Продуктовая карусель в деталях
        function startProductImageCarousel() {
            const carousel = elements.detailContent.querySelector('.product-image-carousel');
            if (!carousel) return;
            const imgs = carousel.querySelectorAll('img');
            const dots = carousel.querySelectorAll('.dot');
            imgs.forEach((img, i) => img.classList.toggle('active', i === appState.productImageIndex));
            dots.forEach((d, i) => d.classList.toggle('active', i === appState.productImageIndex));
        }

        // Добавление в корзину с анимацией
        function animateImageToCart(imgEl) {
            if (!imgEl) return;
            const rect = imgEl.getBoundingClientRect();
            const cartRect = elements.cartBtn.getBoundingClientRect();
            const clone = imgEl.cloneNode(true);
            clone.classList.add('fly-img');
            clone.style.width = rect.width + 'px';
            clone.style.height = rect.height + 'px';
            clone.style.left = rect.left + 'px';
            clone.style.top = rect.top + 'px';
            document.body.appendChild(clone);
            requestAnimationFrame(() => {
                const dx = cartRect.left + cartRect.width / 2 - rect.left - rect.width / 2;
                const dy = cartRect.top + cartRect.height / 2 - rect.top - rect.height / 2;
                clone.style.transform = `translate(${dx}px, ${dy}px) scale(0.2) rotate(20deg)`;
                clone.style.opacity = '0';
            });
            setTimeout(() => clone.remove(), 900);
        }

        function addToCartById(id, qty = 1, source = null) {
            const p = products.find(x => x.id === id);
            if (!p) return;
            const existing = appState.cart.find(i => i.id === id && i.selectedSize === appState.selectedSize && i.selectedFilling === appState.selectedFilling);
            if (existing) existing.quantity += qty;
            else appState.cart.push({ ...p, quantity: qty, selectedSize: appState.selectedSize, selectedFilling: appState.selectedFilling });
            localStorage.setItem('cart', JSON.stringify(appState.cart));
            updateCartBadge();
            let img = source;
            if (!img) img = document.querySelector(`.product-card img[data-product-id="${id}"]`) || document.querySelector('#detail-content img.active');
            animateImageToCart(img);
            showNotification(`${p.name} добавлен в корзину`, 'success');
            if (modalState.cart) renderCart();
        }

        function updateCartBadge() {
            const total = appState.cart.reduce((s, i) => s + i.quantity, 0);
            elements.cartBadge.textContent = total;
            elements.cartBadge.classList.toggle('hidden', total === 0);
        }

        function renderProducts() {
            elements.productsCount.textContent = `${products.length} товаров`;
            elements.productsGrid.innerHTML = products.map(p => `
                <div class="product-card relative" onclick="openProductDetailById('${p.id}')">
                    <div class="relative h-36 rounded-t-lg overflow-hidden">
                        <img data-product-id="${p.id}" src="${p.cartImage || p.images[0]}" alt="${p.name}" class="w-full h-full object-cover">
                        ${p.isHot ? '<div class="hot-badge absolute top-2 left-3 bg-red-600 text-white px-3 py-1 rounded-full text-xs font-bold">HOT</div>' : ''}
                    </div>
                    <div class="p-4">
                        <h3 class="font-semibold text-base">${p.name}</h3>
                        <p class="text-sm opacity-70 line-clamp-2">${p.description}</p>
                        <div class="mt-3 flex justify-between items-end">
                            <span class="font-bold text-lg">${p.sizes ? p.sizes[0].price : p.price} ₽</span>
                        </div>
                    </div>
                    <button onclick="event.stopPropagation(); addToCartById('${p.id}', 1, this.closest('.product-card').querySelector('img'))" class="add-to-cart-btn">
                        <svg fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 6v6m0 0v6m0-6h6m-6 0H6"/></svg>
                    </button>
                </div>
            `).join('');
        }

        function renderProductDetail() {
            const p = appState.selectedProduct;
            const price = p.sizes ? p.sizes.find(s => s.size === appState.selectedSize).price : p.price;
            elements.detailContent.innerHTML = `
                <div class="product-image-carousel relative overflow-hidden rounded-lg mb-4">
                    ${p.images.map((img, i) => `<img src="${img}" class="absolute inset-0 w-full h-80 object-cover ${i===0?'active':''}" style="opacity:${i===0?1:0}">`).join('')}
                    <div class="product-image-dots absolute bottom-3 left-1/2 -translate-x-1/2 flex gap-2">
                        ${p.images.map((_,i) => `<div class="dot w-2 h-2 rounded-full bg-white/50 ${i===0?'active bg-white':''}"></div>`).join('')}
                    </div>
                </div>
                <h1 class="text-2xl font-bold mb-4">${p.name}</h1>
                ${p.sizes ? `<div class="mb-4"><h3 class="font-semibold mb-2">Размер</h3><div class="grid grid-cols-3 gap-3">${p.sizes.map(s => `<button onclick="appState.selectedSize='${s.size}';renderProductDetail()" class="p-3 rounded-lg border ${appState.selectedSize===s.size?'border-gold bg-gold/10':''} text-left"><div class="font-bold">${s.size}</div><div class="text-sm opacity-70">${s.weight} • ${s.price} ₽</div></button>`).join('')}</div></div>` : ''}
                ${p.fillings ? `<div class="mb-4"><h3 class="font-semibold mb-2">Начинка</h3><div class="grid grid-cols-2 gap-3">${p.fillings.map(f => `<button onclick="appState.selectedFilling='${f.name}';renderProductDetail()" class="p-3 rounded-lg border ${appState.selectedFilling===f.name?'border-gold bg-gold/10':''} text-center">${f.name}</button>`).join('')}</div></div>` : ''}
                <p class="text-sm opacity-80 mb-6">${p.description}</p>
                <div class="flex items-center justify-center gap-6 mb-6">
                    <button onclick="appState.detailQuantity=Math.max(1,appState.detailQuantity-1);renderProductDetail()" class="w-12 h-12 rounded-full bg-white/10 flex items-center justify-center">-</button>
                    <span class="text-2xl font-bold w-16 text-center">${appState.detailQuantity}</span>
                    <button onclick="appState.detailQuantity++;renderProductDetail()" class="w-12 h-12 rounded-full bg-white/10 flex items-center justify-center">+</button>
                </div>
                <button onclick="addToCartById(p.id, appState.detailQuantity); closeProductDetail()" class="btn-primary w-full">
                    Добавить в корзину • ${price * appState.detailQuantity} ₽
                </button>
            `;
            startProductImageCarousel();
        }

        function renderCart() {
            const total = appState.cart.reduce((s, i) => s + (i.sizes ? i.sizes.find(x => x.size === i.selectedSize).price : i.price) * i.quantity, 0);
            if (appState.cart.length === 0) {
                elements.cartContent.innerHTML = `<div class="flex-1 flex flex-col items-center justify-center text-center p-6">
                    <p class="text-2xl font-bold mb-2">Корзина пуста</p>
                    <button onclick="closeCart()" class="btn-primary mt-4 px-8">Продолжить покупки</button>
                </div>`;
                return;
            }
            elements.cartContent.innerHTML = `
                <div class="space-y-4 p-4 flex-1 overflow-y-auto">
                    ${appState.cart.map(item => {
                        const price = item.sizes ? item.sizes.find(s => s.size === item.selectedSize).price : item.price;
                        return `<div class="bg-var(--dark-green-light) rounded-lg p-4 flex gap-4">
                            <img src="${item.cartImage}" class="w-20 h-20 rounded-lg object-cover">
                            <div class="flex-1">
                                <h4 class="font-semibold">${item.name} ${item.selectedSize?'('+item.selectedSize+')':''}</h4>
                                <p class="text-gold font-bold">${price} ₽ × ${item.quantity} = ${price*item.quantity} ₽</p>
                            </div>
                            <button onclick="appState.cart=appState.cart.filter(x=>x!==item);localStorage.setItem('cart',JSON.stringify(appState.cart));updateCartBadge();renderCart()" class="text-red-500">✕</button>
                        </div>`;
                    }).join('')}
                </div>
                <div class="p-4 border-t border-white/10">
                    <div class="flex justify-between text-xl font-bold mb-4"><span>Итого</span><span>${total} ₽</span></div>
                    <button onclick="openCheckout();closeCart()" class="btn-primary w-full">Оформить заказ</button>
                </div>
            `;
        }

        function updateCheckoutTotal() {
            const total = appState.cart.reduce((s, i) => s + (i.sizes ? i.sizes.find(x => x.size === i.selectedSize).price : i.price) * i.quantity, 0);
            elements.checkoutTotal.textContent = total + ' ₽';
        }

        function placeOrder() {
            if (!elements.checkoutDate.value || !elements.checkoutTime.value || !elements.checkoutPhone.value) return showNotification('Заполните все поля', 'error');
            const btn = elements.placeOrderBtn;
            btn.disabled = true; btn.innerHTML = 'Оформляем...';
            const total = appState.cart.reduce((s, i) => s + (i.sizes ? i.sizes.find(x => x.size === i.selectedSize).price : i.price) * i.quantity, 0);
            const order = {
                event: 'order_submit',
                user_id: Telegram.WebApp.initDataUnsafe.user?.id || 'unknown',
                total_amount: total,
                date: elements.checkoutDate.value,
                time: elements.checkoutTime.value,
                phone: elements.checkoutPhone.value,
                items: appState.cart.map(i => ({name: i.name, size: i.selectedSize, filling: i.selectedFilling, qty: i.quantity, price: i.sizes ? i.sizes.find(x=>x.size===i.selectedSize).price : i.price}))
            };
            fetch('https://script.google.com/macros/s/AKfycbwsSdkjGwalHh6HqzvPRnNz9BSK28HWfFm_erpMLeANPZu_K2eUdwhDdrl9jEtAENRigg/exec', {
                method: 'POST',
                mode: 'no-cors',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify(order)
            }).finally(() => {
                showNotification('Заказ принят! Ожидайте подтверждения.', 'success');
                appState.cart = []; localStorage.setItem('cart', '[]');
                updateCartBadge(); closeCheckout(); closeCart();
                btn.disabled = false; btn.innerHTML = 'Оформить заказ';
            });
        }

        function showNotification(msg, type = 'success') {
            const n = document.createElement('div');
            n.className = `fixed bottom-6 left-1/2 -translate-x-1/2 px-6 py-3 rounded-full text-white font-bold z-50 ${type==='success'?'bg-green-600':'bg-red-600'}`;
            n.textContent = msg;
            document.body.appendChild(n);
            setTimeout(() => n.remove(), 3000);
        }

        // Инициализация
        elements.cartBtn.addEventListener('click', openCart);
        elements.cartBackBtn.addEventListener('click', closeCart);
        elements.cartCloseBtn.addEventListener('click', closeCart);
        elements.detailBackBtn.addEventListener('click', closeProductDetail);
        elements.detailCloseBtn.addEventListener('click', closeProductDetail);
        elements.checkoutClose.addEventListener('click', closeCheckout);
        elements.checkoutBackBtn.addEventListener('click', () => { closeCheckout(); openCart(); });
        elements.placeOrderBtn.addEventListener('click', placeOrder);
        elements.modalBackdrop.addEventListener('click', () => { if(modalState.checkout) closeCheckout(); else if(modalState.cart) closeCart(); else if(modalState.detail) closeProductDetail(); });

        // Загрузка корзины
        const saved = localStorage.getItem('cart');
        if (saved) try { appState.cart = JSON.parse(saved); } catch(e) {}
        updateCartBadge();
        renderProducts();
    </script>
</body>
</html>
