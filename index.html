<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Кондитерская</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
            overscroll-behavior: none;
            margin: 0;
            padding: 0;
            -webkit-tap-highlight-color: transparent;
        }
        .animate-zoom-in {
            animation: zoomIn 0.3s ease forwards;
        }
        .animate-fade-in {
            animation: fadeIn 0.3s ease forwards;
        }
        @keyframes zoomIn {
            from { transform: scale(0.8); opacity: 0; }
            to { transform: scale(1); opacity: 1; }
        }
        @keyframes fadeIn {
            from { opacity: 0; }
            to { opacity: 1; }
        }
        .category-pill {
            scroll-snap-align: start;
            flex-shrink: 0;
            min-width: 100px;
        }
        .carousel {
            scroll-snap-type: x mandatory;
            -webkit-overflow-scrolling: touch;
            scrollbar-width: none;
            -ms-overflow-style: none;
        }
        .carousel::-webkit-scrollbar {
            display: none;
        }
        .sidebar {
            width: min(80vw, 280px);
            max-width: 280px;
        }
        .cart-modal, .product-detail {
            height: 100dvh;
            max-height: 100dvh;
            overflow-y: auto;
        }
        .input-field {
            width: 100%;
            box-sizing: border-box;
        }
        .quantity-btn svg {
            width: 16px;
            height: 16px;
        }
        .rating-star {
            color: #facc15;
        }
        .discount-badge {
            position: absolute;
            top: 8px;
            left: 8px;
            background: #dc2626;
            color: white;
            padding: 4px 8px;
            border-radius: 12px;
            font-size: 10px;
            font-weight: bold;
        }
        @media (min-width: 768px) {
            .sidebar {
                width: min(30vw, 320px);
            }
            .product-card {
                width: calc((100% - 3rem) / 3);
            }
            .products-grid {
                grid-template-columns: repeat(auto-fill, minmax(200px, 1fr));
            }
        }
        @media (min-width: 1024px) {
            .product-card {
                width: calc((100% - 4rem) / 4);
            }
        }
    </style>
</head>
<body class="bg-gray-100">
    <!-- Header -->
    <header class="fixed top-0 left-0 right-0 bg-white shadow-sm z-40">
        <div class="flex items-center justify-between p-3">
            <button id="menu-btn" class="p-2">
                <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 6h16M4 12h16M4 18h16"/>
                </svg>
            </button>
            <h1 class="text-lg font-semibold">Кондитерская</h1>
            <div class="relative">
                <button id="cart-btn" class="p-2">
                    <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M3 3h2l.4 2M7 13h10l4-8H5.4M7 13L5.4 5M7 13l-2.293 2.293c-.63.63-.184 1.707.707 1.707H17m0 0a2 2 0 100 4 2 2 0 000-4zm-8 2a2 2 0 11-4 0 2 2 0 014 0z"/>
                    </svg>
                    <span id="cart-badge" class="absolute -top-1 -right-1 bg-pink-600 text-white text-xs rounded-full w-4 h-4 flex items-center justify-center hidden">0</span>
                </button>
            </div>
        </div>
    </header>

    <!-- Sidebar -->
    <div id="sidebar-overlay" class="fixed inset-0 bg-black/50 z-50 hidden"></div>
    <div id="sidebar" class="fixed top-0 left-0 h-full bg-white shadow-lg z-50 transform -translate-x-full transition-transform">
        <div class="flex items-center justify-between p-4 border-b">
            <h2 class="text-lg font-semibold">Меню</h2>
            <button id="sidebar-close-btn">
                <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"/>
                </svg>
            </button>
        </div>
        <nav class="p-4 space-y-2">
            <a href="#" class="block py-2 px-4 hover:bg-gray-100 rounded">Главная</a>
            <a href="#" class="block py-2 px-4 hover:bg-gray-100 rounded">О нас</a>
            <a href="#" class="block py-2 px-4 hover:bg-gray-100 rounded">Контакты</a>
            <a href="#" class="block py-2 px-4 hover:bg-gray-100 rounded">Доставка</a>
        </nav>
    </div>

    <!-- Main Content -->
    <main class="pt-16 pb-20 px-4 max-w-7xl mx-auto">
        <!-- Promo Carousel -->
        <div id="promo-carousel" class="carousel flex overflow-x-auto gap-3 mb-6">
            <div class="flex-shrink-0 w-64 h-32 bg-gray-200 rounded-lg"></div>
            <div class="flex-shrink-0 w-64 h-32 bg-gray-200 rounded-lg"></div>
            <div class="flex-shrink-0 w-64 h-32 bg-gray-200 rounded-lg"></div>
        </div>

        <!-- Categories -->
        <div id="category-carousel" class="carousel flex overflow-x-auto gap-3 mb-6">
            <button class="category-pill px-4 py-2 bg-pink-100 text-pink-600 rounded-full font-medium text-sm active" data-category="all">Все</button>
            <button class="category-pill px-4 py-2 bg-gray-100 hover:bg-pink-100 rounded-full font-medium text-sm" data-category="cakes">Торты</button>
            <button class="category-pill px-4 py-2 bg-gray-100 hover:bg-pink-100 rounded-full font-medium text-sm" data-category="cupcakes">Капкейки</button>
            <button class="category-pill px-4 py-2 bg-gray-100 hover:bg-pink-100 rounded-full font-medium text-sm" data-category="subscription">Подписка</button>
            <button class="category-pill px-4 py-2 bg-gray-100 hover:bg-pink-100 rounded-full font-medium text-sm" data-category="new">Новинки</button>
        </div>

        <!-- Products -->
        <div class="flex items-center justify-between mb-4">
            <h2 id="section-title" class="text-lg font-semibold">Сладости</h2>
            <span id="products-count" class="text-sm text-gray-600">6 товаров</span>
        </div>
        <div id="no-products" class="hidden text-center py-8">
            <p class="text-lg font-medium">Товары не найдены</p>
            <p class="text-sm text-gray-600">Попробуйте другую категорию</p>
        </div>
        <div id="products-grid" class="grid grid-cols-2 gap-4 md:grid-cols-3 lg:grid-cols-4"></div>
    </main>

    <!-- Cart Modal -->
    <div id="cart-modal" class="fixed inset-0 bg-white z-50 transform translate-y-full transition-transform">
        <div class="flex flex-col h-full">
            <div class="flex items-center justify-between p-4 border-b bg-white">
                <button id="cart-back-btn">
                    <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 19l-7-7 7-7"/>
                    </svg>
                </button>
                <h2 class="text-lg font-semibold">Корзина</h2>
                <div class="relative">
                    <span id="cart-total-badge" class="bg-pink-600 text-white text-xs rounded-full w-5 h-5 flex items-center justify-center hidden">0</span>
                    <button id="cart-close-btn">
                        <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"/>
                        </svg>
                    </button>
                </div>
            </div>
            <div id="cart-content" class="flex-1 overflow-auto"></div>
        </div>
    </div>

    <!-- Product Detail Modal -->
    <div id="product-detail" class="fixed inset-0 bg-white z-50 transform translate-y-full transition-transform">
        <div class="flex flex-col h-full">
            <div class="flex items-center justify-between p-4 border-b bg-white">
                <button id="detail-back-btn">
                    <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 19l-7-7 7-7"/>
                    </svg>
                </button>
                <h2 id="detail-title" class="text-lg font-semibold"></h2>
                <button id="detail-close-btn">
                    <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"/>
                    </svg>
                </button>
            </div>
            <div id="detail-content" class="flex-1 overflow-auto p-4"></div>
        </div>
    </div>

    <script>
        // Инициализация Telegram Web App
        if (window.Telegram?.WebApp) {
            window.Telegram.WebApp.ready();
            window.Telegram.WebApp.expand();
            window.Telegram.WebApp.disableVerticalSwipes();
        }

        // App State
        const appState = {
            currentView: 'main',
            activeCategory: 'all',
            cart: [],
            selectedProduct: null
        };

        // Mock Data
        const products = [
            {
                id: '1',
                name: 'Торт "Шоколадный рай"',
                description: 'Нежный шоколадный бисквит с кремом и ягодами',
                price: 1200,
                image: 'https://images.unsplash.com/photo-1578985545062-69928b1d9587?w=400&h=300&fit=crop',
                category: 'cakes',
                rating: 4.8,
                reviewCount: 124,
                isNew: true,
                discount: 15,
                volume: '1 кг',
                ingredients: ['Бисквит шоколадный', 'Крем сливочный', 'Ягоды свежие', 'Шоколадная глазурь']
            },
            {
                id: '2',
                name: 'Капкейки "Ванильные"',
                description: 'Воздушные капкейки с ванильным кремом',
                price: 150,
                image: 'https://images.unsplash.com/photo-1587736701009-d4ce8b6ad99b?w=400&h=300&fit=crop',
                category: 'cupcakes',
                rating: 4.6,
                reviewCount: 89,
                isNew: false,
                volume: '1 шт',
                ingredients: ['Ванильный бисквит', 'Крем ванильный', 'Сахарная пудра']
            },
            {
                id: '3',
                name: 'SweetBox подписка',
                description: 'Ежемесячная подписка на коробку с десертами',
                price: 2500,
                image: 'https://images.unsplash.com/photo-1606890737304-57a1ca8a5b62?w=400&h=300&fit=crop',
                category: 'subscription',
                rating: 4.9,
                reviewCount: 256,
                isNew: true,
                volume: 'Месяц',
                ingredients: ['Ассорти десертов']
            },
            {
                id: '4',
                name: 'Эклеры классические',
                description: 'Традиционные эклеры с заварным кремом',
                price: 200,
                image: 'https://images.unsplash.com/photo-1486427944299-d1955d23e34d?w=400&h=300&fit=crop',
                category: 'cakes',
                rating: 4.7,
                reviewCount: 67,
                isNew: false,
                volume: '1 шт',
                ingredients: ['Заварное тесто', 'Крем заварной', 'Шоколадная глазурь']
            },
            {
                id: '5',
                name: 'Макаруны ассорти',
                description: 'Набор разноцветных макарунов',
                price: 300,
                image: 'https://images.unsplash.com/photo-1571115764595-644a1f56a55c?w=400&h=300&fit=crop',
                category: 'cupcakes',
                rating: 4.5,
                reviewCount: 43,
                isNew: true,
                discount: 10,
                volume: '6 шт',
                ingredients: ['Миндальная мука', 'Крем ганаш']
            },
            {
                id: '6',
                name: 'Чизкейк "Нью-Йорк"',
                description: 'Классический американский чизкейк',
                price: 800,
                image: 'https://images.unsplash.com/photo-1524351199678-941a58a3df50?w=400&h=300&fit=crop',
                category: 'cakes',
                rating: 4.9,
                reviewCount: 178,
                isNew: false,
                volume: '800 г',
                ingredients: ['Сливочный сыр', 'Песочное тесто']
            }
        ];

        // DOM Elements
        const elements = {
            menuBtn: document.getElementById('menu-btn'),
            cartBtn: document.getElementById('cart-btn'),
            cartBadge: document.getElementById('cart-badge'),
            categories: document.querySelectorAll('.category-pill'),
            categoryCarousel: document.getElementById('category-carousel'),
            promoCarousel: document.getElementById('promo-carousel'),
            productsGrid: document.getElementById('products-grid'),
            noProducts: document.getElementById('no-products'),
            sectionTitle: document.getElementById('section-title'),
            productsCount: document.getElementById('products-count'),
            cartModal: document.getElementById('cart-modal'),
            cartBackBtn: document.getElementById('cart-back-btn'),
            cartCloseBtn: document.getElementById('cart-close-btn'),
            cartContent: document.getElementById('cart-content'),
            cartTotalBadge: document.getElementById('cart-total-badge'),
            productDetail: document.getElementById('product-detail'),
            detailBackBtn: document.getElementById('detail-back-btn'),
            detailTitle: document.getElementById('detail-title'),
            detailContent: document.getElementById('detail-content'),
            sidebarOverlay: document.getElementById('sidebar-overlay'),
            sidebar: document.getElementById('sidebar'),
            sidebarCloseBtn: document.getElementById('sidebar-close-btn')
        };

        // Event Listeners
        function initEventListeners() {
            elements.menuBtn.addEventListener('click', toggleSidebar);
            elements.cartBtn.addEventListener('click', openCart);
            elements.cartBackBtn.addEventListener('click', closeCart);
            elements.cartCloseBtn.addEventListener('click', closeCart);
            elements.detailBackBtn.addEventListener('click', closeProductDetail);
            elements.sidebarCloseBtn.addEventListener('click', closeSidebar);
            elements.sidebarOverlay.addEventListener('click', closeSidebar);

            elements.categories.forEach(btn => {
                btn.addEventListener('click', () => {
                    elements.categories.forEach(b => b.classList.remove('active', 'bg-pink-100', 'text-pink-600'));
                    btn.classList.add('active', 'bg-pink-100', 'text-pink-600');
                    appState.activeCategory = btn.dataset.category;
                    renderProducts();
                    elements.categoryCarousel.scrollTo({ left: btn.offsetLeft - 16, behavior: 'smooth' });
                });
            });

            setupSwipe(elements.categoryCarousel);
            setupSwipe(elements.promoCarousel);
            setupSidebarSwipe();
            setupMouseDrag(elements.categoryCarousel);
            setupMouseDrag(elements.promoCarousel);
            window.addEventListener('resize', debounce(renderProducts, 100));
        }

        // Enhanced Swipe Handler
        function setupSwipe(element) {
            let startX = 0, startY = 0, currentX = 0, isDragging = false;
            let scrollTimeout;

            element.addEventListener('touchstart', e => {
                startX = e.touches[0].clientX;
                startY = e.touches[0].clientY;
                isDragging = true;
                element.style.transition = 'none';
                clearTimeout(scrollTimeout);
            });

            element.addEventListener('touchmove', e => {
                if (!isDragging) return;
                currentX = e.touches[0].clientX;
                const currentY = e.touches[0].clientY;
                const diffX = currentX - startX;
                const diffY = currentY - startY;
                if (Math.abs(diffY) > Math.abs(diffX)) {
                    isDragging = false;
                    return;
                }
                e.preventDefault();
                element.scrollLeft -= diffX;
                startX = currentX;
            });

            element.addEventListener('touchend', () => {
                if (!isDragging) return;
                isDragging = false;
                element.style.transition = 'scroll-left 0.3s ease';
                scrollTimeout = setTimeout(() => {
                    const scrollLeft = element.scrollLeft;
                    const snapPoint = Math.round(scrollLeft / 100) * 100;
                    element.scrollTo({ left: snapPoint, behavior: 'smooth' });
                }, 100);
            });
        }

        // Mouse Drag Handler for Desktop
        function setupMouseDrag(element) {
            let isDragging = false, startX = 0, scrollLeft = 0;

            element.addEventListener('mousedown', e => {
                isDragging = true;
                startX = e.pageX;
                scrollLeft = element.scrollLeft;
                element.style.transition = 'none';
                element.style.cursor = 'grabbing';
            });

            element.addEventListener('mousemove', e => {
                if (!isDragging) return;
                e.preventDefault();
                const x = e.pageX;
                const walk = (x - startX) * 1.5;
                element.scrollLeft = scrollLeft - walk;
            });

            element.addEventListener('mouseup', () => {
                isDragging = false;
                element.style.transition = 'scroll-left 0.3s ease';
                element.style.cursor = 'grab';
                const snapPoint = Math.round(element.scrollLeft / 100) * 100;
                element.scrollTo({ left: snapPoint, behavior: 'smooth' });
            });

            element.addEventListener('mouseleave', () => {
                if (isDragging) {
                    isDragging = false;
                    element.style.transition = 'scroll-left 0.3s ease';
                    element.style.cursor = 'grab';
                    const snapPoint = Math.round(element.scrollLeft / 100) * 100;
                    element.scrollTo({ left: snapPoint, behavior: 'smooth' });
                }
            });
        }

        // Sidebar Swipe Handler
        function setupSidebarSwipe() {
            let startX = 0, currentX = 0, isDragging = false;

            document.addEventListener('touchstart', e => {
                startX = e.touches[0].clientX;
                isDragging = true;
                elements.sidebar.style.transition = 'none';
            });

            document.addEventListener('touchmove', e => {
                if (!isDragging) return;
                currentX = e.touches[0].clientX;
                const diff = currentX - startX;
                if (elements.sidebar.classList.contains('open')) {
                    if (diff > 0) {
                        elements.sidebar.style.transform = `translateX(${Math.min(diff, 0)}px)`;
                    }
                } else if (startX < 50 && diff > 0) {
                    elements.sidebar.style.transform = `translateX(${Math.min(diff - 280, 0)}px)`;
                }
            });

            document.addEventListener('touchend', () => {
                if (!isDragging) return;
                isDragging = false;
                elements.sidebar.style.transition = 'transform 0.3s ease';
                const transform = parseFloat(elements.sidebar.style.transform.match(/[-0-9.]+/) || [0]);
                if (elements.sidebar.classList.contains('open')) {
                    if (transform > -140) {
                        closeSidebar();
                    } else {
                        elements.sidebar.style.transform = 'translateX(0)';
                    }
                } else {
                    if (transform > -140) {
                        toggleSidebar();
                    } else {
                        elements.sidebar.style.transform = 'translateX(-100%)';
                    }
                }
            });
        }

        // Sidebar Functions
        function toggleSidebar() {
            elements.sidebarOverlay.classList.add('open');
            elements.sidebar.classList.add('open');
            elements.sidebar.style.transform = 'translateX(0)';
        }

        function closeSidebar() {
            elements.sidebarOverlay.classList.remove('open');
            elements.sidebar.classList.remove('open');
            elements.sidebar.style.transform = 'translateX(-100%)';
        }

        // Cart Functions
        function openCart() {
            elements.cartModal.classList.add('open');
            elements.cartModal.style.transform = 'translateY(0)';
            renderCart();
        }

        function closeCart() {
            elements.cartModal.classList.remove('open');
            elements.cartModal.style.transform = 'translateY(100%)';
        }

        function addToCartById(productId, quantity = 1) {
            const product = products.find(p => p.id === productId);
            if (!product) {
                showNotification('Продукт не найден', 'error');
                return;
            }
            const existingItem = appState.cart.find(item => item.id === product.id);
            if (existingItem) {
                existingItem.quantity += quantity;
            } else {
                appState.cart.push({ ...product, quantity });
            }
            localStorage.setItem('cart', JSON.stringify(appState.cart));
            updateCartBadge();
            showNotification(`${product.name} добавлен в корзину`, 'success');
        }

        function updateCartQuantity(productId, newQuantity) {
            const item = appState.cart.find(item => item.id === productId);
            if (!item) {
                showNotification('Товар не найден в корзине', 'error');
                return;
            }
            if (newQuantity <= 0) {
                removeFromCart(productId);
                return;
            }
            item.quantity = newQuantity;
            localStorage.setItem('cart', JSON.stringify(appState.cart));
            updateCartBadge();
            renderCart();
        }

        function removeFromCart(productId) {
            appState.cart = appState.cart.filter(item => item.id !== productId);
            localStorage.setItem('cart', JSON.stringify(appState.cart));
            updateCartBadge();
            renderCart();
        }

        function clearCart() {
            appState.cart = [];
            localStorage.setItem('cart', JSON.stringify(appState.cart));
            updateCartBadge();
            renderCart();
        }

        function updateCartBadge() {
            const totalItems = Array.isArray(appState.cart) ? appState.cart.reduce((sum, item) => sum + item.quantity, 0) : 0;
            elements.cartBadge.textContent = totalItems > 9 ? '9+' : totalItems;
            elements.cartTotalBadge.textContent = totalItems;
            elements.cartBadge.classList.toggle('hidden', totalItems === 0);
            elements.cartTotalBadge.classList.toggle('hidden', totalItems === 0);
        }

        function renderCart() {
            const cartContent = elements.cartContent;
            const cartItems = appState.cart.map(item => item.id).join(',');
            if (cartContent.dataset.cartItems === cartItems) return;
            cartContent.dataset.cartItems = cartItems;

            if (!Array.isArray(appState.cart) || appState.cart.length === 0) {
                elements.cartContent.innerHTML = `
                    <div class="flex-1 flex flex-col items-center justify-center text-center p-4">
                        <svg class="w-16 h-16 mx-auto mb-4 opacity-50" viewBox="0 0 24 24">
                            <path d="M16 11V7a4 4 0 00-8 0v4M5 9h14l-1 12H6L5 9z"/>
                        </svg>
                        <p class="text-lg font-medium">Корзина пуста</p>
                        <p class="text-sm">Добавьте вкусные десерты</p>
                        <button onclick="closeCart()" class="btn-primary mt-4">Продолжить покупки</button>
                    </div>
                `;
                return;
            }

            const totalAmount = appState.cart.reduce((sum, item) => sum + item.price * item.quantity, 0);
            const deliveryFee = totalAmount >= 2000 ? 0 : 300;
            const finalAmount = totalAmount + deliveryFee;

            elements.cartContent.innerHTML = `
                <div class="flex-1 overflow-auto space-y-3 p-4">
                    ${appState.cart.map(item => `
                        <div class="cart-item animate-fade-in flex gap-3">
                            <img src="${item.image}" alt="${item.name}" class="w-16 h-16 object-cover rounded-lg flex-shrink-0">
                            <div class="flex-1 min-w-0">
                                <h4 class="line-clamp-1 mb-1 font-medium text-sm">${item.name}</h4>
                                <p class="text-sm text-pink-600 font-semibold mb-2">
                                    ${item.price} ₽ × ${item.quantity} = ${item.price * item.quantity} ₽
                                </p>
                                <div class="flex items-center justify-between">
                                    <div class="quantity-controls flex items-center gap-2">
                                        <button class="quantity-btn p-1 bg-gray-100 rounded" onclick="updateCartQuantity('${item.id}', ${item.quantity - 1})">
                                            <svg class="icon" viewBox="0 0 24 24">
                                                <path d="M20 12H4"/>
                                            </svg>
                                        </button>
                                        <span class="w-8 text-center font-medium">${item.quantity}</span>
                                        <button class="quantity-btn p-1 bg-gray-100 rounded" onclick="updateCartQuantity('${item.id}', ${item.quantity + 1})">
                                            <svg class="icon" viewBox="0 0 24 24">
                                                <path d="M12 6v6m0 0v6m0-6h6m-6 0H6"/>
                                            </svg>
                                        </button>
                                    </div>
                                    <button onclick="removeFromCart('${item.id}')" class="p-2 text-red-500 hover:bg-red-50 rounded-lg">
                                        <svg class="icon" viewBox="0 0 24 24">
                                            <path d="M19 7l-.867 12.142A2 2 0 0116.138 21H7.862a2 2 0 01-1.995-1.858L5 7m5 4v6m4-6v6m1-10V4a1 1 0 00-1-1h-4a1 1 0 00-1 1v3M4 7h16"/>
                                        </svg>
                                    </button>
                                </div>
                            </div>
                        </div>
                    `).join('')}
                </div>
                <div class="border-t bg-white p-4 space-y-3">
                    <h3 class="font-semibold text-sm">Оформление заказа</h3>
                    <div class="grid grid-cols-2 gap-3">
                        <div>
                            <label class="text-xs font-medium text-gray-600 mb-1 flex items-center gap-1">
                                <svg class="icon w-4 h-4" viewBox="0 0 24 24">
                                    <path d="M8 7V3a2 2 0 012-2h4a2 2 0 012 2v4m-6 0h6m-6 0l-2 8h10l-2-8"/>
                                </svg>
                                Дата
                            </label>
                            <input type="date" class="input-field border rounded-lg p-2 text-sm" min="${new Date().toISOString().split('T')[0]}" required>
                        </div>
                        <div>
                            <label class="text-xs font-medium text-gray-600 mb-1 block">Время</label>
                            <input type="time" class="input-field border rounded-lg p-2 text-sm" min="09:00" max="21:00" required>
                        </div>
                    </div>
                    <div>
                        <label class="text-xs font-medium text-gray-600 mb-1 flex items-center gap-1">
                            <svg class="icon w-4 h-4" viewBox="0 0 24 24">
                                <path d="M17.657 16.657L13.414 20.9a1.998 1.998 0 01-2.827 0l-4.244-4.243a8 8 0 1111.314 0z"/>
                            </svg>
                            Адрес доставки
                        </label>
                        <input type="text" placeholder="Улица, дом, квартира" class="input-field border rounded-lg p-2 text-sm" data-address required>
                    </div>
                    <div>
                        <label class="text-xs font-medium text-gray-600 mb-1 flex items-center gap-1">
                            <svg class="icon w-4 h-4" viewBox="0 0 24 24">
                                <path d="M3 5a2 2 0 012-2h3.28a1 1 0 01.948.684l1.498 4.493a1 1 0 01-.502 1.21l-2.257 1.13a11.042 11.042 0 005.516 5.516l1.13-2.257a1 1 0 011.21-.502l4.493 1.498a1 1 0 01.684.949V19a2 2 0 01-2 2h-1C9.716 21 3 14.284 3 6V5z"/>
                            </svg>
                            Телефон
                        </label>
                        <input type="tel" placeholder="+7 (999) 123-45-67" class="input-field border rounded-lg p-2 text-sm" required>
                    </div>
                    <div class="space-y-2 pt-2">
                        <div class="flex justify-between text-sm">
                            <span>Товары (${appState.cart.reduce((sum, item) => sum + item.quantity, 0)})</span>
                            <span>${totalAmount} ₽</span>
                        </div>
                        <div class="flex justify-between text-sm">
                            <span>Доставка</span>
                            <span class="${deliveryFee === 0 ? 'text-green-600' : ''}">
                                ${deliveryFee === 0 ? 'Бесплатно' : `${deliveryFee} ₽`}
                            </span>
                        </div>
                        ${totalAmount < 2000 ? '<p class="text-xs text-gray-600">Бесплатная доставка от 2000 ₽</p>' : ''}
                        <div class="flex justify-between font-semibold text-base pt-2 border-t">
                            <span>Итого</span>
                            <span class="text-pink-600">${finalAmount} ₽</span>
                        </div>
                    </div>
                    <div class="space-y-2 pt-2">
                        <button onclick="checkout()" class="btn-primary w-full h-12 bg-pink-600 text-white rounded-lg text-sm font-semibold flex items-center justify-center gap-2">
                            <svg class="icon w-5 h-5" viewBox="0 0 24 24">
                                <path d="M3 10h18M7 15h1m4 0h1m-7 4h12a3 3 0 003-3V8a3 3 0 00-3-3H6a3 3 0 00-3 3v8a3 3 0 003 3z"/>
                            </svg>
                            Оплатить ${finalAmount} ₽
                        </button>
                        <div class="grid grid-cols-2 gap-2">
                            <button onclick="clearCart()" class="btn-outline border border-gray-300 rounded-lg p-2 text-sm hover:bg-gray-100">Очистить</button>
                            <button onclick="closeCart()" class="btn-outline border border-gray-300 rounded-lg p-2 text-sm hover:bg-gray-100">Продолжить</button>
                        </div>
                    </div>
                </div>
            `;
        }

        // Product Detail Functions
        function openProductDetailById(productId) {
            const product = products.find(p => p.id === productId);
            if (!product) {
                showNotification('Продукт не найден', 'error');
                return;
            }
            appState.selectedProduct = product;
            elements.detailTitle.textContent = product.name;
            elements.productDetail.classList.add('open');
            elements.productDetail.style.transform = 'translateY(0)';
            renderProductDetail();
        }

        function closeProductDetail() {
            elements.productDetail.classList.remove('open');
            elements.productDetail.style.transform = 'translateY(100%)';
            appState.selectedProduct = null;
            detailQuantity = 1;
        }

        function renderProductDetail() {
            if (!appState.selectedProduct) return;
            const product = appState.selectedProduct;
            const discountedPrice = product.discount
                ? Math.round(product.price * (1 - product.discount / 100))
                : product.price;

            elements.detailContent.innerHTML = `
                <div class="relative h-64 bg-gray-200 mb-4">
                    <img src="${product.image}" alt="${product.name}" class="w-full h-full object-cover rounded-lg">
                    ${product.discount ? `<div class="discount-badge">Скидка -${product.discount}%</div>` : ''}
                    ${product.volume ? `
                        <div class="absolute top-2 right-2 bg-white/90 rounded-lg px-2 py-1 border">
                            <span class="text-xs font-medium">${product.volume}</span>
                        </div>
                    ` : ''}
                </div>
                <div class="space-y-3">
                    <div class="flex items-center gap-2">
                        <div class="flex items-center gap-1">
                            <svg class="rating-star w-4 h-4" fill="currentColor" viewBox="0 0 20 20">
                                <path d="M9.049 2.927c.3-.921 1.603-.921 1.902 0l1.07 3.292a1 1 0 00.95.69h3.462c.969 0 1.371 1.24.588 1.81l-2.8 2.034a1 1 0 00-.364 1.118l1.07 3.292c.3.921-.755 1.688-1.54 1.118l-2.8-2.034a1 1 0 00-1.175 0l-2.8 2.034c-.784.57-1.838-.197-1.539-1.118l1.07-3.292a1 1 0 00-.364-1.118L2.98 8.72c-.783-.57-.38-1.81.588-1.81h3.461a1 1 0 00.951-.69l1.07-3.292z"/>
                            </svg>
                            <span class="font-semibold text-sm">${product.rating}</span>
                        </div>
                        <span class="text-gray-600 text-xs">${product.reviewCount} оценок</span>
                    </div>
                    <h1 class="text-lg font-bold">${product.name}</h1>
                    <div class="space-y-2">
                        <h3 class="font-semibold text-sm">Размер</h3>
                        <div class="grid grid-cols-2 gap-2">
                            <button class="p-2 rounded-lg border border-pink-300 bg-pink-50 text-left">
                                <div class="font-medium text-sm">Маленький</div>
                                <div class="text-xs text-gray-600">${product.price} ₽</div>
                            </button>
                            <button class="p-2 rounded-lg border hover:border-pink-300 text-left">
                                <div class="font-medium text-sm">Средний</div>
                                <div class="text-xs text-gray-600">+200 ₽</div>
                            </button>
                        </div>
                    </div>
                    <div>
                        <p class="text-gray-600 text-sm line-clamp-2">${product.description}</p>
                    </div>
                    <div class="space-y-2">
                        <button class="flex items-center justify-between w-full py-2 text-left" onclick="toggleIngredients()">
                            <span class="font-semibold text-sm">Состав</span>
                            <svg id="ingredients-chevron" class="icon w-5 h-5 transition-transform" viewBox="0 0 24 24">
                                <path d="M19 9l-7 7-7-7"/>
                            </svg>
                        </button>
                        <div id="ingredients-list" class="space-y-1 hidden animate-fade-in">
                            ${product.ingredients ? product.ingredients.map(ing => `
                                <div class="text-xs text-gray-600">• ${ing}</div>
                            `).join('') : '<div class="text-xs text-gray-600">Состав отсутствует</div>'}
                        </div>
                    </div>
                    <div class="space-y-3 pt-3">
                        <div class="flex items-center justify-center gap-4">
                            <button class="quantity-btn p-1 bg-gray-100 rounded" onclick="changeDetailQuantity(-1)">
                                <svg class="icon w-5 h-5" viewBox="0 0 24 24">
                                    <path d="M20 12H4"/>
                                </svg>
                            </button>
                            <span id="detail-quantity" class="font-semibold text-lg">1</span>
                            <button class="quantity-btn p-1 bg-gray-100 rounded" onclick="changeDetailQuantity(1)">
                                <svg class="icon w-5 h-5" viewBox="0 0 24 24">
                                    <path d="M12 6v6m0 0v6m0-6h6m-6 0H6"/>
                                </svg>
                            </button>
                        </div>
                        <button onclick="addToCartFromDetail()" class="btn-primary w-full h-12 bg-pink-600 text-white rounded-lg text-sm font-semibold">
                            Добавить <span id="detail-total-price">${product.price}</span> ₽
                        </button>
                    </div>
                </div>
            `;
        }

        // Product Functions
        function getFilteredProducts() {
            let filtered = products;
            if (appState.activeCategory !== 'all') {
                if (appState.activeCategory === 'new') {
                    filtered = filtered.filter(product => product.isNew);
                } else {
                    filtered = filtered.filter(product => product.category === appState.activeCategory);
                }
            }
            return filtered;
        }

        function renderProducts() {
            requestAnimationFrame(() => {
                const filteredProducts = getFilteredProducts();
                if (appState.activeCategory === 'all') {
                    elements.sectionTitle.textContent = 'Сладости';
                } else {
                    const categoryNames = {
                        'cakes': 'Торты',
                        'cupcakes': 'Капкейки',
                        'subscription': 'Подписка',
                        'new': 'Новинки'
                    };
                    elements.sectionTitle.textContent = categoryNames[appState.activeCategory] || 'Сладости';
                }
                elements.productsCount.textContent = `${filteredProducts.length} товаров`;
                elements.productsGrid.classList.toggle('hidden', filteredProducts.length === 0);
                elements.noProducts.classList.toggle('hidden', filteredProducts.length !== 0);
                elements.productsGrid.innerHTML = filteredProducts.map(product => {
                    const discountedPrice = product.discount
                        ? Math.round(product.price * (1 - product.discount / 100))
                        : product.price;
                    return `
                        <div class="product-card animate-fade-in bg-white rounded-lg shadow-sm overflow-hidden cursor-pointer" onclick="openProductDetailById('${product.id}')">
                            <div class="relative h-32 bg-gray-200">
                                <img src="${product.image}" alt="${product.name}" class="w-full h-full object-cover">
                                ${product.discount ? `<div class="discount-badge">-${product.discount}%</div>` : ''}
                                ${product.isNew ? '<div class="absolute top-2 left-2 bg-green-500 text-white text-xs font-bold px-2 py-1 rounded-full">NEW</div>' : ''}
                                <div class="rating-display absolute top-2 right-2 flex items-center gap-1">
                                    <svg class="rating-star w-3 h-3" fill="currentColor" viewBox="0 0 20 20">
                                        <path d="M9.049 2.927c.3-.921 1.603-.921 1.902 0l1.07 3.292a1 1 0 00.95.69h3.462c.969 0 1.371 1.24.588 1.81l-2.8 2.034a1 1 0 00-.364 1.118l1.07 3.292c.3.921-.755 1.688-1.54 1.118l-2.8-2.034a1 1 0 00-1.175 0l-2.8 2.034c-.784.57-1.838-.197-1.539-1.118l1.07-3.292a1 1 0 00-.364-1.118L2.98 8.72c-.783-.57-.38-1.81.588-1.81h3.461a1 1 0 00.951-.69l1.07-3.292z"/>
                                    </svg>
                                    <span class="text-xs">${product.rating.toFixed(1)}</span>
                                </div>
                                <button onclick="addToCartById('${product.id}'); event.stopPropagation();" class="absolute bottom-2 right-2 bg-white border border-gray-300 hover:bg-gray-100 p-2 rounded-full">
                                    <svg class="icon w-5 h-5" viewBox="0 0 24 24">
                                        <path d="M12 6v6m0 0v6m0-6h6m-6 0H6"/>
                                    </svg>
                                </button>
                            </div>
                            <div class="p-3">
                                <h3 class="font-semibold text-sm line-clamp-1 mb-1">${product.name}</h3>
                                ${product.volume ? `<p class="text-xs text-gray-600">${product.volume}</p>` : ''}
                                <p class="text-xs text-gray-600 line-clamp-2 mb-2">${product.description}</p>
                                <div class="flex items-center gap-1 mb-2">
                                    <svg class="rating-star w-3 h-3" fill="currentColor" viewBox="0 0 20 20">
                                        <path d="M9.049 2.927c.3-.921 1.603-.921 1.902 0l1.07 3.292a1 1 0 00.95.69h3.462c.969 0 1.371 1.24.588 1.81l-2.8 2.034a1 1 0 00-.364 1.118l1.07 3.292c.3.921-.755 1.688-1.54 1.118l-2.8-2.034a1 1 0 00-1.175 0l-2.8 2.034c-.784.57-1.838-.197-1.539-1.118l1.07-3.292a1 1 0 00-.364-1.118L2.98 8.72c-.783-.57-.38-1.81.588-1.81h3.461a1 1 0 00.951-.69l1.07-3.292z"/>
                                    </svg>
                                    <span class="text-xs font-medium">${product.rating.toFixed(1)}</span>
                                    <span class="text-xs text-gray-600">(${product.reviewCount})</span>
                                </div>
                                <div class="flex items-center justify-between">
                                    <div class="flex flex-col">
                                        ${product.discount ? `
                                            <span class="text-xs text-gray-600 line-through">${product.price} ₽</span>
                                            <span class="font-bold text-sm text-pink-600">${discountedPrice} ₽</span>
                                        ` : `
                                            <span class="font-bold text-sm text-pink-600">${product.price} ₽</span>
                                        `}
                                    </div>
                                </div>
                            </div>
                        </div>
                    `;
                }).join('');
            });
        }

        // Utility Functions
        function showNotification(message, type = 'success') {
            const notification = document.createElement('div');
            notification.classList.add('fixed', 'bottom-4', 'left-1/2', 'transform', '-translate-x-1/2', 'z-50', 'px-4', 'py-2', 'rounded-lg', 'text-white', 'text-sm', 'font-medium', 'animate-zoom-in');
            notification.classList.add(type === 'success' ? 'bg-green-500' : 'bg-red-500');
            notification.textContent = message;
            document.body.appendChild(notification);
            setTimeout(() => notification.remove(), 3000);
        }

        function debounce(func, wait) {
            let timeout;
            return function executedFunction(...args) {
                const later = () => {
                    clearTimeout(timeout);
                    func(...args);
                };
                clearTimeout(timeout);
                timeout = setTimeout(later, wait);
            };
        }

        function checkout() {
            const dateInput = document.querySelector('input[type="date"]');
            const timeInput = document.querySelector('input[type="time"]');
            const addressInput = document.querySelector('input[data-address]');
            const phoneInput = document.querySelector('input[type="tel"]');

            if (!dateInput.value || !timeInput.value || !addressInput.value || !phoneInput.value) {
                showNotification('Заполните все поля', 'error');
                return;
            }

            const phoneRegex = /^\+?\d{10,12}$/;
            if (!phoneRegex.test(phoneInput.value)) {
                showNotification('Некорректный номер телефона', 'error');
                return;
            }

            if (!Array.isArray(appState.cart)) {
                console.error('appState.cart is not an array:', appState.cart);
                showNotification('Ошибка корзины: данные повреждены', 'error');
                appState.cart = [];
                localStorage.setItem('cart', JSON.stringify(appState.cart));
                renderCart();
                return;
            }

            if (appState.cart.length === 0) {
                showNotification('Корзина пуста', 'error');
                return;
            }

            const totalAmount = appState.cart.reduce((sum, item) => sum + item.price * item.quantity, 0);
            const deliveryFee = totalAmount >= 2000 ? 0 : 300;
            const finalAmount = totalAmount + deliveryFee;

            const telegram = window.Telegram?.WebApp;
            const user = telegram?.initDataUnsafe?.user || {};
            const orderData = {
                event: 'order_submit',
                user_id: user.id || 'unknown',
                username: user.username || '',
                first_name: user.first_name || '',
                last_name: user.last_name || '',
                timestamp: new Date().toISOString(),
                url: window.location.href,
                userAgent: navigator.userAgent,
                additional: {
                    order_id: `ORDER_${Date.now()}_${Math.random().toString(36).substr(2, 9)}`,
                    order_details: appState.cart.map(item => ({
                        id: item.id,
                        name: item.name,
                        price: item.price,
                        quantity: item.quantity
                    })),
                    total_amount: totalAmount,
                    delivery_fee: deliveryFee,
                    final_amount: finalAmount,
                    date: dateInput.value,
                    time: timeInput.value,
                    address: addressInput.value,
                    phone: phoneInput.value
                }
            };

            fetch('https://script.google.com/macros/s/AKfycb6xRK9c-nnKCBM4AypS_cP4FlYWkowU4fBRiwFHbHYBcWNREHuy25nx1JvUVatPtVk1BzU_Mw/exec', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify(orderData),
                mode: 'no-cors'
            })
                .then(() => {
                    showNotification('Заказ оформлен! Мы свяжемся с вами скоро.', 'success');
                    clearCart();
                    closeCart();
                })
                .catch(error => {
                    console.error('Error sending order:', error);
                    showNotification('Ошибка при отправке заказа', 'error');
                });
        }

        // Detail Page Functions
        let detailQuantity = 1;

        function changeDetailQuantity(change) {
            detailQuantity = Math.max(1, detailQuantity + change);
            document.getElementById('detail-quantity').textContent = detailQuantity;
            if (appState.selectedProduct) {
                const totalPrice = appState.selectedProduct.price * detailQuantity;
                document.getElementById('detail-total-price').textContent = totalPrice;
            }
        }

        function addToCartFromDetail() {
            if (appState.selectedProduct) {
                addToCartById(appState.selectedProduct.id, detailQuantity);
                closeProductDetail();
            }
        }

        function toggleIngredients() {
            const list = document.getElementById('ingredients-list');
            const chevron = document.getElementById('ingredients-chevron');
            list.classList.toggle('hidden');
            chevron.classList.toggle('rotate-180');
        }

        // Initialize App
        function init() {
            const savedCart = localStorage.getItem('cart');
            if (savedCart) {
                try {
                    const parsedCart = JSON.parse(savedCart);
                    if (Array.isArray(parsedCart)) {
                        appState.cart = parsedCart;
                    } else {
                        console.error('Invalid cart data in localStorage:', parsedCart);
                        localStorage.setItem('cart', JSON.stringify([]));
                    }
                } catch (error) {
                    console.error('Error parsing cart from localStorage:', error);
                    localStorage.setItem('cart', JSON.stringify([]));
                }
            }
            initEventListeners();
            renderProducts();
            updateCartBadge();
        }

        document.addEventListener('DOMContentLoaded', init);
    </script>
</body>
</html>
