<!DOCTYPE html>
<html lang="ru">
<head>
  <meta charset="utf-8"/>
  <meta name="viewport" content="width=device-width,initial-scale=1,maximum-scale=1,user-scalable=no"/>
  <title>Little Sweet Goose — editable fillings</title>
  <script src="https://cdn.tailwindcss.com"></script>
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.15.4/css/all.min.css">
  <link href="https://unpkg.com/aos@2.3.1/dist/aos.css" rel="stylesheet">
  <style>
    body{font-family:-apple-system, blinkmacsystemfont, 'segoe ui', roboto, sans-serif; margin:0; background:#f3f4f6;}
    .header-elements{position:fixed;top:0;left:0;right:0;z-index:40;padding:16px;display:flex;align-items:center;justify-content:space-between;background:#fff;box-shadow:0 2px 4px rgba(0,0,0,.1)}
    .product-image-carousel{position:relative;width:100%;height:288px;overflow:hidden;border-radius:12px;background:#e5e7eb;margin-bottom:16px}
    .product-image-carousel img{width:100%;height:100%;object-fit:cover;position:absolute;top:0;left:0;opacity:0;transition:opacity .38s ease,transform .38s ease}
    .product-image-carousel img.active{opacity:1;z-index:1;transform:translateX(0)}
    .product-image-dots{position:absolute;bottom:8px;left:50%;transform:translateX(-50%);display:flex;gap:5px;z-index:2}
    .product-image-dots .dot{width:6px;height:6px;border-radius:50%;background:rgba(255,255,255,.5)}
    .product-image-dots .dot.active{background:#fff}

    /* filling image container + editable image */
    .filling-image-container{aspect-ratio:4/3;max-height:140px;overflow:hidden;display:flex;justify-content:center;align-items:center;position:relative;background:#fff;border-radius:8px}
    /* actual filling image — we'll use transform translate(x%, y%) to shift */
    .filling-image{display:block;max-width:85%;max-height:88px;object-fit:contain;border-radius:8px;cursor:grab;transition:transform .12s linear}
    .filling-image:active{cursor:grabbing}

    /* sliders row */
    .filling-controls{display:flex;gap:8px;align-items:center;margin-top:8px}
    .filling-controls label{font-size:12px;color:#374151}

    /* cart and checkout */
    .cart-modal,.product-detail{height:100dvh;max-height:100dvh;overflow-y:auto}
    .input-field{width:100%;box-sizing:border-box;transition:border-color .2s}
    .input-field:focus{border-color:#db2777;outline:none}

    .quantity-btn{display:flex;align-items:center;justify-content:center;width:32px;height:32px;border-radius:50%;background:#f3f4f6}
    .hot-badge{position:absolute;top:8px;left:8px;background:#dc2626;color:#fff;padding:4px 8px;border-radius:12px;font-size:10px;font-weight:700}
    .btn-primary{transition:all .18s ease;box-shadow:0 2px 6px rgba(0,0,0,.08)}
    #checkout-modal{position:fixed;left:0;right:0;bottom:0;z-index:60;transform:translateY(110%);transition:transform .28s ease;background:#fff;border-top-left-radius:12px;border-top-right-radius:12px;max-height:85vh;overflow:auto}
    #checkout-modal.open{transform:translateY(0)}
    .cart-list{max-height:calc(100vh - 220px);overflow:auto;padding:1rem}
  </style>
</head>
<body class="bg-gray-100">

  <div class="header-elements">
    <div class="flex items-center gap-3">
      <button id="cart-btn" class="p-2 hover:bg-gray-100 rounded-full">
        <svg class="w-7 h-7" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M3 3h2l.4 2M7 13h10l4-8H5.4M7 13L5.4 5M7 13l-2.293 2.293c-.63.63-.184 1.707.707 1.707H17m0 0a2 2 0 100 4 2 2 0 000-4zm-8 2a2 2 0 11-4 0 2 2 0 014 0z"/></svg>
        <span id="cart-badge" class="hidden absolute -top-1 -right-1 bg-pink-600 text-white text-xs rounded-full w-5 h-5 flex items-center justify-center">0</span>
      </button>
      <h1 class="text-xl font-bold">Little Sweet Goose</h1>
    </div>
    <div class="flex items-center gap-3">
      <a href="#" class="text-gray-500"><i class="fab fa-telegram-plane"></i></a>
      <a href="#" class="text-gray-500"><i class="fab fa-instagram"></i></a>
    </div>
  </div>

  <main class="pt-24 pb-20 px-4 max-w-7xl mx-auto relative">
    <div class="flex items-center justify-between my-5">
      <h2 class="text-xl font-bold text-gray-800">Товары</h2>
      <span id="products-count" class="text-sm text-gray-600">0 товаров</span>
    </div>
    <div id="products-grid" class="grid grid-cols-2 gap-4 md:grid-cols-3 lg:grid-cols-4 mb-10"></div>
  </main>

  <!-- cart modal -->
  <div id="cart-modal" class="fixed inset-0 bg-white z-50 transform translate-y-full transition-transform duration-300">
    <div class="flex flex-col h-full">
      <div class="flex items-center justify-between p-4 border-b bg-white shadow-sm sticky top-0">
        <button id="cart-back-btn"><svg class="w-7 h-7" viewBox="0 0 24 24" fill="none" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 19l-7-7 7-7"/></svg></button>
        <h2 class="text-xl font-bold">Корзина</h2>
        <button id="cart-close-btn"><svg class="w-7 h-7" viewBox="0 0 24 24" fill="none" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"/></svg></button>
      </div>
      <div id="cart-content" class="flex-grow flex flex-col"></div>
    </div>
  </div>

  <!-- product detail -->
  <div id="product-detail" class="fixed inset-0 bg-white z-50 transform translate-y-full transition-transform duration-300">
    <div class="flex flex-col h-full">
      <div class="flex items-center justify-between p-4 border-b bg-white shadow-sm sticky top-0">
        <button id="detail-back-btn"><svg class="w-7 h-7" viewBox="0 0 24 24" fill="none" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 19l-7-7 7-7"/></svg></button>
        <h2 id="detail-title" class="text-xl font-bold"></h2>
        <button id="detail-close-btn"><svg class="w-7 h-7" viewBox="0 0 24 24" fill="none" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"/></svg></button>
      </div>
      <div id="detail-content" class="flex-1 overflow-auto p-4"></div>
    </div>
  </div>

  <!-- checkout modal -->
  <div id="checkout-modal" aria-hidden="true">
    <div class="p-4 border-b flex items-start gap-3">
      <div class="flex-1">
        <h3 class="text-lg font-bold">Оформление заказа</h3>
        <p class="text-sm text-gray-600">Самовывоз: <strong>Алексеева 43</strong></p>
      </div>
      <button id="checkout-close" class="text-gray-500"><svg class="w-6 h-6" viewBox="0 0 24 24" fill="none" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"/></svg></button>
    </div>
    <div class="p-4 space-y-4">
      <div class="grid grid-cols-1 gap-3">
        <label class="text-sm font-semibold">Дата самовывоза</label>
        <input id="checkout-date" type="date" class="input-field border rounded-lg p-3 text-sm w-full" min="" required>
        <label class="text-sm font-semibold">Время</label>
        <input id="checkout-time" type="time" class="input-field border rounded-lg p-3 text-sm w-full" min="09:00" max="21:00" required>
        <label class="text-sm font-semibold">Телефон для связи</label>
        <input id="checkout-phone" type="tel" placeholder="+7 (999) 123-45-67" class="input-field border rounded-lg p-3 text-sm w-full" required>
      </div>

      <div class="flex items-center justify-between font-bold text-base text-gray-800 pt-3 border-t">
        <span>Итого</span><span id="checkout-total" class="text-pink-600">0 ₽</span>
      </div>

      <div class="space-y-2">
        <button id="place-order-btn" class="btn-primary w-full h-12 bg-pink-600 text-white rounded-lg text-base font-semibold flex items-center justify-center gap-2 shadow-md">Оформить заказ</button>
        <button id="checkout-back-btn" class="w-full h-12 border rounded-lg text-base">Вернуться к корзине</button>
      </div>
    </div>
  </div>

  <script src="https://unpkg.com/aos@2.3.1/dist/aos.js"></script>
  <script>
    AOS.init({duration:800,once:true,offset:100});
    const appState = {
      cart: [],
      selectedProduct: null,
      selectedSize: 'S',
      selectedFilling: null,
      productImageIndex: 0,
      detailQuantity: 1,
      // хранит смещения: { [productId]: { [fillingName]: {x:0,y:0} } }
      fillingOffsets: {}
    };

    // products + added fillings per your list
    const products = [
      { id:'1', name:'Бенто-торт', description:'Компактный торт...', price:1400,
        sizes:[{size:'S',diameter:'10 см',weight:'450-550 г',price:1400},{size:'M',diameter:'12 см',weight:'850-950 г',price:2250},{size:'L',diameter:'14 см',weight:'1.2-1.3 кг',price:2750}],
        fillings:[
          {name:'Маковый лимон с клубникой', image:'https://i.postimg.cc/2S7kFCFG/image.webp'},
          {name:'Тропики манго-маракуйя', image:'https://i.postimg.cc/nzCnJB8S/image.webp'},
          {name:'Пломбир малина-апельсин', image:'https://i.postimg.cc/Kj6VCgFT/image.webp'},
          {name:'Медовик', image:'https://i.postimg.cc/2S7kFCFG/image.webp'},
          {name:'Шоколадно-кофейный с крошкой Орео', image:'https://i.postimg.cc/nzCnJB8S/image.webp'},
          {name:'Три шоколада', image:'https://i.postimg.cc/2S7kFCFG/image.webp'},
          {name:'Морковный', image:'https://i.postimg.cc/nzCnJB8S/image.webp'},
          {name:'Ореховый со сгущёнкой', image:'https://i.postimg.cc/Kj6VCgFT/image.webp'}
        ],
        images:['https://i.postimg.cc/Wznctb7p/photo-2024-11-25-07-51-57.jpg'], cartImage:'https://i.postimg.cc/Wznctb7p/photo-2024-11-25-07-51-57.jpg', category:'bento'
      },
      { id:'2', name:'Моти', description:'Нежные японские рисовые пирожные', price:100,
        fillings:[
          {name:'смородина', image:'https://i.postimg.cc/kXVgzs0r/photo-2024-11-25-07-59-12.jpg'},
          {name:'банан', image:'https://i.postimg.cc/bwkNNJY3/photo-2024-11-25-07-59-11.jpg'},
          {name:'апельсиновый мокко', image:'https://i.postimg.cc/Kj6VCgFT/image.webp'},
          {name:'баунти', image:'https://i.postimg.cc/nzCnJB8S/image.webp'},
          {name:'медовик', image:'https://i.postimg.cc/2S7kFCFG/image.webp'}
        ],
        images:['https://i.postimg.cc/kXVgzs0r/photo-2024-11-25-07-59-12.jpg'], cartImage:'https://i.postimg.cc/kXVgzs0r/photo-2024-11-25-07-59-12.jpg', category:'mochi'
      },
      { id:'3', name:'Картошка', description:'Классическое пирожное', price:120,
        images:['https://i.postimg.cc/yxGYW3Sr/photo-2024-11-25-08-45-29.jpg'], cartImage:'https://i.postimg.cc/yxGYW3Sr/photo-2024-11-25-08-45-29.jpg', category:'kartoshka'
      },
      { id:'4', name:'Трюфели', description:'Шоколадные трюфели ручной работы', price:150,
        fillings:[
          {name:'Апельсиновый', image:'https://i.postimg.cc/qR9Z0t66/photo-2025-04-25-20-09-35.jpg'},
          {name:'Лимонный', image:'https://i.postimg.cc/xCkFWG8S/photo-2025-04-25-20-09-36.jpg'},
          {name:'Фисташковый', image:'https://i.postimg.cc/tgvMSvX5/photo-2025-04-25-20-09-38.jpg'},
          {name:'малиновый', image:'https://i.postimg.cc/7h3T2VwQ/photo-2024-12-09-17-53-44.jpg'},
          {name:'Ореховый', image:'https://i.postimg.cc/Kj6VCgFT/image.webp'}
        ],
        images:['https://i.postimg.cc/qR9Z0t66/photo-2025-04-25-20-09-35.jpg'], cartImage:'https://i.postimg.cc/qR9Z0t66/photo-2025-04-25-20-09-35.jpg', category:'truffles'
      },
      { id:'5', name:'Мадлен', description:'Нежные французские бисквитные печенья', price:80,
        fillings:[
          {name:'Красный бархат с малиной', image:'https://via.placeholder.com/300?text=Red+Velvet'},
          {name:'Шоколад-кофе-апельсин', image:'https://via.placeholder.com/300?text=Choco+Coffee+Orange'},
          {name:'Фисташка-малина', image:'https://via.placeholder.com/300?text=Pistachio+Raspberry'},
          {name:'Маковый лимон', image:'https://via.placeholder.com/300?text=Poppy+Lemon'}
        ],
        images:['https://via.placeholder.com/150?text=Madeleine1'], cartImage:'https://via.placeholder.com/150?text=Madeleine1', category:'madeleine'
      }
    ];

    // elements
    const els = {
      productsGrid: document.getElementById('products-grid'),
      productsCount: document.getElementById('products-count'),
      detailContent: document.getElementById('detail-content'),
      detailTitle: document.getElementById('detail-title'),
      productDetail: document.getElementById('product-detail'),
      cartBtn: document.getElementById('cart-btn'),
      cartModal: document.getElementById('cart-modal'),
      cartContent: document.getElementById('cart-content'),
      cartBadge: document.getElementById('cart-badge'),
      cartCloseBtn: document.getElementById('cart-close-btn'),
      cartBackBtn: document.getElementById('cart-back-btn'),
      checkoutModal: document.getElementById('checkout-modal'),
      checkoutDate: document.getElementById('checkout-date'),
      checkoutTime: document.getElementById('checkout-time'),
      checkoutPhone: document.getElementById('checkout-phone'),
      checkoutTotal: document.getElementById('checkout-total'),
      placeOrderBtn: document.getElementById('place-order-btn'),
      checkoutClose: document.getElementById('checkout-close'),
      checkoutBackBtn: document.getElementById('checkout-back-btn')
    };

    // utils
    function showNotification(msg,type='success'){const n=document.createElement('div');n.className=`fixed bottom-4 left-1/2 -translate-x-1/2 z-50 px-5 py-3 rounded-lg text-white font-semibold ${type==='success'?'bg-green-500':'bg-red-500'}`;n.textContent=msg;document.body.appendChild(n);setTimeout(()=>n.remove(),3500);}
    function getMinOrderDate(){const d=new Date();d.setDate(d.getDate()+1);return d.toISOString().split('T')[0];}

    // init
    function init(){
      renderProducts();
      initEvents();
      // load cart from localStorage if exists
      try{const s=localStorage.getItem('cart');if(s)appState.cart=JSON.parse(s);}catch(e){}
      updateCartBadge();
    }

    function renderProducts(){
      els.productsCount.textContent = `${products.length} товаров`;
      els.productsGrid.innerHTML = products.map(productCardHtml).join('');
    }

    function productCardHtml(p){
      const price = p.sizes ? p.sizes.find(s=>s.size==='S').price : p.price;
      return `
        <div class="product-card bg-white rounded-lg shadow-sm flex flex-col relative cursor-pointer" data-id="${p.id}">
          <div class="relative h-36 bg-gray-200 rounded-t-lg overflow-hidden">
            <img src="${p.cartImage||p.images[0]||''}" class="w-full h-full object-cover" />
            ${p.isHot?'<div class="hot-badge">HOT</div>':''}
          </div>
          <div class="p-4 flex flex-col flex-grow">
            <h3 class="font-semibold text-base mb-1">${p.name}</h3>
            <p class="text-sm text-gray-600 line-clamp-2 mb-2 h-10">${p.description||''}</p>
            <div class="mt-auto">
              <div class="font-bold text-pink-600">${price} ₽</div>
            </div>
          </div>
        </div>
      `;
    }

    function initEvents(){
      // product click using delegation
      els.productsGrid.addEventListener('click', (e)=>{
        const card = e.target.closest('.product-card');
        if(!card) return;
        const id = card.dataset.id;
        openProductDetailById(id);
      });

      document.getElementById('detail-close-btn').addEventListener('click', ()=>{closeProductDetail();});
      document.getElementById('detail-back-btn').addEventListener('click', ()=>{closeProductDetail();});
      els.cartBtn.addEventListener('click', openCart);
      els.cartCloseBtn.addEventListener('click', closeCart);
      els.cartBackBtn.addEventListener('click', closeCart);
      els.checkoutClose.addEventListener('click', closeCheckout);
      els.checkoutBackBtn.addEventListener('click', closeCheckout);
      els.placeOrderBtn.addEventListener('click', placeOrderFromCheckout);

      // cart open/close handled in renderCart
    }

    /* CART functions (kept minimal) */
    function saveCart(){ try{ localStorage.setItem('cart', JSON.stringify(appState.cart)); }catch(e){} }
    function updateCartBadge(){ const total = appState.cart.reduce((s,i)=>s+(i.quantity||0),0); els.cartBadge.textContent = total; els.cartBadge.classList.toggle('hidden', total===0); }
    function addToCart(productId, quantity=1){
      const p = products.find(x=>x.id===productId); if(!p) return;
      const selSize = p.sizes ? appState.selectedSize || 'S' : null;
      const selFilling = p.fillings ? appState.selectedFilling || (p.fillings[0] && p.fillings[0].name) : null;
      const exist = appState.cart.find(it => String(it.id)===String(productId) && (it.selectedSize||'')=== (selSize||'') && (it.selectedFilling||'') === (selFilling||''));
      if(exist) exist.quantity += quantity; else appState.cart.push({...p,quantity,selectedSize:selSize,selectedFilling:selFilling});
      saveCart(); updateCartBadge(); showNotification(`${p.name} добавлен(ы) в корзину`);
    }

    function openCart(){
      els.cartModal.style.transform = 'translateY(0)'; renderCart();
    }
    function closeCart(){ els.cartModal.style.transform = 'translateY(100%)'; }

    function renderCart(){
      const c = appState.cart;
      if(c.length===0){
        els.cartContent.innerHTML = `<div class="flex-1 flex flex-col items-center justify-center p-6"><p class="text-xl font-semibold">Корзина пуста</p><p class="text-sm text-gray-600">Добавьте вкусные десерты</p><button onclick="closeCart()" class="btn-primary mt-4 bg-pink-600 text-white rounded-lg p-3">Продолжить покупки</button></div>`;
        return;
      }
      const total = c.reduce((s,i)=>{
        const prod = products.find(p=>p.id===i.id); const size = prod && prod.sizes ? prod.sizes.find(s=>s.size===i.selectedSize) : null; const price = size?size.price:i.price;
        return s + price * i.quantity;
      },0);

      els.cartContent.innerHTML = `
        <div class="cart-list">
          ${c.map(item=>{
            const prod = products.find(p=>p.id===item.id) || {};
            const size = prod.sizes ? prod.sizes.find(s=>s.size===item.selectedSize) : null;
            const price = size ? size.price : item.price;
            const fillingText = item.selectedFilling ? `, ${item.selectedFilling}` : '';
            return `<div class="flex gap-4 bg-white p-4 rounded-lg shadow-sm mb-3">
              <img src="${item.cartImage||''}" class="w-20 h-20 object-cover rounded-lg flex-shrink-0"/>
              <div class="flex-1 min-w-0">
                <div class="font-semibold">${item.name}${item.selectedSize?` (${item.selectedSize}${fillingText})`:''}</div>
                <div class="text-pink-600 font-semibold">${price} ₽ × ${item.quantity} = ${price*item.quantity} ₽</div>
                <div class="flex items-center justify-between mt-2">
                  <div class="flex items-center gap-3">
                    <button class="quantity-btn" onclick="updateCartQuantity('${item.id}', ${item.quantity-1}, '${item.selectedSize||''}', '${item.selectedFilling||''}')">-</button>
                    <div class="w-8 text-center font-semibold">${item.quantity}</div>
                    <button class="quantity-btn" onclick="updateCartQuantity('${item.id}', ${item.quantity+1}, '${item.selectedSize||''}', '${item.selectedFilling||''}')">+</button>
                  </div>
                  <button onclick="removeFromCart('${item.id}','${item.selectedSize||''}','${item.selectedFilling||''}')" class="text-red-500">Удалить</button>
                </div>
              </div>
            </div>`;
          }).join('')}
        </div>
        <div class="border-t p-4 sticky bottom-0 bg-white">
          <div class="flex justify-between items-center mb-3">
            <div>Товаров: <strong>${c.length}</strong></div>
            <div class="text-lg font-bold text-pink-600">${total} ₽</div>
          </div>
          <div class="grid grid-cols-2 gap-3">
            <button id="checkout-open-btn" class="col-span-2 bg-pink-600 text-white h-12 rounded-lg">Перейти к оформлению</button>
            <button onclick="clearCart()" class="h-12 border rounded-lg">Очистить</button>
            <button onclick="closeCart()" class="h-12 border rounded-lg">Продолжить покупки</button>
          </div>
        </div>
      `;
      const checkoutBtn = document.getElementById('checkout-open-btn');
      if(checkoutBtn) checkoutBtn.addEventListener('click', openCheckout);
    }

    function updateCartQuantity(productId,newQ,size,filling){
      const idx = appState.cart.findIndex(i=>String(i.id)===String(productId)&& (i.selectedSize||'')===(size||'') && (i.selectedFilling||'')===(filling||''));
      if(idx===-1) return;
      if(newQ<=0){ removeFromCart(productId,size,filling); return; }
      appState.cart[idx].quantity = newQ; saveCart(); renderCart(); updateCartBadge();
    }
    function removeFromCart(productId,size,filling){
      appState.cart = appState.cart.filter(i=> !(String(i.id)===String(productId) && (i.selectedSize||'')===(size||'') && (i.selectedFilling||'')===(filling||'')));
      saveCart(); renderCart(); updateCartBadge();
    }
    function clearCart(){ appState.cart=[]; saveCart(); renderCart(); updateCartBadge(); }

    /* PRODUCT DETAIL + filling controls */
    function openProductDetailById(productId){
      const p = products.find(x=>x.id===productId); if(!p) return;
      appState.selectedProduct = p;
      appState.selectedSize = p.sizes ? 'S' : null;
      appState.selectedFilling = p.fillings && p.fillings[0] ? p.fillings[0].name : null;
      appState.detailQuantity = 1;
      // init filling offsets structure
      if(!appState.fillingOffsets[productId]) appState.fillingOffsets[productId] = {};
      els.detailTitle.textContent = p.name;
      els.productDetail.style.transform = 'translateY(0)';
      renderProductDetail();
    }

    function closeProductDetail(){ els.productDetail.style.transform = 'translateY(100%)'; }

    function renderProductDetail(){
      const p = appState.selectedProduct; if(!p) return;
      const size = p.sizes ? p.sizes.find(s=>s.size===appState.selectedSize) : null;
      const price = size ? size.price : p.price;
      // build fillings UI if exists
      const fillingsHtml = p.fillings ? `
        <div class="space-y-2">
          <h3 class="font-semibold text-base">Начинка</h3>
          <div class="grid grid-cols-2 gap-3">
            ${p.fillings.map(f=>`<button class="filling-btn p-3 rounded-lg border text-center ${appState.selectedFilling===f.name?'bg-pink-50 border-pink-300':''}" data-filling="${escapeHtml(f.name)}">${escapeHtml(f.name)}</button>`).join('')}
          </div>
          <div class="mt-2">
            <div class="filling-image-container">
              <img id="filling-image" src="${(p.fillings.find(f=>f.name===appState.selectedFilling)||p.fillings[0]).image}" alt="Начинка" class="filling-image" draggable="false">
            </div>
            <div class="filling-controls">
              <div>
                <label class="block text-xs text-gray-600">Сдвиг X</label>
                <input id="filling-offset-x" type="range" min="-50" max="50" value="0" style="width:220px">
              </div>
              <div>
                <label class="block text-xs text-gray-600">Сдвиг Y</label>
                <input id="filling-offset-y" type="range" min="-50" max="50" value="0" style="width:220px">
              </div>
              <div class="flex items-end">
                <button id="filling-reset" class="border rounded px-3 py-1 text-sm">Сбросить</button>
              </div>
            </div>
          </div>
        </div>
      ` : '';

      els.detailContent.innerHTML = `
        <div class="product-image-carousel">
          ${ (p.images||[]).map((img,i)=>`<img src="${img}" class="${i===0?'active':''}">`).join('') }
          <div class="product-image-dots">
            ${ (p.images||[]).map((_,i)=>`<div class="dot ${i===0?'active':''}"></div>`).join('') }
          </div>
        </div>

        <div class="space-y-4">
          <h1 class="text-xl font-bold">${p.name}</h1>
          ${p.sizes ? `<div><h3 class="font-semibold">Размер</h3><div class="grid grid-cols-3 gap-3">${p.sizes.map(s=>`<button class="size-btn p-3 border rounded ${appState.selectedSize===s.size?'bg-pink-50 border-pink-300':''}" data-size="${s.size}">${s.size} (${s.diameter})<div class="text-xs text-gray-600">${s.weight} / ${s.price} ₽</div></button>`).join('')}</div></div>` : ''}
          ${fillingsHtml}
          <p class="text-gray-600 text-sm">${p.description||''}</p>

          <div class="space-y-3 pt-3">
            <div class="flex items-center justify-center gap-4">
              <button id="detail-qty-dec" class="quantity-btn">-</button>
              <span id="detail-quantity" class="font-semibold text-lg">${appState.detailQuantity||1}</span>
              <button id="detail-qty-inc" class="quantity-btn">+</button>
            </div>
            <button id="add-to-cart-detail" class="btn-primary w-full h-12 bg-pink-600 text-white rounded-lg">${price} ₽ — Добавить</button>
          </div>
        </div>
      `;

      // set up event listeners: sizes, fillings, qty, add to cart
      // sizes
      const sizeBtns = els.detailContent.querySelectorAll('.size-btn');
      sizeBtns.forEach(btn=>btn.addEventListener('click', (e)=>{
        const s = btn.dataset.size; appState.selectedSize = s; renderProductDetail();
      }));

      // fillings
      const fillingBtns = els.detailContent.querySelectorAll('.filling-btn');
      fillingBtns.forEach(btn=>btn.addEventListener('click', (e)=>{
        const f = btn.dataset.filling;
        appState.selectedFilling = f;
        // ensure offsets bucket exists
        if(!appState.fillingOffsets[appState.selectedProduct.id]) appState.fillingOffsets[appState.selectedProduct.id]={};
        if(!appState.fillingOffsets[appState.selectedProduct.id][f]) appState.fillingOffsets[appState.selectedProduct.id][f] = {x:0,y:0};
        // update image src and sliders
        const imgEl = document.getElementById('filling-image');
        const fObj = appState.selectedProduct.fillings.find(x=>x.name===f);
        if(fObj) imgEl.src = fObj.image;
        // update slider values to stored offsets
        const offsets = appState.fillingOffsets[appState.selectedProduct.id][f] || {x:0,y:0};
        const sx = document.getElementById('filling-offset-x'), sy = document.getElementById('filling-offset-y');
        if(sx && sy){ sx.value = offsets.x; sy.value = offsets.y; applyFillingTransform(offsets.x, offsets.y); }
        // refresh active states
        renderProductDetail(); // re-render will keep selection and rebuild controls
      }));

      // quantity controls
      document.getElementById('detail-qty-dec').addEventListener('click', ()=>{ changeDetailQuantity(-1); });
      document.getElementById('detail-qty-inc').addEventListener('click', ()=>{ changeDetailQuantity(1); });

      // add to cart
      document.getElementById('add-to-cart-detail').addEventListener('click', ()=>{
        addToCart(appState.selectedProduct.id, appState.detailQuantity || 1);
        closeProductDetail();
      });

      // start product image carousel swipe (simple)
      startProductImageCarouselInDetail();

      // filling controls behavior
      const fImg = document.getElementById('filling-image');
      const sx = document.getElementById('filling-offset-x');
      const sy = document.getElementById('filling-offset-y');
      const resetBtn = document.getElementById('filling-reset');

      // initialize offsets default
      if(!appState.fillingOffsets[appState.selectedProduct.id]) appState.fillingOffsets[appState.selectedProduct.id] = {};
      if(appState.selectedFilling && !appState.fillingOffsets[appState.selectedProduct.id][appState.selectedFilling]) appState.fillingOffsets[appState.selectedProduct.id][appState.selectedFilling] = {x:0,y:0};

      // apply current offsets
      if(sx && sy){
        const cur = appState.fillingOffsets[appState.selectedProduct.id][appState.selectedFilling] || {x:0,y:0};
        sx.value = cur.x; sy.value = cur.y; applyFillingTransform(cur.x, cur.y);
        sx.addEventListener('input', ()=>{ const x = Number(sx.value), y = Number(sy.value); storeFillingOffset(appState.selectedProduct.id, appState.selectedFilling, x, y); applyFillingTransform(x,y); });
        sy.addEventListener('input', ()=>{ const x = Number(sx.value), y = Number(sy.value); storeFillingOffset(appState.selectedProduct.id, appState.selectedFilling, x, y); applyFillingTransform(x,y); });
      }
      if(resetBtn){ resetBtn.addEventListener('click', ()=>{ if(appState.selectedFilling) storeFillingOffset(appState.selectedProduct.id, appState.selectedFilling, 0, 0); if(sx && sy){ sx.value=0; sy.value=0; } applyFillingTransform(0,0); }); }

      // drag to move support
      if(fImg){
        let isDown=false, startX=0, startY=0, startOffset={x:0,y:0};
        fImg.addEventListener('mousedown', (e)=>{ e.preventDefault(); isDown=true; startX=e.clientX; startY=e.clientY; const cur = appState.fillingOffsets[appState.selectedProduct.id][appState.selectedFilling]||{x:0,y:0}; startOffset={...cur}; });
        window.addEventListener('mouseup', ()=>{ if(isDown) isDown=false; });
        window.addEventListener('mousemove', (e)=>{ if(!isDown) return; const dx = e.clientX - startX; const dy = e.clientY - startY; // convert pixels to percents relative to container width/height
          const cont = document.querySelector('.filling-image-container'); if(!cont) return;
          const w = cont.clientWidth || 200, h = cont.clientHeight || 100;
          const nx = Math.round(startOffset.x + (dx / w) * 100); const ny = Math.round(startOffset.y + (dy / h) * 100);
          storeFillingOffset(appState.selectedProduct.id, appState.selectedFilling, nx, ny);
          if(document.getElementById('filling-offset-x')) document.getElementById('filling-offset-x').value = nx;
          if(document.getElementById('filling-offset-y')) document.getElementById('filling-offset-y').value = ny;
          applyFillingTransform(nx, ny);
        });
        // touch support
        fImg.addEventListener('touchstart', (e)=>{ const t=e.touches[0]; isDown=true; startX=t.clientX; startY=t.clientY; const cur = appState.fillingOffsets[appState.selectedProduct.id][appState.selectedFilling]||{x:0,y:0}; startOffset={...cur}; }, {passive:true});
        fImg.addEventListener('touchend', ()=>{ isDown=false; });
        fImg.addEventListener('touchmove', (e)=>{ if(!isDown) return; const t=e.touches[0]; const dx = t.clientX - startX; const dy = t.clientY - startY; const cont = document.querySelector('.filling-image-container'); if(!cont) return; const w = cont.clientWidth || 200, h = cont.clientHeight || 100; const nx = Math.round(startOffset.x + (dx / w) * 100); const ny = Math.round(startOffset.y + (dy / h) * 100); storeFillingOffset(appState.selectedProduct.id, appState.selectedFilling, nx, ny); if(document.getElementById('filling-offset-x')) document.getElementById('filling-offset-x').value = nx; if(document.getElementById('filling-offset-y')) document.getElementById('filling-offset-y').value = ny; applyFillingTransform(nx, ny); }, {passive:true});
      }
    }

    function applyFillingTransform(x=0,y=0){
      const img = document.getElementById('filling-image'); if(!img) return;
      // Use translate in percents: first translate to center, then offset
      img.style.transform = `translate(${x}%, ${y}%)`;
    }
    function storeFillingOffset(productId, fillingName, x, y){
      if(!appState.fillingOffsets[productId]) appState.fillingOffsets[productId]={};
      appState.fillingOffsets[productId][fillingName] = {x: Number(x)||0, y: Number(y)||0};
      // optionally persist in localStorage later
    }

    function startProductImageCarouselInDetail(){
      const carousel = document.querySelector('.product-image-carousel');
      if(!carousel) return;
      const imgs = Array.from(carousel.querySelectorAll('img'));
      const dots = Array.from(carousel.querySelectorAll('.dot'));
      let idx = 0;
      function show(i){ imgs.forEach((im,j)=>im.classList.toggle('active', j===i)); dots.forEach((d,j)=>d.classList.toggle('active', j===i)); idx=i; }
      dots.forEach((d,i)=>d.addEventListener('click', ()=>show(i)));
      // basic swipe
      let sx=0; carousel.addEventListener('touchstart', e=>{ sx=e.touches[0].clientX; });
      carousel.addEventListener('touchend', e=>{ const ex=e.changedTouches[0].clientX; const delta=sx-ex; if(Math.abs(delta)>40){ if(delta>0 && idx<imgs.length-1) show(idx+1); else if(delta<0 && idx>0) show(idx-1); }});
      show(0);
    }

    function changeDetailQuantity(delta){
      appState.detailQuantity = Math.max(1, (appState.detailQuantity||1) + delta);
      const el = document.getElementById('detail-quantity'); if(el) el.textContent = appState.detailQuantity;
    }

    // checkout simple handlers (kept as earlier)
    function openCheckout(){ els.checkoutDate.min = getMinOrderDate(); els.checkoutDate.value = getMinOrderDate(); updateCheckoutTotal(); els.checkoutModal.classList.add('open'); }
    function closeCheckout(){ els.checkoutModal.classList.remove('open'); }
    function updateCheckoutTotal(){ const t = appState.cart.reduce((s,i)=>{ const p=products.find(x=>x.id===i.id); const size = p && p.sizes ? p.sizes.find(s=>s.size===i.selectedSize) : null; const price = size?size.price:i.price; return s + price*i.quantity; },0); els.checkoutTotal.textContent = `${t} ₽`; }
    function placeOrderFromCheckout(){
      // minimal: validate fields and show success
      if(!els.checkoutDate.value || !els.checkoutTime.value || !els.checkoutPhone.value){ showNotification('Заполните все поля','error'); return; }
      if(appState.cart.length===0){ showNotification('Корзина пуста','error'); return; }
      // simulate send
      showNotification('Заказ отправлен — ждите подтверждение','success');
      appState.cart = []; saveCart(); updateCartBadge(); renderCart(); closeCheckout(); closeCart();
    }

    // helpers
    function escapeHtml(s){ return (s||'').replace(/&/g,'&amp;').replace(/</g,'&lt;').replace(/>/g,'&gt;').replace(/"/g,'&quot;'); }

    // expose addToCart for quick adding from product (if you want)
    window.addToCart = addToCart;

    document.addEventListener('DOMContentLoaded', init);
  </script>
</body>
</html>
