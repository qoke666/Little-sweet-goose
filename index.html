<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Кондитерская</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.15.4/css/all.min.css">
    <style>
        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
            overscroll-behavior: none;
            margin: 0;
            padding: 0;
            -webkit-tap-highlight-color: transparent;
            background-color: #f3f4f6;
        }
        .animate-zoom-in {
            animation: zoomIn 0.3s ease forwards;
        }
        .animate-fade-in {
            animation: fadeIn 0.3s ease forwards;
        }
        @keyframes zoomIn {
            from { transform: scale(0.8); opacity: 0; }
            to { transform: scale(1); opacity: 1; }
        }
        @keyframes fadeIn {
            from { opacity: 0; }
            to { opacity: 1; }
        }
        .category-pill {
            scroll-snap-align: start;
            flex-shrink: 0;
            min-width: 100px;
        }
        .carousel {
            display: flex;
            overflow-x: auto;
            white-space: nowrap;
            scroll-behavior: smooth;
            touch-action: pan-x;
            -webkit-overflow-scrolling: touch;
            scroll-snap-type: x mandatory;
            scrollbar-width: none;
            -ms-overflow-style: none;
        }
        .carousel::-webkit-scrollbar {
            display: none;
        }
        .reviews-carousel {
            display: flex;
            overflow-x: auto;
            white-space: nowrap;
            scroll-behavior: smooth;
            touch-action: pan-x;
            -webkit-overflow-scrolling: touch;
            scrollbar-width: none;
            -ms-overflow-style: none;
        }
        .reviews-carousel::-webkit-scrollbar {
            display: none;
        }
        .review-card {
            scroll-snap-align: start;
            flex: 0 0 280px;
            margin-right: 12px;
        }
        .cart-modal, .product-detail, .rating-modal {
            height: 100dvh;
            max-height: 100dvh;
            overflow-y: auto;
        }
        .input-field {
            width: 100%;
            box-sizing: border-box;
        }
        .quantity-btn svg {
            width: 16px;
            height: 16px;
        }
        .rating-star {
            color: #facc15;
        }
        .discount-badge {
            position: absolute;
            top: 8px;
            left: 8px;
            background: #dc2626;
            color: white;
            padding: 4px 8px;
            border-radius: 12px;
            font-size: 10px;
            font-weight: bold;
        }
        .social-links a {
            display: inline-flex;
            align-items: center;
            justify-content: center;
            width: 32px;
            height: 32px;
            border-radius: 50%;
            background-color: #ffffff;
            transition: background-color 0.2s;
        }
        .social-links a:hover {
            background-color: #e5e7eb;
        }
        .social-links i {
            font-size: 20px;
            color: #4b5563;
        }
        .header-elements {
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            z-index: 40;
            padding: 16px;
            display: flex;
            align-items: center;
            justify-content: space-between;
        }
        .size-btn.active {
            background-color: #fce7f3;
            border-color: #db2777;
        }
        .filling-btn.active {
            background-color: #fce7f3;
            border-color: #db2777;
        }
        .add-to-cart-btn {
            z-index: 10;
        }
        .filling-image-container {
            aspect-ratio: 4/3;
            max-height: 96px;
            overflow: hidden;
            display: flex;
            justify-content: center;
        }
        .star-rating button {
            font-size: 24px;
            cursor: pointer;
            background: none;
            border: none;
            color: #e5e7eb;
        }
        .star-rating button.active {
            color: #facc15;
        }
        @media (min-width: 768px) {
            .product-card {
                width: calc((100% - 3rem) / 3);
            }
            .products-grid {
                grid-template-columns: repeat(auto-fill, minmax(200px, 1fr));
            }
            .filling-image-container {
                max-height: 120px;
            }
            .review-card {
                flex: 0 0 320px;
            }
        }
        @media (min-width: 1024px) {
            .product-card {
                width: calc((100% - 4rem) / 4);
            }
        }
    </style>
</head>
<body class="bg-gray-100">
    <!-- Main Content -->
    <main class="pt-20 pb-20 px-4 max-w-7xl mx-auto relative">
        <!-- Header Elements -->
        <div class="header-elements">
            <div class="relative">
                <button id="cart-btn" class="p-2">
                    <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M3 3h2l.4 2M7 13h10l4-8H5.4M7 13L5.4 5M7 13l-2.293 2.293c-.63.63-.184 1.707.707 1.707H17m0 0a2 2 0 100 4 2 2 0 000-4zm-8 2a2 2 0 11-4 0 2 2 0 014 0z"/>
                    </svg>
                    <span id="cart-badge" class="absolute -top-1 -right-1 bg-pink-600 text-white text-xs rounded-full w-4 h-4 flex items-center justify-center hidden">0</span>
                </button>
            </div>
            <h1 class="text-lg font-semibold">Кондитерская</h1>
            <div class="social-links flex items-center gap-2">
                <a href="https://t.me/limitedclubcpa" target="_blank" class="social-link tg-link" data-social="telegram">
                    <i class="fab fa-telegram-plane"></i>
                </a>
                <a href="https://www.instagram.com/thelimitedclub.cpa?igsh=MXkwcXppMWtlZGtm" target="_blank" class="social-link" data-social="instagram">
                    <i class="fab fa-instagram"></i>
                </a>
            </div>
        </div>

        <!-- Promo Carousel -->
        <div id="promo-carousel" class="carousel flex overflow-x-auto gap-3 mb-6">
            <div class="flex-shrink-0 w-64 h-32 bg-gray-200 rounded-lg"></div>
            <div class="flex-shrink-0 w-64 h-32 bg-gray-200 rounded-lg"></div>
            <div class="flex-shrink-0 w-64 h-32 bg-gray-200 rounded-lg"></div>
        </div>

        <!-- Categories -->
        <div id="category-carousel" class="carousel flex gap-3 mb-6">
            <button class="category-pill px-4 py-2 bg-pink-100 text-pink-600 rounded-full font-medium text-sm active" data-category="all">Все</button>
            <button class="category-pill px-4 py-2 bg-gray-100 hover:bg-pink-100 rounded-full font-medium text-sm" data-category="bento">Бенто-торт</button>
            <button class="category-pill px-4 py-2 bg-gray-100 hover:bg-pink-100 rounded-full font-medium text-sm" data-category="mochi">Моти</button>
            <button class="category-pill px-4 py-2 bg-gray-100 hover:bg-pink-100 rounded-full font-medium text-sm" data-category="kartoshka">Картошка</button>
            <button class="category-pill px-4 py-2 bg-gray-100 hover:bg-pink-100 rounded-full font-medium text-sm" data-category="truffles">Трюфели</button>
            <button class="category-pill px-4 py-2 bg-gray-100 hover:bg-pink-100 rounded-full font-medium text-sm" data-category="madeleine">Мадлен</button>
        </div>

        <!-- New Products -->
        <div class="flex items-center justify-between mb-4">
            <h2 class="text-lg font-semibold">Новинки</h2>
            <span id="new-products-count" class="text-sm text-gray-600">0 товаров</span>
        </div>
        <div id="new-products-grid" class="grid grid-cols-2 gap-4 md:grid-cols-3 lg:grid-cols-4 mb-8"></div>

        <!-- Top Products -->
        <div class="flex items-center justify-between mb-4">
            <h2 class="text-lg font-semibold">Топ-позиции</h2>
            <span id="top-products-count" class="text-sm text-gray-600">0 товаров</span>
        </div>
        <div id="top-products-grid" class="grid grid-cols-2 gap-4 md:grid-cols-3 lg:grid-cols-4 mb-8"></div>

        <!-- Reviews -->
        <div class="mb-4">
            <h2 class="text-lg font-semibold">Отзывы</h2>
        </div>
        <div id="reviews-carousel" class="reviews-carousel flex overflow-x-auto gap-3">
            <!-- Reviews will be rendered here -->
        </div>
    </main>

    <!-- Cart Modal -->
    <div id="cart-modal" class="fixed inset-0 bg-white z-50 transform translate-y-full transition-transform">
        <div class="flex flex-col h-full">
            <div class="flex items-center justify-between p-4 border-b bg-white">
                <button id="cart-back-btn">
                    <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 19l-7-7 7-7"/>
                    </svg>
                </button>
                <h2 class="text-lg font-semibold">Корзина</h2>
                <div class="relative">
                    <span id="cart-total-badge" class="bg-pink-600 text-white text-xs rounded-full w-5 h-5 flex items-center justify-center hidden">0</span>
                    <button id="cart-close-btn">
                        <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"/>
                        </svg>
                    </button>
                </div>
            </div>
            <div id="cart-content" class="flex-1 overflow-auto"></div>
        </div>
    </div>

    <!-- Product Detail Modal -->
    <div id="product-detail" class="fixed inset-0 bg-white z-50 transform translate-y-full transition-transform">
        <div class="flex flex-col h-full">
            <div class="flex items-center justify-between p-4 border-b bg-white">
                <button id="detail-back-btn">
                    <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 19l-7-7 7-7"/>
                    </svg>
                </button>
                <h2 id="detail-title" class="text-lg font-semibold"></h2>
                <button id="detail-close-btn">
                    <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"/>
                    </svg>
                </button>
            </div>
            <div id="detail-content" class="flex-1 overflow-auto p-4">
                <div class="relative h-64 bg-gray-200 mb-4">
                    <img src="" alt="" class="w-full h-full object-cover rounded-lg">
                </div>
                <div class="space-y-3">
                    <div class="flex items-center gap-2">
                        <div class="flex items-center gap-1">
                            <svg class="rating-star w-4 h-4" fill="currentColor" viewBox="0 0 20 20">
                                <path d="M9.049 2.927c.3-.921 1.603-.921 1.902 0l1.07 3.292a1 1 0 00.95.69h3.462c.969 0 1.371 1.24.588 1.81l-2.8 2.034a1 1 0 00-.364 1.118l1.07 3.292c.3.921-.755 1.688-1.54 1.118l-2.8-2.034a1 1 0 00-1.175 0l-2.8 2.034c-.784.57-1.838-.197-1.539-1.118l1.07-3.292a1 1 0 00-.364-1.118L2.98 8.72c-.783-.57-.38-1.81.588-1.81h3.461a1 1 0 00.951-.69l1.07-3.292z"/>
                            </svg>
                            <span class="font-semibold text-sm"></span>
                        </div>
                        <span class="text-gray-600 text-xs"></span>
                    </div>
                    <h1 class="text-lg font-bold"></h1>
                    <div class="space-y-2">
                        <button class="flex items-center justify-between w-full py-2 text-left" onclick="toggleIngredients()">
                            <span class="font-semibold text-sm">Состав</span>
                            <svg id="ingredients-chevron" class="icon w-5 h-5 transition-transform" viewBox="0 0 24 24">
                                <path d="M19 9l-7 7-7-7"/>
                            </svg>
                        </button>
                        <div id="ingredients-list" class="space-y-1 hidden animate-fade-in">
                            ${appState.selectedProduct?.ingredients ? appState.selectedProduct.ingredients.map(ing => `
                                <div class="text-xs text-gray-600">• ${ing}</div>
                            `).join('') : '<div class="text-xs text-gray-600">Состав отсутствует</div>'}
                        </div>
                    </div>
                    <div class="flex items-center gap-3">
                        <div class="quantity-controls flex items-center gap-2">
                            <button class="quantity-btn p-1 bg-gray-100 rounded" onclick="updateDetailQuantity(-1)">
                                <svg class="icon" viewBox="0 0 24 24">
                                    <path d="M20 12H4"/>
                                </svg>
                            </button>
                            <span id="detail-quantity" class="w-8 text-center font-medium">1</span>
                            <button class="quantity-btn p-1 bg-gray-100 rounded" onclick="updateDetailQuantity(1)">
                                <svg class="icon" viewBox="0 0 24 24">
                                    <path d="M12 6v6m0 0v6m0-6h6m-6 0H6"/>
                                </svg>
                            </button>
                        </div>
                        <button onclick="addToCartById(appState.selectedProduct.id)" class="add-to-cart-btn flex-1 h-12 bg-pink-600 text-white rounded-lg text-sm font-semibold flex items-center justify-center gap-2">
                            <svg class="icon w-5 h-5" viewBox="0 0 24 24">
                                <path d="M3 3h2l.4 2M7 13h10l4-8H5.4M7 13L5.4 5M7 13l-2.293 2.293c-.63.63-.184 1.707.707 1.707H17m0 0a2 2 0 100 4 2 2 0 000-4zm-8 2a2 2 0 11-4 0 2 2 0 014 0z"/>
                            </svg>
                            Добавить в корзину
                        </button>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Rating Modal -->
    <div id="rating-modal" class="fixed inset-0 bg-white z-50 transform translate-y-full transition-transform">
        <div class="flex flex-col h-full">
            <div class="flex items-center justify-between p-4 border-b bg-white">
                <button id="rating-back-btn">
                    <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 19l-7-7 7-7"/>
                    </svg>
                </button>
                <h2 class="text-lg font-semibold">Оставить отзыв</h2>
                <button id="rating-close-btn">
                    <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"/>
                    </svg>
                </button>
            </div>
            <div id="rating-content" class="flex-1 overflow-auto p-4">
                <div class="space-y-4">
                    <div>
                        <h3 class="text-sm font-semibold">Качество продукции</h3>
                        <div class="star-rating flex gap-1" data-type="quality">
                            <button>★</button><button>★</button><button>★</button><button>★</button><button>★</button>
                        </div>
                    </div>
                    <div>
                        <h3 class="text-sm font-semibold">Обслуживание</h3>
                        <div class="star-rating flex gap-1" data-type="service">
                            <button>★</button><button>★</button><button>★</button><button>★</button><button>★</button>
                        </div>
                    </div>
                    <div>
                        <h3 class="text-sm font-semibold">Доставка</h3>
                        <div class="star-rating flex gap-1" data-type="delivery">
                            <button>★</button><button>★</button><button>★</button><button>★</button><button>★</button>
                        </div>
                    </div>
                    <div>
                        <h3 class="text-sm font-semibold">Комментарий</h3>
                        <textarea id="rating-comment" class="input-field border rounded-lg p-2 text-sm w-full" rows="4" placeholder="Ваши впечатления..."></textarea>
                    </div>
                    <button id="submit-rating" class="btn-primary w-full h-12 bg-pink-600 text-white rounded-lg text-sm font-semibold">Отправить отзыв</button>
                </div>
            </div>
        </div>
    </div>

    <script>
        // Инициализация Telegram Web App
        if (window.Telegram?.WebApp) {
            window.Telegram.WebApp.ready();
            window.Telegram.WebApp.expand();
            window.Telegram.WebApp.disableVerticalSwipes();
        }

        // App State
        const appState = {
            currentView: 'main',
            activeCategory: 'all',
            cart: JSON.parse(localStorage.getItem('cart') || '[]'),
            selectedProduct: null,
            selectedSize: 'S',
            selectedFilling: null,
            ratings: { quality: 0, service: 0, delivery: 0 },
            orderId: null
        };

        // Mock Data
        const products = [
            {
                id: '1',
                name: 'Бенто-торт',
                description: 'Компактный торт с индивидуальным дизайном, идеальный для одного-двух человек',
                price: 1400,
                sizes: [
                    { size: 'S', diameter: '10 см', weight: '450-550 г', price: 1400 },
                    { size: 'M', diameter: '12 см', weight: '850-950 г', price: 2250 },
                    { size: 'L', diameter: '14 см', weight: '1.2-1.3 кг', price: 2750 }
                ],
                fillings: [
                    { name: 'Маковый лимон с клубникой', image: 'https://via.placeholder.com/150?text=Маковый+лимон+с+клубникой' },
                    { name: 'Тропики манго-маракуйя', image: 'https://via.placeholder.com/150?text=Тропики+манго-маракуйя' },
                    { name: 'Пломбир малина-апельсин', image: 'https://via.placeholder.com/150?text=Пломбир+малина-апельсин' },
                    { name: 'Медовик', image: 'https://via.placeholder.com/150?text=Медовик' },
                    { name: 'Шоколадно-кофейный с крошкой Орео', image: 'https://via.placeholder.com/150?text=Шоколадно-кофейный' },
                    { name: 'Три шоколада', image: 'https://i.postimg.cc/2S7kFCFG/image.webp?text=Три+шоколада' },
                    { name: 'Морковный', image: 'https://i.postimg.cc/nzCnJB8S/image.webp?text=Морковный' },
                    { name: 'Ореховый со сгущёнкой', image: 'https://i.postimg.cc/Kj6VCgFT/image.webp?text=Ореховый+со+сгущёнкой' }
                ],
                image: 'https://images.unsplash.com/photo-1614707267537-b85aaf00c3b3?w=400&h=300&fit=crop',
                category: 'bento',
                rating: 4.7,
                reviewCount: 85,
                isNew: true,
                discount: 10,
                volume: '300 г',
                ingredients: ['Бисквит ванильный', 'Крем сливочный', 'Фрукты свежие', 'Сахарная мастика'],
                included: 'В стоимость входит покрытие любого цвета, транспортировочная красивая коробка, лента и свечка.',
                extra: 'Дизайн, ягоды, фотопечать, цветы оплачиваются отдельно.'
            },
            {
                id: '2',
                name: 'Моти',
                description: 'Нежные японские рисовые пирожные с начинкой',
                price: 100,
                image: 'https://images.unsplash.com/photo-1629637727847-6d1a1b34a6d?w=400&h=300&fit=crop',
                category: 'mochi',
                rating: 4.8,
                reviewCount: 120,
                isNew: false,
                volume: '1 шт',
                ingredients: ['Рисовая мука', 'Сливочная начинка', 'Фруктовое пюре']
            },
            {
                id: '3',
                name: 'Картошка',
                description: 'Классическое пирожное из бисквита и какао',
                price: 120,
                image: 'https://images.unsplash.com/photo-1599785209779-3154b9b341c2?w=400&h=300&fit=crop',
                category: 'kartoshka',
                rating: 4.6,
                reviewCount: 95,
                isNew: false,
                volume: '1 шт',
                ingredients: ['Бисквит шоколадный', 'Какао', 'Сгущенное молоко', 'Масло сливочное']
            },
            {
                id: '4',
                name: 'Трюфели',
                description: 'Шоколадные трюфели ручной работы с насыщенным вкусом',
                price: 150,
                image: 'https://images.unsplash.com/photo-1606092195730-6d7a61b784f8?w=400&h=300&fit=crop',
                category: 'truffles',
                rating: 4.9,
                reviewCount: 150,
                isNew: true,
                discount: 5,
                volume: '100 г',
                ingredients: ['Темный шоколад', 'Сливки', 'Какао-порошок']
            },
            {
                id: '5',
                name: 'Мадлен',
                description: 'Нежные французские бисквитные печенья в форме ракушек',
                price: 80,
                image: 'https://images.unsplash.com/photo-1619982440547-4e58f3c3ebfa?w=400&h=300&fit=crop',
                category: 'madeleine',
                rating: 4.5,
                reviewCount: 70,
                isNew: false,
                volume: '1 шт',
                ingredients: ['Пшеничная мука', 'Яйца', 'Сливочное масло', 'Лимонная цедра']
            }
        ];

        const reviews = [
            {
                id: 'r1',
                name: 'Анна',
                rating: 5,
                text: 'Бенто-торт просто восхитительный! Очень нежный и вкусный, особенно с начинкой "Маковый лимон".',
                date: '2025-07-20'
            },
            {
                id: 'r2',
                name: 'Михаил',
                rating: 4.5,
                text: 'Моти невероятно мягкие, заказывал для вечеринки, все гости были в восторге!',
                date: '2025-07-18'
            },
            {
                id: 'r3',
                name: 'Екатерина',
                rating: 4.8,
                text: 'Трюфели — это любовь с первого укуса. Шоколад насыщенный, тают во рту!',
                date: '2025-07-15'
            },
            {
                id: 'r4',
                name: 'Дмитрий',
                rating: 4.7,
                text: 'Картошка как из детства, очень вкусная и красиво оформлена.',
                date: '2025-07-10'
            },
            {
                id: 'r5',
                name: 'Ольга',
                rating: 4.9,
                text: 'Мадлен идеально подходят к чаю, заказываю уже третий раз!',
                date: '2025-07-05'
            }
        ];

        // DOM Elements
        const elements = {
            cartBtn: document.getElementById('cart-btn'),
            cartBadge: document.getElementById('cart-badge'),
            categories: document.querySelectorAll('.category-pill'),
            categoryCarousel: document.getElementById('category-carousel'),
            promoCarousel: document.getElementById('promo-carousel'),
            newProductsGrid: document.getElementById('new-products-grid'),
            topProductsGrid: document.getElementById('top-products-grid'),
            newProductsCount: document.getElementById('new-products-count'),
            topProductsCount: document.getElementById('top-products-count'),
            reviewsCarousel: document.getElementById('reviews-carousel'),
            cartModal: document.getElementById('cart-modal'),
            cartBackBtn: document.getElementById('cart-back-btn'),
            cartCloseBtn: document.getElementById('cart-close-btn'),
            cartContent: document.getElementById('cart-content'),
            cartTotalBadge: document.getElementById('cart-total-badge'),
            productDetail: document.getElementById('product-detail'),
            detailBackBtn: document.getElementById('detail-back-btn'),
            detailTitle: document.getElementById('detail-title'),
            detailContent: document.getElementById('detail-content'),
            ratingModal: document.getElementById('rating-modal'),
            ratingBackBtn: document.getElementById('rating-back-btn'),
            ratingCloseBtn: document.getElementById('rating-close-btn'),
            ratingContent: document.getElementById('rating-content'),
            submitRatingBtn: document.getElementById('submit-rating')
        };

        // Initialize quantity for product detail
        let detailQuantity = 1;

        // Event Listeners
        function initEventListeners() {
            elements.cartBtn.addEventListener('click', openCart);
            elements.cartBackBtn.addEventListener('click', closeCart);
            elements.cartCloseBtn.addEventListener('click', closeCart);
            elements.detailBackBtn.addEventListener('click', closeProductDetail);
            elements.detailCloseBtn.addEventListener('click', closeProductDetail);
            elements.ratingBackBtn.addEventListener('click', closeRatingModal);
            elements.ratingCloseBtn.addEventListener('click', closeRatingModal);
            elements.submitRatingBtn.addEventListener('click', submitRating);

            elements.categories.forEach(btn => {
                btn.addEventListener('click', () => {
                    elements.categories.forEach(b => b.classList.remove('active', 'bg-pink-100', 'text-pink-600'));
                    btn.classList.add('active', 'bg-pink-100', 'text-pink-600');
                    appState.activeCategory = btn.dataset.category;
                    renderProducts();
                    elements.categoryCarousel.scrollTo({ left: btn.offsetLeft - 16, behavior: 'smooth' });
                });
            });

            document.querySelectorAll('.star-rating').forEach(ratingDiv => {
                const type = ratingDiv.dataset.type;
                ratingDiv.querySelectorAll('button').forEach((star, index) => {
                    star.addEventListener('click', () => {
                        appState.ratings[type] = index + 1;
                        ratingDiv.querySelectorAll('button').forEach((s, i) => {
                            s.classList.toggle('active', i < index + 1);
                        });
                    });
                });
            });

            [elements.categoryCarousel, elements.promoCarousel, elements.reviewsCarousel].forEach(carousel => {
                carousel.addEventListener('wheel', (e) => {
                    e.preventDefault();
                    const delta = Math.abs(e.deltaX) > Math.abs(e.deltaY) ? e.deltaX : e.deltaY;
                    carousel.scrollLeft += delta * 2.5;
                });
            });

            window.addEventListener('resize', debounce(renderProducts, 100));
            startReviewsAutoScroll();
            checkRatingMode();
        }

        // Check if opened in rating mode
        function checkRatingMode() {
            const hash = window.location.hash;
            if (hash === '#rating') {
                const urlParams = new URLSearchParams(window.location.search);
                const orderId = urlParams.get('order_id');
                if (orderId) {
                    appState.orderId = orderId;
                    openRatingModal();
                }
            }
        }

        // Rating Modal Functions
        function openRatingModal() {
            elements.ratingModal.classList.add('open');
            elements.ratingModal.style.transform = 'translateY(0)';
        }

        function closeRatingModal() {
            elements.ratingModal.classList.remove('open');
            elements.ratingModal.style.transform = 'translateY(100%)';
            appState.ratings = { quality: 0, service: 0, delivery: 0 };
            document.querySelectorAll('.star-rating button').forEach(btn => btn.classList.remove('active'));
            document.getElementById('rating-comment').value = '';
        }

        function submitRating() {
            const comment = document.getElementById('rating-comment').value;
            const telegram = window.Telegram?.WebApp;
            const user = telegram?.initDataUnsafe?.user || {};

            const ratingData = {
                event: 'submit_rating',
                order_id: appState.orderId || 'unknown',
                user_id: String(user.id || 'unknown'),
                username: user.username || '',
                first_name: user.first_name || '',
                last_name: user.last_name || '',
                timestamp: new Date().toISOString(),
                url: window.location.href,
                userAgent: navigator.userAgent,
                rating: {
                    quality: appState.ratings.quality,
                    service: appState.ratings.service,
                    delivery: appState.ratings.delivery,
                    comment: comment
                }
            };

            fetch('https://script.google.com/macros/s/AKfycbxRK9cnnKCBM4AypS_cPFlYWkowUfBRiwFHbHYBcWNREHuy25nx1JvUVatPtVk1BzU_Mw/exec', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify(ratingData),
                mode: 'no-cors'
            })
                .then(() => {
                    showNotification('Отзыв отправлен! Спасибо!', 'success');
                    closeRatingModal();
                    window.location.hash = '';
                })
                .catch(error => {
                    console.error('Error submitting rating:', error);
                    showNotification('Ошибка при отправке отзыва', 'error');
                });
        }

        // Reviews Auto-Scroll
        function startReviewsAutoScroll() {
            const carousel = elements.reviewsCarousel;
            if (!carousel) return;

            let scrollPosition = 0;
            const scrollSpeed = 1;
            const maxScroll = carousel.scrollWidth - carousel.clientWidth;

            function autoScroll() {
                scrollPosition += scrollSpeed;
                if (scrollPosition >= maxScroll) {
                    scrollPosition = 0;
                    carousel.scrollTo({ left: 0, behavior: 'auto' });
                } else {
                    carousel.scrollTo({ left: scrollPosition, behavior: 'auto' });
                }
                requestAnimationFrame(autoScroll);
            }

            requestAnimationFrame(autoScroll);

            let isUserInteracting = false;
            carousel.addEventListener('touchstart', () => isUserInteracting = true);
            carousel.addEventListener('touchend', () => {
                setTimeout(() => isUserInteracting = false, 1000);
            });
            carousel.addEventListener('wheel', () => {
                isUserInteracting = true;
                setTimeout(() => isUserInteracting = false, 1000);
            });

            function conditionalAutoScroll() {
                if (!isUserInteracting) {
                    scrollPosition += scrollSpeed;
                    if (scrollPosition >= maxScroll) {
                        scrollPosition = 0;
                        carousel.scrollTo({ left: 0, behavior: 'auto' });
                    } else {
                        carousel.scrollTo({ left: scrollPosition, behavior: 'auto' });
                    }
                }
                requestAnimationFrame(conditionalAutoScroll);
            }

            requestAnimationFrame(conditionalAutoScroll);
        }

        // Cart Functions
        function openCart() {
            elements.cartModal.classList.add('open');
            elements.cartModal.style.transform = 'translateY(0)';
            renderCart();
        }

        function closeCart() {
            elements.cartModal.classList.remove('open');
            elements.cartModal.style.transform = 'translateY(100%)';
        }

        function addToCartById(productId, quantity = detailQuantity) {
            const product = products.find(p => p.id === productId);
            if (!product) {
                showNotification('Продукт не найден', 'error');
                return;
            }
            const existingItem = appState.cart.find(item => item.id === product.id && item.selectedSize === appState.selectedSize && (!item.selectedFilling || item.selectedFilling === appState.selectedFilling));
            if (existingItem) {
                existingItem.quantity += quantity;
            } else {
                const cartItem = { ...product, quantity, selectedSize: appState.selectedSize };
                if (product.category === 'bento' && appState.selectedFilling) {
                    cartItem.selectedFilling = appState.selectedFilling;
                }
                appState.cart.push(cartItem);
            }
            localStorage.setItem('cart', JSON.stringify(appState.cart));
            updateCartBadge();
            showNotification(`${product.name} (${appState.selectedSize}${product.category === 'bento' && appState.selectedFilling ? ', ' + appState.selectedFilling : ''}) добавлен в корзину`, 'success');
        }

        function updateCartQuantity(productId, newQuantity, size, filling) {
            const item = appState.cart.find(item => item.id === productId && item.selectedSize === size && (!item.selectedFilling || item.selectedFilling === filling));
            if (!item) {
                showNotification('Товар не найден в корзине', 'error');
                return;
            }
            if (newQuantity <= 0) {
                removeFromCart(productId, size, filling);
                return;
            }
            item.quantity = newQuantity;
            localStorage.setItem('cart', JSON.stringify(appState.cart));
            updateCartBadge();
            renderCart();
        }

        function removeFromCart(productId, size, filling) {
            appState.cart = appState.cart.filter(item => !(item.id === productId && item.selectedSize === size && (!item.selectedFilling || item.selectedFilling === filling)));
            localStorage.setItem('cart', JSON.stringify(appState.cart));
            updateCartBadge();
            renderCart();
        }

        function clearCart() {
            appState.cart = [];
            localStorage.setItem('cart', JSON.stringify(appState.cart));
            updateCartBadge();
            renderCart();
        }

        function updateCartBadge() {
            const totalItems = Array.isArray(appState.cart) ? appState.cart.reduce((sum, item) => sum + item.quantity, 0) : 0;
            elements.cartBadge.textContent = totalItems > 9 ? '9+' : totalItems;
            elements.cartTotalBadge.textContent = totalItems;
            elements.cartBadge.classList.toggle('hidden', totalItems === 0);
            elements.cartTotalBadge.classList.toggle('hidden', totalItems === 0);
        }

        function renderCart() {
            const cartContent = elements.cartContent;
            const cartItems = appState.cart.map(item => `${item.id}_${item.selectedSize}_${item.selectedFilling || ''}`).join(',');
            if (cartContent.dataset.cartItems === cartItems) return;
            cartContent.dataset.cartItems = cartItems;

            if (!Array.isArray(appState.cart) || appState.cart.length === 0) {
                elements.cartContent.innerHTML = `
                    <div class="flex-1 flex flex-col items-center justify-center text-center p-4">
                        <svg class="w-16 h-16 mx-auto mb-4 opacity-50" viewBox="0 0 24 24">
                            <path d="M16 11V7a4 4 0 00-8 0v4M5 9h14l-1 12H6L5 9z"/>
                        </svg>
                        <p class="text-lg font-medium">Корзина пуста</p>
                        <p class="text-sm">Добавьте вкусные десерты</p>
                        <button onclick="closeCart()" class="btn-primary mt-4 bg-pink-600 text-white rounded-lg p-3 text-sm font-semibold">Продолжить покупки</button>
                    </div>
                `;
                return;
            }

            const totalAmount = appState.cart.reduce((sum, item) => {
                const product = products.find(p => p.id === item.id);
                const size = product.sizes ? product.sizes.find(s => s.size === item.selectedSize) : null;
                return sum + (size ? size.price : item.price) * item.quantity;
            }, 0);
            const deliveryFee = totalAmount >= 2000 ? 0 : 300;
            const finalAmount = totalAmount + deliveryFee;

            elements.cartContent.innerHTML = `
                <div class="flex-1 overflow-auto space-y-3 p-4">
                    ${appState.cart.map(item => {
                        const product = products.find(p => p.id === item.id);
                        const size = product.sizes ? product.sizes.find(s => s.size === item.selectedSize) : null;
                        const price = size ? size.price : item.price;
                        return `
                            <div class="cart-item animate-fade-in flex gap-3">
                                <img src="${item.image}" alt="${item.name}" class="w-16 h-16 object-cover rounded-lg flex-shrink-0">
                                <div class="flex-1 min-w-0">
                                    <h4 class="line-clamp-1 mb-1 font-medium text-sm">${item.name}${item.selectedSize ? ` (${item.selectedSize}${item.selectedFilling ? ', ' + item.selectedFilling : ''})` : ''}</h4>
                                    <p class="text-sm text-pink-600 font-semibold mb-2">
                                        ${price} ₽ × ${item.quantity} = ${price * item.quantity} ₽
                                    </p>
                                    <div class="flex items-center justify-between">
                                        <div class="quantity-controls flex items-center gap-2">
                                            <button class="quantity-btn p-1 bg-gray-100 rounded" onclick="updateCartQuantity('${item.id}', ${item.quantity - 1}, '${item.selectedSize}', '${item.selectedFilling || ''}')">
                                                <svg class="icon" viewBox="0 0 24 24">
                                                    <path d="M20 12H4"/>
                                                </svg>
                                            </button>
                                            <span class="w-8 text-center font-medium">${item.quantity}</span>
                                            <button class="quantity-btn p-1 bg-gray-100 rounded" onclick="updateCartQuantity('${item.id}', ${item.quantity + 1}, '${item.selectedSize}', '${item.selectedFilling || ''}')">
                                                <svg class="icon" viewBox="0 0 24 24">
                                                    <path d="M12 6v6m0 0v6m0-6h6m-6 0H6"/>
                                                </svg>
                                            </button>
                                        </div>
                                        <button onclick="removeFromCart('${item.id}', '${item.selectedSize}', '${item.selectedFilling || ''}')" class="p-2 text-red-500 hover:bg-red-50 rounded-lg">
                                            <svg class="icon" viewBox="0 0 24 24">
                                                <path d="M19 7l-.867 12.142A2 2 0 0116.138 21H7.862a2 2 0 01-1.995-1.858L5 7m5 4v6m4-6v6m1-10V4a1 1 0 00-1-1h-4a1 1 0 00-1 1v3M4 7h16"/>
                                            </svg>
                                        </button>
                                    </div>
                                </div>
                            </div>
                        `;
                    }).join('')}
                </div>
                <div class="border-t bg-white p-4 space-y-3">
                    <h3 class="font-semibold text-sm">Оформление заказа</h3>
                    <div class="grid grid-cols-2 gap-3">
                        <div>
                            <label class="text-xs font-medium text-gray-600 mb-1 flex items-center gap-1">
                                <svg class="icon w-4 h-4" viewBox="0 0 24 24">
                                    <path d="M8 7V3a2 2 0 012-2h4a2 2 0 012 2v4m-6 0h6m-6 0l-2 8h10l-2-8"/>
                                </svg>
                                Дата
                            </label>
                            <input type="date" class="input-field border rounded-lg p-2 text-sm" min="${new Date().toISOString().split('T')[0]}" required>
                        </div>
                        <div>
                            <label class="text-xs font-medium text-gray-600 mb-1 block">Время</label>
                            <input type="time" class="input-field border rounded-lg p-2 text-sm" min="09:00" max="21:00" required>
                        </div>
                    </div>
                    <div>
                        <label class="text-xs font-medium text-gray-600 mb-1 flex items-center gap-1">
                            <svg class="icon w-4 h-4" viewBox="0 0 24 24">
                                <path d="M17.657 16.657L13.414 20.9a1.998 1.998 0 01-2.827 0l-4.244-4.243a8 8 0 1111.314 0z"/>
                            </svg>
                            Адрес доставки
                        </label>
                        <input type="text" placeholder="Улица, дом, квартира" class="input-field border rounded-lg p-2 text-sm" data-address required>
                    </div>
                    <div>
                        <label class="text-xs font-medium text-gray-600 mb-1 flex items-center gap-1">
                            <svg class="icon w-4 h-4" viewBox="0 0 24 24">
                                <path d="M3 5a2 2 0 012-2h3.28a1 1 0 01.948.684l1.498 4.493a1 1 0 01-.502 1.21l-2.257 1.13a11.042 11.042 0 005.516 5.516l1.13-2.257a1 1 0 011.21-.502l4.493 1.498a1 1 0 01.684.949V19a2 2 0 01-2 2h-1C9.716 21 3 14.284 3 6V5z"/>
                            </svg>
                            Телефон
                        </label>
                        <input type="tel" placeholder="+7 (999) 123-45-67" class="input-field border rounded-lg p-2 text-sm" required>
                    </div>
                    <div class="space-y-2 pt-2">
                        <div class="flex justify-between text-sm">
                            <span>Товары (${appState.cart.reduce((sum, item) => sum + item.quantity, 0)})</span>
                            <span>${totalAmount} ₽</span>
                        </div>
                        <div class="flex justify-between text-sm">
                            <span>Доставка</span>
                            <span class="${deliveryFee === 0 ? 'text-green-600' : ''}">
                                ${deliveryFee === 0 ? 'Бесплатно' : `${deliveryFee} ₽`}
                            </span>
                        </div>
                        ${totalAmount < 2000 ? '<p class="text-xs text-gray-600">Бесплатная доставка от 2000 ₽</p>' : ''}
                        <div class="flex justify-between font-semibold text-base pt-2 border-t">
                            <span>Итого</span>
                            <span class="text-pink-600">${finalAmount} ₽</span>
                        </div>
                    </div>
                    <div class="space-y-2 pt-2">
                        <button onclick="checkout()" class="btn-primary w-full h-12 bg-pink-600 text-white rounded-lg text-sm font-semibold flex items-center justify-center gap-2">
                            <svg class="icon w-5 h-5" viewBox="0 0 24 24">
                                <path d="M3 10h18M7 15h1m4 0h1m-7 4h12a3 3 0 003-3V8a3 3 0 00-3-3H6a3 3 0 00-3 3v8a3 3 0 003 3z"/>
                            </svg>
                            Оплатить ${finalAmount} ₽
                        </button>
                        <div class="grid grid-cols-2 gap-2">
                            <button onclick="clearCart()" class="btn-outline border border-gray-300 rounded-lg p-2 text-sm hover:bg-gray-100">Очистить</button>
                            <button onclick="closeCart()" class="btn-outline border border-gray-300 rounded-lg p-2 text-sm hover:bg-gray-100">Продолжить</button>
                        </div>
                    </div>
                </div>
            `;
        }

        // Product Detail Functions
        function openProductDetailById(productId) {
            const product = products.find(p => p.id === productId);
            if (!product) {
                showNotification('Продукт не найден', 'error');
                return;
            }
            appState.selectedProduct = product;
            appState.selectedSize = product.sizes ? 'S' : null;
            appState.selectedFilling = product.fillings ? product.fillings[0].name : null;
            elements.detailTitle.textContent = product.name;
            elements.productDetail.classList.add('open');
            elements.productDetail.style.transform = 'translateY(0)';
            detailQuantity = 1;
            renderProductDetail();
        }

        function closeProductDetail() {
            elements.productDetail.classList.remove('open');
            elements.productDetail.style.transform = 'translateY(100%)';
            appState.selectedProduct = null;
            appState.selectedSize = 'S';
            appState.selectedFilling = null;
            detailQuantity = 1;
        }

        function selectSize(size) {
            appState.selectedSize = size;
            renderProductDetail();
        }

        function selectFilling(filling) {
            appState.selectedFilling = filling;
            renderProductDetail();
        }

        function updateDetailQuantity(change) {
            detailQuantity = Math.max(1, detailQuantity + change);
            document.getElementById('detail-quantity').textContent = detailQuantity;
        }

        function toggleIngredients() {
            const list = document.getElementById('ingredients-list');
            const chevron = document.getElementById('ingredients-chevron');
            list.classList.toggle('hidden');
            chevron.classList.toggle('rotate-180');
        }

        function renderProductDetail() {
            if (!appState.selectedProduct) return;
            const product = appState.selectedProduct;
            const size = product.sizes ? product.sizes.find(s => s.size === appState.selectedSize) : null;
            const price = size ? size.price : product.price;
            const discountedPrice = product.discount ? Math.round(price * (1 - product.discount / 100)) : price;

            elements.detailContent.innerHTML = `
                <div class="relative h-64 bg-gray-200 mb-4">
                    <img src="${product.image}" alt="${product.name}" class="w-full h-full object-cover rounded-lg">
                    ${product.discount ? `<div class="discount-badge">Скидка -${product.discount}%</div>` : ''}
                    ${product.volume ? `
                        <div class="absolute top-2 right-2 bg-white/90 rounded-lg px-2 py-1 border">
                            <span class="text-xs font-medium">${size ? size.weight : product.volume}</span>
                        </div>
                    ` : ''}
                </div>
                <div class="space-y-3">
                    <div class="flex items-center gap-2">
                        <div class="flex items-center gap-1">
                            <svg class="rating-star w-4 h-4" fill="currentColor" viewBox="0 0 20 20">
                                <path d="M9.049 2.927c.3-.921 1.603-.921 1.902 0l1.07 3.292a1 1 0 00.95.69h3.462c.969 0 1.371 1.24.588 1.81l-2.8 2.034a1 1 0 00-.364 1.118l1.07 3.292c.3.921-.755 1.688-1.54 1.118l-2.8-2.034a1 1 0 00-1.175 0l-2.8 2.034c-.784.57-1.838-.197-1.539-1.118l1.07-3.292a1 1 0 00-.364-1.118L2.98 8.72c-.783-.57-.38-1.81.588-1.81h3.461a1 1 0 00.951-.69l1.07-3.292z"/>
                            </svg>
                            <span class="font-semibold text-sm">${product.rating}</span>
                        </div>
                        <span class="text-gray-600 text-xs">${product.reviewCount} оценок</span>
                    </div>
                    <h1 class="text-lg font-bold">${product.name}</h1>
                    ${product.sizes ? `
                        <div class="space-y-2">
                            <h3 class="font-semibold text-sm">Размер</h3>
                            <div class="grid grid-cols-3 gap-2">
                                ${product.sizes.map(s => `
                                    <button class="size-btn p-2 rounded-lg border ${appState.selectedSize === s.size ? 'active border-pink-300 bg-pink-50' : 'hover:border-pink-300'} text-left" onclick="selectSize('${s.size}')">
                                        <div class="font-medium text-sm">${s.size} (${s.diameter})</div>
                                        <div class="text-xs text-gray-600">${s.weight} / ${s.price} ₽</div>
                                    </button>
                                `).join('')}
                            </div>
                            <p class="text-xs text-gray-600">${product.included}</p>
                            <p class="text-xs text-gray-600">${product.extra}</p>
                        </div>
                    ` : ''}
                    ${product.fillings ? `
                        <div class="space-y-2">
                            <h3 class="font-semibold text-sm">Начинка</h3>
                            <div class="grid grid-cols-2 gap-2">
                                ${product.fillings.map(f => `
                                    <button class="filling-btn p-2 rounded-lg border ${appState.selectedFilling === f.name ? 'active border-pink-300 bg-pink-50' : 'hover:border-pink-300'} text-left" onclick="selectFilling('${f.name}')">
                                        <div class="font-medium text-sm">${f.name}</div>
                                    </button>
                                `).join('')}
                            </div>
                            <div class="mt-2 filling-image-container">
                                <img id="filling-image" src="${product.fillings.find(f => f.name === appState.selectedFilling).image}" alt="Начинка ${appState.selectedFilling}" class="w-full h-full object-contain rounded-lg">
                            </div>
                        </div>
                    ` : ''}
                    <div>
                        <p class="text-gray-600 text-sm line-clamp-2">${product.description}</p>
                    </div>
                    <div class="space-y-2">
                        <button class="flex items-center justify-between w-full py-2 text-left" onclick="toggleIngredients()">
                            <span class="font-semibold text-sm">Состав</span>
                            <svg id="ingredients-chevron" class="icon w-5 h-5 transition-transform" viewBox="0 0 24 24">
                                <path d="M19 9l-7 7-7-7"/>
                            </svg>
                        </button>
                        <div id="ingredients-list" class="space-y-1 hidden animate-fade-in">
                            ${product.ingredients ? product.ingredients.map(ing => `
                                <div class="text-xs text-gray-600">• ${ing}</div>
                            `).join('') : '<div class="text-xs text-gray-600">Состав отсутствует</div>'}
                        </div>
                    </div>
                    <div class="flex items-center gap-3">
                        <div class="quantity-controls flex items-center gap-2">
                            <button class="quantity-btn p-1 bg-gray-100 rounded" onclick="updateDetailQuantity(-1)">
                                <svg class="icon" viewBox="0 0 24 24">
                                    <path d="M20 12H4"/>
                                </svg>
                            </button>
                            <span id="detail-quantity" class="w-8 text-center font-medium">${detailQuantity}</span>
                            <button class="quantity-btn p-1 bg-gray-100 rounded" onclick="updateDetailQuantity(1)">
                                <svg class="icon" viewBox="0 0 24 24">
                                    <path d="M12 6v6m0 0v6m0-6h6m-6 0H6"/>
                                </svg>
                            </button>
                        </div>
                        <button onclick="addToCartById(appState.selectedProduct.id)" class="add-to-cart-btn flex-1 h-12 bg-pink-600 text-white rounded-lg text-sm font-semibold flex items-center justify-center gap-2">
                            <svg class="icon w-5 h-5" viewBox="0 0 24 24">
                                <path d="M3 3h2l.4 2M7 13h10l4-8H5.4M7 13L5.4 5M7 13l-2.293 2.293c-.63.63-.184 1.707.707 1.707H17m0 0a2 2 0 100 4 2 2 0 000-4zm-8 2a2 2 0 11-4 0 2 2 0 014 0z"/>
                            </svg>
                            Добавить в корзину
                        </button>
                    </div>
                </div>
            `;
        }

        // Product Rendering
        function renderProducts() {
            const filteredProducts = appState.activeCategory === 'all'
                ? products
                : products.filter(p => p.category === appState.activeCategory);

            const newProducts = filteredProducts.filter(p => p.isNew);
            const topProducts = filteredProducts.sort((a, b) => b.rating - a.rating).slice(0, 4);

            elements.newProductsCount.textContent = `${newProducts.length} товаров`;
            elements.topProductsCount.textContent = `${topProducts.length} товаров`;

            elements.newProductsGrid.innerHTML = newProducts.map(product => `
                <div class="product-card animate-zoom-in relative cursor-pointer rounded-lg overflow-hidden bg-white shadow-sm" onclick="openProductDetailById('${product.id}')">
                    <div class="relative h-40 bg-gray-200">
                        <img src="${product.image}" alt="${product.name}" class="w-full h-full object-cover">
                        ${product.discount ? `<div class="discount-badge">Скидка -${product.discount}%</div>` : ''}
                        ${product.volume ? `
                            <div class="absolute top-2 right-2 bg-white/90 rounded-lg px-2 py-1 border">
                                <span class="text-xs font-medium">${product.sizes ? product.sizes[0].weight : product.volume}</span>
                            </div>
                        ` : ''}
                    </div>
                    <div class="p-3">
                        <h3 class="text-sm font-semibold line-clamp-1">${product.name}</h3>
                        <p class="text-xs text-gray-600 line-clamp-2">${product.description}</p>
                        <div class="flex items-center justify-between mt-2">
                            <div class="flex items-center gap-1">
                                <svg class="rating-star w-4 h-4" fill="currentColor" viewBox="0 0 20 20">
                                    <path d="M9.049 2.927c.3-.921 1.603-.921 1.902 0l1.07 3.292a1 1 0 00.95.69h3.462c.969 0 1.371 1.24.588 1.81l-2.8 2.034a1 1 0 00-.364 1.118l1.07 3.292c.3.921-.755 1.688-1.54 1.118l-2.8-2.034a1 1 0 00-1.175 0l-2.8 2.034c-.784.57-1.838-.197-1.539-1.118l1.07-3.292a1 1 0 00-.364-1.118L2.98 8.72c-.783-.57-.38-1.81.588-1.81h3.461a1 1 0 00.951-.69l1.07-3.292z"/>
                                </svg>
                                <span class="font-semibold text-sm">${product.rating}</span>
                            </div>
                            <p class="text-sm font-semibold text-pink-600">${product.sizes ? product.sizes[0].price : product.price} ₽</p>
                        </div>
                    </div>
                </div>
            `).join('');

            elements.topProductsGrid.innerHTML = topProducts.map(product => `
                <div class="product-card animate-zoom-in relative cursor-pointer rounded-lg overflow-hidden bg-white shadow-sm" onclick="openProductDetailById('${product.id}')">
                    <div class="relative h-40 bg-gray-200">
                        <img src="${product.image}" alt="${product.name}" class="w-full h-full object-cover">
                        ${product.discount ? `<div class="discount-badge">Скидка -${product.discount}%</div>` : ''}
                        ${product.volume ? `
                            <div class="absolute top-2 right-2 bg-white/90 rounded-lg px-2 py-1 border">
                                <span class="text-xs font-medium">${product.sizes ? product.sizes[0].weight : product.volume}</span>
                            </div>
                        ` : ''}
                    </div>
                    <div class="p-3">
                        <h3 class="text-sm font-semibold line-clamp-1">${product.name}</h3>
                        <p class="text-xs text-gray-600 line-clamp-2">${product.description}</p>
                        <div class="flex items-center justify-between mt-2">
                            <div class="flex items-center gap-1">
                                <svg class="rating-star w-4 h-4" fill="currentColor" viewBox="0 0 20 20">
                                    <path d="M9.049 2.927c.3-.921 1.603-.921 1.902 0l1.07 3.292a1 1 0 00.95.69h3.462c.969 0 1.371 1.24.588 1.81l-2.8 2.034a1 1 0 00-.364 1.118l1.07 3.292c.3.921-.755 1.688-1.54 1.118l-2.8-2.034a1 1 0 00-1.175 0l-2.8 2.034c-.784.57-1.838-.197-1.539-1.118l1.07-3.292a1 1 0 00-.364-1.118L2.98 8.72c-.783-.57-.38-1.81.588-1.81h3.461a1 1 0 00.951-.69l1.07-3.292z"/>
                                </svg>
                                <span class="font-semibold text-sm">${product.rating}</span>
                            </div>
                            <p class="text-sm font-semibold text-pink-600">${product.sizes ? product.sizes[0].price : product.price} ₽</p>
                        </div>
                    </div>
                </div>
            `).join('');

            elements.reviewsCarousel.innerHTML = reviews.map(review => `
                <div class="review-card bg-white p-4 rounded-lg shadow-sm">
                    <div class="flex items-center justify-between mb-2">
                        <h3 class="font-semibold text-sm">${review.name}</h3>
                        <div class="flex items-center gap-1">
                            <svg class="rating-star w-4 h-4" fill="currentColor" viewBox="0 0 20 20">
                                <path d="M9.049 2.927c.3-.921 1.603-.921 1.902 0l1.07 3.292a1 1 0 00.95.69h3.462c.969 0 1.371 1.24.588 1.81l-2.8 2.034a1 1 0 00-.364 1.118l1.07 3.292c.3.921-.755 1.688-1.54 1.118l-2.8-2.034a1 1 0 00-1.175 0l-2.8 2.034c-.784.57-1.838-.197-1.539-1.118l1.07-3.292a1 1 0 00-.364-1.118L2.98 8.72c-.783-.57-.38-1.81.588-1.81h3.461a1 1 0 00.951-.69l1.07-3.292z"/>
                            </svg>
                            <span class="font-semibold text-sm">${review.rating}</span>
                        </div>
                    </div>
                    <p class="text-sm text-gray-600 line-clamp-3">${review.text}</p>
                    <p class="text-xs text-gray-500 mt-2">${review.date}</p>
                </div>
            `).join('');
        }

        // Checkout
        function checkout() {
            if (!appState.cart.length) {
                showNotification('Корзина пуста', 'error');
                return;
            }

            const dateInput = document.querySelector('input[type="date"]');
            const timeInput = document.querySelector('input[type="time"]');
            const addressInput = document.querySelector('input[data-address]');
            const phoneInput = document.querySelector('input[type="tel"]');

            if (!dateInput.value || !timeInput.value || !addressInput.value || !phoneInput.value) {
                showNotification('Заполните все поля', 'error');
                return;
            }

            const totalAmount = appState.cart.reduce((sum, item) => {
                const product = products.find(p => p.id === item.id);
                const size = product.sizes ? product.sizes.find(s => s.size === item.selectedSize) : null;
                return sum + (size ? size.price : item.price) * item.quantity;
            }, 0);
            const deliveryFee = totalAmount >= 2000 ? 0 : 300;
            const finalAmount = totalAmount + deliveryFee;

            const telegram = window.Telegram?.WebApp;
            const user = telegram?.initDataUnsafe?.user || {};

            const orderData = {
                event: 'order_submit',
                user_id: String(user.id || 'unknown'),
                username: user.username || '',
                first_name: user.first_name || '',
                last_name: user.last_name || '',
                timestamp: new Date().toISOString(),
                url: window.location.href,
                userAgent: navigator.userAgent,
                additional: {
                    order_id: 'ORD-' + Date.now(),
                    order_details: appState.cart.map(item => {
                        const product = products.find(p => p.id === item.id);
                        const size = product.sizes ? product.sizes.find(s => s.size === item.selectedSize) : null;
                        return {
                            name: product.name,
                            size: item.selectedSize,
                            filling: item.selectedFilling,
                            quantity: item.quantity,
                            price: size ? size.price : item.price
                        };
                    }),
                    total_amount: totalAmount,
                    delivery_fee: deliveryFee,
                    final_amount: finalAmount,
                    date: dateInput.value,
                    time: timeInput.value,
                    address: addressInput.value,
                    phone: phoneInput.value
                }
            };

            fetch('https://script.google.com/macros/s/AKfycbxRK9cnnKCBM4AypS_cPFlYWkowUfBRiwFHbHYBcWNREHuy25nx1JvUVatPtVk1BzU_Mw/exec', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify(orderData),
                mode: 'no-cors'
            })
                .then(() => {
                    clearCart();
                    showNotification('Заказ успешно отправлен! Мы свяжемся с вами.', 'success');
                    closeCart();
                })
                .catch(error => {
                    console.error('Error submitting order:', error);
                    showNotification('Ошибка при отправке заказа', 'error');
                });
        }

        // Utility Functions
        function showNotification(message, type = 'success') {
            const notification = document.createElement('div');
            notification.className = `fixed top-4 left-1/2 transform -translate-x-1/2 px-4 py-2 rounded-lg text-sm font-medium animate-zoom-in ${
                type === 'success' ? 'bg-green-500 text-white' : 'bg-red-500 text-white'
            }`;
            notification.textContent = message;
            document.body.appendChild(notification);
            setTimeout(() => {
                notification.classList.add('opacity-0');
                setTimeout(() => notification.remove(), 300);
            }, 3000);
        }

        function debounce(func, wait) {
            let timeout;
            return function executedFunction(...args) {
                const later = () => {
                    clearTimeout(timeout);
                    func(...args);
                };
                clearTimeout(timeout);
                timeout = setTimeout(later, wait);
            };
        }

        // Initialize
        document.addEventListener('DOMContentLoaded', () => {
            updateCartBadge();
            renderProducts();
            initEventListeners();
        });
    </script>
</body>
</html>
