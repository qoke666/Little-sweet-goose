<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Little Sweet Goose</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.15.4/css/all.min.css">
    <link href="https://unpkg.com/aos@2.3.1/dist/aos.css" rel="stylesheet">
    <style>
        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
            overscroll-behavior: none;
            margin: 0;
            padding: 0;
            -webkit-tap-highlight-color: transparent;
            background-color: #f3f4f6;
            position: relative;
        }
        #tsparticles {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            z-index: -1;
        }
        .animate-zoom-in {
            animation: zoomIn 0.3s ease forwards;
        }
        .animate-fade-in {
            animation: fadeIn 0.3s ease forwards;
        }
        @keyframes zoomIn {
            from { transform: scale(0.8); opacity: 0; }
            to { transform: scale(1); opacity: 1; }
        }
        @keyframes fadeIn {
            from { opacity: 0; }
            to { opacity: 1; }
        }
        .carousel {
            display: flex;
            overflow-x: auto;
            white-space: nowrap;
            scroll-behavior: smooth;
            touch-action: pan-x;
            -webkit-overflow-scrolling: touch;
            scroll-snap-type: x mandatory;
            scrollbar-width: none;
            -ms-overflow-style: none;
            position: relative;
            width: 343px;
            height: 136px;
            margin: 8px auto;
            border-radius: 6px;
            overflow: hidden;
            background: #000;
            max-width: 100%;
        }
        .carousel::-webkit-scrollbar {
            display: none;
        }
        .carousel a {
            display: block;
            width: 100%;
            height: 100%;
            position: absolute;
            top: 0;
            left: 0;
            opacity: 0;
            transition: opacity .5s linear, transform .5s linear;
            transform: scale(1);
        }
        .carousel a.active {
            opacity: 1;
            z-index: 1;
            transform: scale(1.02);
        }
        .carousel img { width: 100%; height: 100%; object-fit: cover; display: block; }
        .carousel .hot {
            position: absolute;
            top: 8px;
            left: 16px;
            font-size: 20px;
            font-weight: 500;
            color: #ffffff;
            z-index: 2;
        }
        .carousel-dots {
            position: absolute;
            bottom: 8px;
            left: 50%;
            transform: translateX(-50%);
            display: flex;
            gap: 5px;
            z-index: 2;
        }
        .carousel-dots .dot {
            width: 5px;
            height: 5px;
            border-radius: 50%;
            background: rgba(255,255,255,0.3);
            cursor: pointer;
            transition: background .3s;
        }
        .carousel-dots .dot.active { background: #d5fd02; }
        .product-image-carousel {
            position: relative;
            width: 100%;
            height: 288px;
            display: flex;
            overflow-x: auto;
            scroll-snap-type: x mandatory;
            scroll-behavior: smooth;
            touch-action: pan-x;
            -webkit-overflow-scrolling: touch;
            scrollbar-width: none;
            -ms-overflow-style: none;
            border-radius: 12px;
            background: #e5e7eb;
            margin-bottom: 16px;
        }
        .product-image-carousel::-webkit-scrollbar {
            display: none;
        }
        .product-image-carousel img {
            width: 100%;
            height: 100%;
            object-fit: cover;
            flex-shrink: 0;
            scroll-snap-align: center;
        }
        .product-image-dots {
            position: absolute;
            bottom: 8px;
            left: 50%;
            transform: translateX(-50%);
            display: flex;
            gap: 5px;
            z-index: 2;
        }
        .product-image-dots .dot {
            width: 6px;
            height: 6px;
            border-radius: 50%;
            background: rgba(255,255,255,0.5);
            cursor: pointer;
            transition: background .3s;
        }
        .product-image-dots .dot.active { background: #ffffff; }
        .cart-modal, .product-detail {
            height: 100dvh;
            max-height: 100dvh;
            overflow-y: auto;
        }
        .input-field {
            width: 100%;
            box-sizing: border-box;
            transition: border-color 0.2s ease;
        }
        .input-field:focus {
            border-color: #db2777;
            outline: none;
        }
        .quantity-btn {
            display: flex;
            align-items: center;
            justify-content: center;
            width: 32px;
            height: 32px;
            border-radius: 50%;
            background: #f3f4f6;
            transition: background 0.2s;
        }
        .quantity-btn:hover {
            background: #e5e7eb;
        }
        .quantity-btn svg {
            width: 16px;
            height: 16px;
        }
        .rating-star {
            color: #facc15;
        }
        .discount-badge {
            position: absolute;
            top: 8px;
            left: 8px;
            background: #dc2626;
            color: white;
            padding: 4px 8px;
            border-radius: 12px;
            font-size: 10px;
            font-weight: bold;
        }
        .social-links a {
            display: inline-flex;
            align-items: center;
            justify-content: center;
            width: 36px;
            height: 36px;
            border-radius: 50%;
            transition: background-color 0.2s, transform 0.2s;
        }
        .social-links a:hover {
            background-color: #e5e7eb;
            transform: scale(1.1);
        }
        .social-links i {
            font-size: 22px;
            color: #4b5563;
        }
        .header-elements {
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            z-index: 40;
            padding: 16px;
            display: flex;
            align-items: center;
            justify-content: space-between;
            background: #fff;
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
        }
        .size-btn.active {
            background-color: #fce7f3;
            border-color: #db2777;
        }
        .filling-btn.active {
            background-color: #fce7f3;
            border-color: #db2777;
        }
        .add-to-cart-btn {
            z-index: 10;
            transition: transform 0.2s ease;
        }
        .add-to-cart-btn:hover {
            transform: scale(1.1);
        }
        .filling-image-container {
            aspect-ratio: 4/3;
            max-height: 96px;
            overflow: hidden;
            display: flex;
            justify-content: center;
        }
        .btn-primary {
            transition: all 0.2s ease;
            box-shadow: 0 2px 4px rgba(0, 0, 0, 0.1);
        }
        .btn-primary:hover {
            transform: translateY(-2px);
            box-shadow: 0 4px 8px rgba(0, 0, 0, 0.15);
        }
        @media (min-width: 768px) {
            .product-card {
                width: calc((100% - 3rem) / 3);
                transition: transform 0.2s ease;
            }
            .product-card:hover {
                transform: translateY(-4px);
            }
            .products-grid {
                grid-template-columns: repeat(auto-fill, minmax(200px, 1fr));
            }
            .filling-image-container {
                max-height: 120px;
            }
        }
        @media (min-width: 1024px) {
            .product-card {
                width: calc((100% - 4rem) / 4);
            }
        }
        .particle {
            position: absolute;
            background: rgba(255, 105, 180, 0.8);
            border-radius: 50%;
            animation: float 15s infinite ease-in-out;
            pointer-events: none;
        }
        @keyframes float {
            0% { transform: translateY(0); opacity: 0.8; }
            50% { transform: translateY(-100px); opacity: 0.5; }
            100% { transform: translateY(0); opacity: 0.8; }
        }
    </style>
</head>
<body class="bg-gray-100 relative">
    <div id="tsparticles"></div>
    <main class="pt-24 pb-20 px-4 max-w-7xl mx-auto relative">
        <div class="header-elements">
            <div class="relative">
                <button id="cart-btn" class="p-2 hover:bg-gray-100 rounded-full">
                    <svg class="w-7 h-7" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M3 3h2l.4 2M7 13h10l4-8H5.4M7 13L5.4 5M7 13l-2.293 2.293c-.63.63-.184 1.707.707 1.707H17m0 0a2 2 0 100 4 2 2 0 000-4zm-8 2a2 2 0 11-4 0 2 2 0 014 0z"/>
                    </svg>
                    <span id="cart-badge" class="absolute -top-1 -right-1 bg-pink-600 text-white text-xs rounded-full w-5 h-5 flex items-center justify-center hidden">0</span>
                </button>
            </div>
            <h1 class="text-xl font-bold text-gray-800">Little Sweet Goose</h1>
            <div class="social-links flex items-center gap-3">
                <a href="https://t.me/limitedclubcpa" target="_blank" class="social-link tg-link" data-social="telegram">
                    <i class="fab fa-telegram-plane"></i>
                </a>
                <a href="https://www.instagram.com/thelimitedclub.cpa?igsh=MXkwcXppMWtlZGtm" target="_blank" class="social-link" data-social="instagram">
                    <i class="fab fa-instagram"></i>
                </a>
            </div>
        </div>

        <div class="carousel">
            <a href="https://telegra.ph/SCAM-kejs-ot-AMERIOBET-hronologiya-prufy-i-dolg-na-90-000-03-18" target="_blank" class="active">
                <img src="https://i.postimg.cc/bJqQWjv5/photo-2025-03-18-15-18-14.jpg" alt="скам" />
            </a>
            <a href="https://www.instagram.com/reel/DKHZPnYtjQD/?igsh=1234567890" target="_blank">
                <img src="https://i.postimg.cc/Z57qjBRv/feat-mac.jpg" alt="мак" />
            </a>
            <div class="hot"></div>
            <div class="carousel-dots">
                <div class="dot active"></div>
                <div class="dot"></div>
            </div>
        </div>

        <div class="flex items-center justify-between mb-5">
            <h2 class="text-xl font-bold text-gray-800">Новинки</h2>
            <span id="new-products-count" class="text-sm text-gray-600">0 товаров</span>
        </div>
        <div id="new-products-grid" class="grid grid-cols-2 gap-4 md:grid-cols-3 lg:grid-cols-4 mb-10"></div>

        <div class="flex items-center justify-between mb-5">
            <h2 class="text-xl font-bold text-gray-800">Топ-позиции</h2>
            <span id="top-products-count" class="text-sm text-gray-600">0 товаров</span>
        </div>
        <div id="top-products-grid" class="grid grid-cols-2 gap-4 md:grid-cols-3 lg:grid-cols-4 mb-10"></div>
    </main>

    <div id="cart-modal" class="fixed inset-0 bg-white z-50 transform translate-y-full transition-transform duration-300">
        <div class="flex flex-col h-full">
            <div class="flex items-center justify-between p-4 border-b bg-white shadow-sm">
                <button id="cart-back-btn">
                    <svg class="w-7 h-7" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 19l-7-7 7-7"/>
                    </svg>
                </button>
                <h2 class="text-xl font-bold text-gray-800">Корзина</h2>
                <div class="relative">
                    <span id="cart-total-badge" class="bg-pink-600 text-white text-xs rounded-full w-5 h-5 flex items-center justify-center hidden">0</span>
                    <button id="cart-close-btn">
                        <svg class="w-7 h-7" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"/>
                        </svg>
                    </button>
                </div>
            </div>
            <div id="cart-content" class="flex-1 overflow-auto"></div>
        </div>
    </div>

    <div id="product-detail" class="fixed inset-0 bg-white z-50 transform translate-y-full transition-transform duration-300">
        <div class="flex flex-col h-full">
            <div class="flex items-center justify-between p-4 border-b bg-white shadow-sm">
                <button id="detail-back-btn">
                    <svg class="w-7 h-7" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 19l-7-7 7-7"/>
                    </svg>
                </button>
                <h2 id="detail-title" class="text-xl font-bold text-gray-800"></h2>
                <button id="detail-close-btn">
                    <svg class="w-7 h-7" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"/>
                    </svg>
                </button>
            </div>
            <div id="detail-content" class="flex-1 overflow-auto p-4"></div>
        </div>
    </div>

    <script src="https://telegram.org/js/telegram-web-app.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/tsparticles@2.12.0/tsparticles.bundle.min.js"></script>
    <script src="https://unpkg.com/aos@2.3.1/dist/aos.js"></script>
    <script>
        AOS.init({
            duration: 800,
            once: true,
            offset: 100
        });
        window.addEventListener('load', () => {
            AOS.refresh();
        });

        if (typeof tsParticles !== 'undefined') {
            tsParticles.load("tsparticles", {
                fpsLimit: 60,
                particles: {
                    number: { value: 200, density: { enable: true, value_area: 800 } },
                    color: { value: "#FF69B4" },
                    shape: { type: "circle" },
                    opacity: { value: 0.5, random: true },
                    size: { value: 2, random: { enable: true, minimumValue: 0.5 } },
                    links: { enable: false },
                    move: {
                        enable: true,
                        speed: 0.5,
                        direction: "none",
                        random: true,
                        outModes: { default: "out" }
                    }
                },
                interactivity: { events: { onHover: { enable: false } }, resize: { enable: true } },
                retina_detect: true
            }).then(() => console.log('tsParticles loaded')).catch(err => console.error('tsParticles error:', err));
        } else {
            console.error('tsParticles not loaded');
        }

        if (window.Telegram?.WebApp) {
            window.Telegram.WebApp.ready();
            window.Telegram.WebApp.expand();
            window.Telegram.WebApp.disableVerticalSwipes();
        }

        const appState = {
            currentView: 'main',
            cart: [],
            selectedProduct: null,
            selectedSize: 'S',
            selectedFilling: null,
            productImageIndex: 0,
            userInteracted: false
        };

        const products = [
            {
                id: '1',
                name: 'Бенто-торт',
                description: 'Компактный торт с индивидуальным дизайном, идеальный для одного-двух человек',
                price: 1400,
                sizes: [
                    { size: 'S', diameter: '10 см', weight: '450-550 г', price: 1400 },
                    { size: 'M', diameter: '12 см', weight: '850-950 г', price: 2250 },
                    { size: 'L', diameter: '14 см', weight: '1.2-1.3 кг', price: 2750 }
                ],
                fillings: [
                    { name: 'Маковый лимон с клубникой', image: 'https://via.placeholder.com/150?text=Маковый+лимон+с+клубникой' },
                    { name: 'Тропики манго-маракуйя', image: 'https://via.placeholder.com/150?text=Тропики+манго-маракуйя' },
                    { name: 'Пломбир малина-апельсин', image: 'https://via.placeholder.com/150?text=Пломбир+малина-апельсин' },
                    { name: 'Медовик', image: 'https://via.placeholder.com/150?text=Медовик' },
                    { name: 'Шоколадно-кофейный с крошкой Орео', image: 'https://via.placeholder.com/150?text=Шоколадно-кофейный' },
                    { name: 'Три шоколада', image: 'https://i.postimg.cc/2S7kFCFG/image.webp?text=Три+шоколада' },
                    { name: 'Морковный', image: 'https://i.postimg.cc/nzCnJB8S/image.webp?text=Морковный' },
                    { name: 'Ореховый со сгущёнкой', image: 'https://i.postimg.cc/Kj6VCgFT/image.webp?text=Ореховый+со+сгущёнкой' }
                ],
                images: [
                    'https://i.postimg.cc/Wznctb7p/photo-2024-11-25-07-51-57.jpg',
                    'https://i.postimg.cc/MTjqdSmq/photo-2024-11-21-06-43-06.jpg',
                    'https://i.postimg.cc/7h3T2VwQ/photo-2024-12-09-17-53-44.jpg',
                    'https://i.postimg.cc/sfmjvqrC/photo-2024-12-09-18-02-26.jpg',
                    'https://images.unsplash.com/photo-1578985545061-5e7a6e8e7406?w=400&h=300&fit=crop'
                ],
                category: 'bento',
                isNew: true,
                discount: 10,
                volume: '300 г',
                ingredients: ['Бисквит ванильный', 'Крем сливочный', 'Фрукты свежие', 'Сахарная мастика'],
                included: 'В стоимость входит покрытие любого цвета, транспортировочная красивая коробка, лента и свечка.',
                extra: 'Дизайн, ягоды, фотопечать, цветы оплачиваются отдельно.'
            },
            {
                id: '2',
                name: 'Моти',
                description: 'Нежные японские рисовые пирожные с начинкой',
                price: 100,
                images: [
                    'https://i.postimg.cc/kXVgzs0r/photo-2024-11-25-07-59-12.jpg',
                    'https://i.postimg.cc/bwkNNJY3/photo-2024-11-25-07-59-11.jpg',
                    'https://via.placeholder.com/400x300?text=Моти+3',
                    'https://via.placeholder.com/400x300?text=Моти+4',
                    'https://via.placeholder.com/400x300?text=Моти+5'
                ],
                category: 'mochi',
                isNew: false,
                volume: '1 шт',
                ingredients: ['Рисовая мука', 'Сливочная начинка', 'Фруктовое пюре']
            },
            {
                id: '3',
                name: 'Картошка',
                description: 'Классическое пирожное из бисквита и какао',
                price: 120,
                images: [
                    'https://i.postimg.cc/yxGYW3Sr/photo-2024-11-25-08-45-29.jpg',
                    'https://i.postimg.cc/ZYsqw2DF/photo-2024-11-25-08-45-29-2.jpg',
                    'https://i.postimg.cc/xTW12HQX/photo-2024-11-25-08-45-30.jpg',
                    'https://i.postimg.cc/XvWNZbp3/photo-2024-11-25-08-45-30-2.jpg',
                    'https://via.placeholder.com/400x300?text=Картошка+5'
                ],
                category: 'kartoshka',
                isNew: false,
                volume: '1 шт',
                ingredients: ['Бисквит шоколадный', 'Какао', 'Сгущенное молоко', 'Масло сливочное']
            },
            {
                id: '4',
                name: 'Трюфели',
                description: 'Шоколадные трюфели ручной работы с насыщенным вкусом',
                price: 150,
                images: [
                    'https://i.postimg.cc/qR9Z0t66/photo-2025-04-25-20-09-35.jpg',
                    'https://i.postimg.cc/xCkFWG8S/photo-2025-04-25-20-09-36.jpg',
                    'https://i.postimg.cc/tgvMSvX5/photo-2025-04-25-20-09-38.jpg',
                    'https://via.placeholder.com/400x300?text=Трюфели+4',
                    'https://via.placeholder.com/400x300?text=Трюфели+5'
                ],
                category: 'truffles',
                isNew: true,
                discount: 5,
                volume: '100 г',
                ingredients: ['Темный шоколад', 'Сливки', 'Какао-порошок']
            },
            {
                id: '5',
                name: 'Мадлен',
                description: 'Нежные французские бисквитные печенья в форме ракушек',
                price: 80,
                images: [
                    'https://images.unsplash.com/photo-1619982440547-4e58f3c3ebfa?w=400&h=300&fit=crop',
                    'https://via.placeholder.com/400x300?text=Мадлен+2',
                    'https://via.placeholder.com/400x300?text=Мадлен+3',
                    'https://via.placeholder.com/400x300?text=Мадлен+4',
                    'https://via.placeholder.com/400x300?text=Мадлен+5'
                ],
                category: 'madeleine',
                isNew: false,
                volume: '1 шт',
                ingredients: ['Пшеничная мука', 'Яйца', 'Сливочное масло', 'Лимонная цедра']
            }
        ];

        const elements = {
            cartBtn: document.getElementById('cart-btn'),
            cartBadge: document.getElementById('cart-badge'),
            promoCarousel: document.querySelector('.carousel'),
            newProductsGrid: document.getElementById('new-products-grid'),
            topProductsGrid: document.getElementById('top-products-grid'),
            newProductsCount: document.getElementById('new-products-count'),
            topProductsCount: document.getElementById('top-products-count'),
            cartModal: document.getElementById('cart-modal'),
            cartBackBtn: document.getElementById('cart-back-btn'),
            cartCloseBtn: document.getElementById('cart-close-btn'),
            cartContent: document.getElementById('cart-content'),
            cartTotalBadge: document.getElementById('cart-total-badge'),
            productDetail: document.getElementById('product-detail'),
            detailBackBtn: document.getElementById('detail-back-btn'),
            detailCloseBtn: document.getElementById('detail-close-btn'),
            detailTitle: document.getElementById('detail-title'),
            detailContent: document.getElementById('detail-content')
        };

        function initEventListeners() {
            elements.cartBtn.addEventListener('click', openCart);
            elements.cartBackBtn.addEventListener('click', closeCart);
            elements.cartCloseBtn.addEventListener('click', closeCart);
            elements.detailBackBtn.addEventListener('click', closeProductDetail);
            elements.detailCloseBtn.addEventListener('click', closeProductDetail);

            elements.promoCarousel.addEventListener('wheel', (e) => {
                e.preventDefault();
                const delta = Math.abs(e.deltaX) > Math.abs(e.deltaY) ? e.deltaX : e.deltaY;
                elements.promoCarousel.scrollLeft += delta * 2.5;
            });

            window.addEventListener('resize', debounce(renderProducts, 100));
            startCarousel();
        }

        function startCarousel() {
            const slides = elements.promoCarousel.querySelectorAll('a');
            const dots = elements.promoCarousel.querySelectorAll('.dot');
            let currentIndex = 0;
            function showSlide(index) {
                slides.forEach((slide, i) => {
                    slide.classList.toggle('active', i === index);
                });
                dots.forEach((dot, i) => {
                    dot.classList.toggle('active', i === index);
                });
                currentIndex = index;
            }

            function nextSlide() {
                currentIndex = (currentIndex + 1) % slides.length;
                showSlide(currentIndex);
            }

            setInterval(nextSlide, 3000);
            showSlide(currentIndex);
        }

        function startProductImageCarousel() {
            const carousel = elements.detailContent.querySelector('.product-image-carousel');
            if (!carousel) return;
            const images = carousel.querySelectorAll('img');
            const dots = carousel.querySelectorAll('.product-image-dots .dot');
            let currentIndex = appState.productImageIndex;
            let intervalId = null;

            function showImage(index) {
                images.forEach((img, i) => {
                    img.classList.toggle('active', i === index);
                });
                dots.forEach((dot, i) => {
                    dot.classList.toggle('active', i === index);
                });
                carousel.scrollLeft = index * carousel.offsetWidth;
                appState.productImageIndex = index;
            }

            function startAutoSlide() {
                if (!appState.userInteracted) {
                    intervalId = setInterval(() => {
                        currentIndex = (currentIndex + 1) % images.length;
                        showImage(currentIndex);
                    }, 3000);
                }
            }

            function stopAutoSlide() {
                appState.userInteracted = true;
                if (intervalId) {
                    clearInterval(intervalId);
                    intervalId = null;
                }
            }

            dots.forEach((dot, i) => {
                dot.addEventListener('click', () => {
                    stopAutoSlide();
                    showImage(i);
                });
            });

            let touchStartX = 0;
            let touchEndX = 0;

            carousel.addEventListener('touchstart', (e) => {
                touchStartX = e.touches[0].clientX;
            });

            carousel.addEventListener('touchmove', (e) => {
                touchEndX = e.touches[0].clientX;
            });

            carousel.addEventListener('touchend', () => {
                const deltaX = touchStartX - touchEndX;
                if (Math.abs(deltaX) > 50) {
                    stopAutoSlide();
                    if (deltaX > 0 && currentIndex < images.length - 1) {
                        currentIndex++;
                    } else if (deltaX < 0 && currentIndex > 0) {
                        currentIndex--;
                    }
                    showImage(currentIndex);
                }
            });

            carousel.addEventListener('scroll', () => {
                const index = Math.round(carousel.scrollLeft / carousel.offsetWidth);
                if (index !== currentIndex) {
                    currentIndex = index;
                    showImage(index);
                }
            });

            showImage(currentIndex);
            startAutoSlide();
        }

        function openCart() {
            elements.cartModal.classList.add('open');
            elements.cartModal.style.transform = 'translateY(0)';
            renderCart();
        }

        function closeCart() {
            elements.cartModal.classList.remove('open');
            elements.cartModal.style.transform = 'translateY(100%)';
        }

        function addToCartById(productId, quantity = 1) {
            const product = products.find(p => p.id === productId);
            if (!product) {
                showNotification('Продукт не найден', 'error');
                return;
            }
            const existingItem = appState.cart.find(item => item.id === product.id && item.selectedSize === appState.selectedSize && (!item.selectedFilling || item.selectedFilling === appState.selectedFilling));
            if (existingItem) {
                existingItem.quantity += quantity;
            } else {
                const cartItem = { ...product, quantity, selectedSize: appState.selectedSize };
                if (product.category === 'bento' && appState.selectedFilling) {
                    cartItem.selectedFilling = appState.selectedFilling;
                }
                appState.cart.push(cartItem);
            }
            localStorage.setItem('cart', JSON.stringify(appState.cart));
            updateCartBadge();
            showNotification(`${product.name} (${appState.selectedSize}${product.category === 'bento' && appState.selectedFilling ? ', ' + appState.selectedFilling : ''}) добавлен в корзину`, 'success');
        }

        function updateCartQuantity(productId, newQuantity, size, filling) {
            const item = appState.cart.find(item => item.id === productId && item.selectedSize === size && (!item.selectedFilling || item.selectedFilling === filling));
            if (!item) {
                showNotification('Товар не найден в корзине', 'error');
                return;
            }
            if (newQuantity <= 0) {
                removeFromCart(productId, size, filling);
                return;
            }
            item.quantity = newQuantity;
            localStorage.setItem('cart', JSON.stringify(appState.cart));
            updateCartBadge();
            renderCart();
        }

        function removeFromCart(productId, size, filling) {
            appState.cart = appState.cart.filter(item => !(item.id === productId && item.selectedSize === size && (!item.selectedFilling || item.selectedFilling === filling)));
            localStorage.setItem('cart', JSON.stringify(appState.cart));
            updateCartBadge();
            renderCart();
        }

        function clearCart() {
            appState.cart = [];
            localStorage.setItem('cart', JSON.stringify(appState.cart));
            updateCartBadge();
            renderCart();
        }

        function updateCartBadge() {
            const totalItems = Array.isArray(appState.cart) ? appState.cart.reduce((sum, item) => sum + item.quantity, 0) : 0;
            elements.cartBadge.textContent = totalItems > 9 ? '9+' : totalItems;
            elements.cartTotalBadge.textContent = totalItems;
            elements.cartBadge.classList.toggle('hidden', totalItems === 0);
            elements.cartTotalBadge.classList.toggle('hidden', totalItems === 0);
        }

        function getMinOrderDate() {
            const today = new Date();
            today.setDate(today.getDate() + 1);
            return today.toISOString().split('T')[0];
        }

        function renderCart() {
            const cartContent = elements.cartContent;
            const cartItems = appState.cart.map(item => `${item.id}_${item.selectedSize}_${item.selectedFilling || ''}`).join(',');
            if (cartContent.dataset.cartItems === cartItems) return;
            cartContent.dataset.cartItems = cartItems;

            if (!Array.isArray(appState.cart) || appState.cart.length === 0) {
                elements.cartContent.innerHTML = `
                    <div class="flex-1 flex flex-col items-center justify-center text-center p-6">
                        <svg class="w-20 h-20 mx-auto mb-4 opacity-50" viewBox="0 0 24 24">
                            <path d="M16 11V7a4 4 0 00-8 0v4M5 9h14l-1 12H6L5 9z"/>
                        </svg>
                        <p class="text-xl font-semibold text-gray-800">Корзина пуста</p>
                        <p class="text-sm text-gray-600">Добавьте вкусные десерты</p>
                        <button onclick="closeCart()" class="btn-primary mt-4 bg-pink-600 text-white rounded-lg p-3 text-base font-semibold shadow-md">Продолжить покупки</button>
                    </div>
                `;
                return;
            }

            const totalAmount = appState.cart.reduce((sum, item) => {
                const product = products.find(p => p.id === item.id);
                const size = product.sizes ? product.sizes.find(s => s.size === item.selectedSize) : null;
                return sum + (size ? size.price : item.price) * item.quantity;
            }, 0);

            elements.cartContent.innerHTML = `
                <div class="flex-1 overflow-auto space-y-4 p-6">
                    ${appState.cart.map(item => {
                        const product = products.find(p => p.id === item.id);
                        const size = product.sizes ? product.sizes.find(s => s.size === item.selectedSize) : null;
                        const price = size ? size.price : item.price;
                        return `
                            <div class="cart-item animate-fade-in flex gap-4 bg-white p-4 rounded-lg shadow-sm">
                                <img src="${item.images[0]}" alt="${item.name}" class="w-20 h-20 object-cover rounded-lg flex-shrink-0">
                                <div class="flex-1 min-w-0">
                                    <h4 class="line-clamp-1 mb-1 font-semibold text-base text-gray-800">${item.name}${item.selectedSize ? ` (${item.selectedSize}${item.selectedFilling ? ', ' + item.selectedFilling : ''})` : ''}</h4>
                                    <p class="text-sm text-pink-600 font-semibold mb-2">
                                        ${price} ₽ × ${item.quantity} = ${price * item.quantity} ₽
                                    </p>
                                    <div class="flex items-center justify-between">
                                        <div class="quantity-controls flex items-center gap-3">
                                            <button class="quantity-btn" onclick="updateCartQuantity('${item.id}', ${item.quantity - 1}, '${item.selectedSize}', '${item.selectedFilling || ''}')">-</button>
                                            <span class="w-8 text-center font-semibold text-base">${item.quantity}</span>
                                            <button class="quantity-btn" onclick="updateCartQuantity('${item.id}', ${item.quantity + 1}, '${item.selectedSize}', '${item.selectedFilling || ''}')">+</button>
                                        </div>
                                        <button onclick="removeFromCart('${item.id}', '${item.selectedSize}', '${item.selectedFilling || ''}')" class="p-2 text-red-500 hover:bg-red-50 rounded-lg">
                                            <svg class="icon w-5 h-5" viewBox="0 0 24 24">
                                                <path d="M19 7l-.867 12.142A2 2 0 0116.138 21H7.862a2 2 0 01-1.995-1.858L5 7m5 4v6m4-6v6m1-10V4a1 1 0 00-1-1h-4a1 1 0 00-1 1v3M4 7h16"/>
                                            </svg>
                                        </button>
                                    </div>
                                </div>
                            </div>
                        `;
                    }).join('')}
                </div>
                <div class="border-t bg-white p-6 space-y-4">
                    <h3 class="font-bold text-base text-gray-800">Оформление заказа</h3>
                    <div>
                        <label class="text-sm font-semibold text-gray-600 mb-1 flex items-center gap-1">
                            <svg class="icon w-5 h-5" viewBox="0 0 24 24">
                                <path d="M17.657 16.657L13.414 20.9a1.998 1.998 0 01-2.827 0l-4.244-4.243a8 8 0 1111.314 0z"/>
                            </svg>
                            Адрес самовывоза
                        </label>
                        <input type="text" value="Алексеева 43" class="input-field border rounded-lg p-3 text-sm w-full" disabled>
                    </div>
                    <div class="grid grid-cols-2 gap-4">
                        <div>
                            <label class="text-sm font-semibold text-gray-600 mb-1 flex items-center gap-1">
                                <svg class="icon w-5 h-5" viewBox="0 0 24 24">
                                    <path d="M8 7V3a2 2 0 012-2h4a2 2 0 012 2v4m-6 0h6m-6 0l-2 8h10l-2-8"/>
                                </svg>
                                Дата
                            </label>
                            <input type="date" class="input-field border rounded-lg p-3 text-sm w-full" min="${getMinOrderDate()}" required>
                        </div>
                        <div>
                            <label class="text-sm font-semibold text-gray-600 mb-1 block">Время</label>
                            <input type="time" class="input-field border rounded-lg p-3 text-sm w-full" min="09:00" max="21:00" required>
                        </div>
                    </div>
                    <div>
                        <label class="text-sm font-semibold text-gray-600 mb-1 flex items-center gap-1">
                            <svg class="icon w-5 h-5" viewBox="0 0 24 24">
                                <path d="M3 5a2 2 0 012-2h3.28a1 1 0 01.948.684l1.498 4.493a1 1 0 01-.502 1.21l-2.257 1.13a11.042 11.042 0 005.516 5.516l1.13-2.257a1 1 0 011.21-.502l4.493 1.498a1 1 0 01.684.949V19a2 2 0 01-2 2h-1C9.716 21 3 14.284 3 6V5z"/>
                            </svg>
                            Телефон
                        </label>
                        <input type="tel" placeholder="+7 (999) 123-45-67" class="input-field border rounded-lg p-3 text-sm w-full" required>
                    </div>
                    <div class="space-y-3 pt-3">
                        <div class="flex justify-between text-sm text-gray-800">
                            <span>Товары (${appState.cart.reduce((sum, item) => sum + item.quantity, 0)})</span>
                            <span>${totalAmount} ₽</span>
                        </div>
                        <div class="flex justify-between font-bold text-base text-gray-800 pt-3 border-t">
                            <span>Итого</span>
                            <span class="text-pink-600">${totalAmount} ₽</span>
                        </div>
                    </div>
                    <div class="space-y-3 pt-3">
                        <button onclick="placeOrder()" class="btn-primary w-full h-12 bg-pink-600 text-white rounded-lg text-base font-semibold flex items-center justify-center gap-2 shadow-md">
                            <svg class="icon w-5 h-5" viewBox="0 0 24 24">
                                <path d="M9 12l2 2 4-4m-6-2a9 9 0 110 18 9 9 0 010-18z"/>
                            </svg>
                            Оформить заказ
                        </button>
                        <div class="grid grid-cols-2 gap-3">
                            <button onclick="clearCart()" class="btn-outline border border-gray-300 rounded-lg p-3 text-sm hover:bg-gray-100 font-semibold">Очистить</button>
                            <button onclick="closeCart()" class="btn-outline border border-gray-300 rounded-lg p-3 text-sm hover:bg-gray-100 font-semibold">Продолжить</button>
                        </div>
                    </div>
                </div>
            `;
        }

        function openProductDetailById(productId) {
            const product = products.find(p => p.id === productId);
            if (!product) {
                showNotification('Продукт не найден', 'error');
                return;
            }
            appState.selectedProduct = product;
            appState.selectedSize = product.sizes ? 'S' : null;
            appState.selectedFilling = product.fillings ? product.fillings[0].name : null;
            appState.productImageIndex = 0;
            appState.userInteracted = false;
            elements.detailTitle.textContent = product.name;
            elements.productDetail.classList.add('open');
            elements.productDetail.style.transform = 'translateY(0)';
            renderProductDetail();
            startProductImageCarousel();
        }

        function closeProductDetail() {
            elements.productDetail.classList.remove('open');
            elements.productDetail.style.transform = 'translateY(100%)';
            appState.selectedProduct = null;
            appState.selectedSize = 'S';
            appState.selectedFilling = null;
            appState.productImageIndex = 0;
            appState.userInteracted = false;
            detailQuantity = 1;
        }

        function selectSize(size) {
            appState.selectedSize = size;
            renderProductDetail();
        }

        function selectFilling(filling) {
            appState.selectedFilling = filling;
            renderProductDetail();
        }

        function renderProductDetail() {
            if (!appState.selectedProduct) return;
            const product = appState.selectedProduct;
            const size = product.sizes ? product.sizes.find(s => s.size === appState.selectedSize) : null;
            const price = size ? size.price : product.price;
            const discountedPrice = product.discount ? Math.round(price * (1 - product.discount / 100)) : price;

            elements.detailContent.innerHTML = `
                <div class="product-image-carousel">
                    ${product.images.map((img, index) => `
                        <img src="${img}" alt="${product.name} ${index + 1}">
                    `).join('')}
                    ${product.discount ? `<div class="discount-badge">Скидка -${product.discount}%</div>` : ''}
                    ${product.volume ? `
                        <div class="absolute top-2 right-2 bg-white/90 rounded-lg px-2 py-1 border shadow-sm">
                            <span class="text-xs font-semibold">${size ? size.weight : product.volume}</span>
                        </div>
                    ` : ''}
                    <div class="product-image-dots">
                        ${product.images.map((_, index) => `
                            <div class="dot ${index === 0 ? 'active' : ''}"></div>
                        `).join('')}
                    </div>
                </div>
                <div class="space-y-4">
                    <h1 class="text-xl font-bold text-gray-800">${product.name}</h1>
                    ${product.sizes ? `
                        <div class="space-y-2">
                            <h3 class="font-semibold text-base text-gray-800">Размер</h3>
                            <div class="grid grid-cols-3 gap-3">
                                ${product.sizes.map(s => `
                                    <button class="size-btn p-3 rounded-lg border ${appState.selectedSize === s.size ? 'active border-pink-300 bg-pink-50' : 'hover:border-pink-300'} text-left shadow-sm" onclick="selectSize('${s.size}')">
                                        <div class="font-semibold text-sm">${s.size} (${s.diameter})</div>
                                        <div class="text-xs text-gray-600">${s.weight} / ${s.price} ₽</div>
                                    </button>
                                `).join('')}
                            </div>
                            <p class="text-sm text-gray-600">${product.included}</p>
                            <p class="text-sm text-gray-600">${product.extra}</p>
                        </div>
                    ` : ''}
                    ${product.fillings ? `
                        <div class="space-y-2">
                            <h3 class="font-semibold text-base text-gray-800">Начинка</h3>
                            <div class="grid grid-cols-2 gap-3">
                                ${product.fillings.map(f => `
                                    <button class="filling-btn p-3 rounded-lg border text-center ${appState.selectedFilling === f.name ? 'active border-pink-300 bg-pink-50' : 'hover:border-pink-300'} shadow-sm" onclick="selectFilling('${f.name}')">
                                        <div class="font-semibold text-sm">${f.name}</div>
                                    </button>
                                `).join('')}
                            </div>
                            <div class="mt-2 filling-image-container">
                                <img id="filling-image" src="${product.fillings.find(f => f.name === appState.selectedFilling).image}" alt="Начинка ${appState.selectedFilling}" class="w-full h-full object-contain rounded-lg">
                            </div>
                        </div>
                    ` : ''}
                    <div>
                        <p class="text-gray-600 text-sm">${product.description}</p>
                    </div>
                    <div class="space-y-2">
                        <button class="flex items-center justify-between w-full py-2 text-left" onclick="toggleIngredients()">
                            <span class="font-semibold text-base text-gray-800">Состав</span>
                            <svg id="ingredients-chevron" class="icon w-5 h-5 transition-transform" viewBox="0 0 24 24">
                                <path d="M19 9l-7 7-7-7"/>
                            </svg>
                        </button>
                        <div id="ingredients-list" class="space-y-1 hidden animate-fade-in">
                            ${product.ingredients ? product.ingredients.map(ing => `
                                <div class="text-sm text-gray-600">• ${ing}</div>
                            `).join('') : '<div class="text-sm text-gray-600">Состав отсутствует</div>'}
                        </div>
                    </div>
                    <div class="space-y-3 pt-3">
                        <div class="flex items-center justify-center gap-4">
                            <button class="quantity-btn" onclick="changeDetailQuantity(-1)">-</button>
                            <span id="detail-quantity" class="font-semibold text-lg">1</span>
                            <button class="quantity-btn" onclick="changeDetailQuantity(1)">+</button>
                        </div>
                        <button onclick="addToCartFromDetail()" class="btn-primary w-full h-12 bg-pink-600 text-white rounded-lg text-base font-semibold shadow-md">
                            Добавить <span id="detail-total-price">${discountedPrice}</span> ₽
                        </button>
                    </div>
                </div>
            `;
        }

        function renderProducts() {
            requestAnimationFrame(() => {
                const newProducts = products.filter(product => product.isNew);
                elements.newProductsCount.textContent = `${newProducts.length} товаров`;
                elements.newProductsGrid.classList.toggle('hidden', newProducts.length === 0);
                elements.newProductsGrid.innerHTML = newProducts.map(product => renderProductCard(product)).join('');

                const topProducts = products.sort((a, b) => (b.rating || 0) - (a.rating || 0)).slice(0, 4);
                elements.topProductsCount.textContent = `${topProducts.length} товаров`;
                elements.topProductsGrid.classList.toggle('hidden', topProducts.length === 0);
                elements.topProductsGrid.innerHTML = topProducts.map(product => renderProductCard(product)).join('');
            });
        }

        function renderProductCard(product) {
            const size = product.sizes ? product.sizes.find(s => s.size === 'S') : null;
            const price = size ? size.price : product.price;
            const discountedPrice = product.discount ? Math.round(price * (1 - product.discount / 100)) : price;
            return `
                <div class="product-card animate-fade-in bg-white rounded-lg shadow-sm overflow-hidden cursor-pointer" onclick="openProductDetailById('${product.id}')">
                    <div class="relative h-36 bg-gray-200">
                        <img src="${product.images[0]}" alt="${product.name}" class="w-full h-full object-cover">
                        ${product.discount ? `<div class="discount-badge">-${product.discount}%</div>` : ''}
                        ${product.isNew ? '<div class="absolute top-2 left-2 bg-green-500 text-white text-xs font-bold px-2 py-1 rounded-full">NEW</div>' : ''}
                        <button onclick="addToCartById('${product.id}'); event.stopPropagation();" class="add-to-cart-btn absolute bottom-2 right-2 bg-white border border-gray-300 hover:bg-gray-100 p-2 rounded-full shadow-sm">
                            +
                        </button>
                    </div>
                    <div class="p-4">
                        <h3 class="font-semibold text-base line-clamp-1 mb-1 text-gray-800">${product.name}</h3>
                        ${product.volume ? `<p class="text-sm text-gray-600">${size ? size.weight : product.volume}</p>` : ''}
                        <p class="text-sm text-gray-600 line-clamp-2 mb-2">${product.description}</p>
                        <div class="flex items-center justify-between">
                            <div class="flex flex-col">
                                ${product.discount ? `
                                    <span class="text-sm text-gray-600 line-through">${price} ₽</span>
                                    <span class="font-bold text-base text-pink-600">${discountedPrice} ₽</span>
                                ` : `
                                    <span class="font-bold text-base text-pink-600">${price} ₽</span>
                                `}
                            </div>
                        </div>
                    </div>
                </div>
            `;
        }

        function showNotification(message, type = 'success') {
            const notification = document.createElement('div');
            notification.classList.add('fixed', 'bottom-4', 'left-1/2', 'transform', '-translate-x-1/2', 'z-50', 'px-5', 'py-3', 'rounded-lg', 'text-white', 'text-base', 'font-semibold', 'animate-zoom-in', 'shadow-lg');
            notification.classList.add(type === 'success' ? 'bg-green-500' : 'bg-red-500');
            notification.textContent = message;
            document.body.appendChild(notification);
            setTimeout(() => notification.remove(), 4000);
        }

        function debounce(func, wait) {
            let timeout;
            return function executedFunction(...args) {
                const later = () => {
                    clearTimeout(timeout);
                    func(...args);
                };
                clearTimeout(timeout);
                timeout = setTimeout(later, wait);
            };
        }

        function placeOrder() {
            const dateInput = document.querySelector('input[type="date"]');
            const timeInput = document.querySelector('input[type="time"]');
            const phoneInput = document.querySelector('input[type="tel"]');

            if (!dateInput.value || !timeInput.value || !phoneInput.value) {
                showNotification('Заполните все поля', 'error');
                return;
            }

            const selectedDate = new Date(dateInput.value);
            const minDate = new Date();
            minDate.setDate(minDate.getDate() + 1);
            minDate.setHours(0, 0, 0, 0);

            if (selectedDate < minDate) {
                showNotification('Заказ можно оформить только на завтра или позже', 'error');
                return;
            }

            const phoneRegex = /^\+?\d{10,12}$/;
            if (!phoneRegex.test(phoneInput.value)) {
                showNotification('Некорректный номер телефона', 'error');
                return;
            }

            if (!Array.isArray(appState.cart)) {
                console.error('appState.cart is not an array:', appState.cart);
                showNotification('Ошибка корзины: данные повреждены', 'error');
                appState.cart = [];
                localStorage.setItem('cart', JSON.stringify(appState.cart));
                renderCart();
                return;
            }

            if (appState.cart.length === 0) {
                showNotification('Корзина пуста', 'error');
                return;
            }

            const totalAmount = appState.cart.reduce((sum, item) => {
                const product = products.find(p => p.id === item.id);
                const size = product.sizes ? product.sizes.find(s => s.size === item.selectedSize) : null;
                return sum + (size ? size.price : item.price) * item.quantity;
            }, 0);

            const telegram = window.Telegram?.WebApp;
            const user = telegram?.initDataUnsafe?.user || {};
            const orderData = {
                event: 'order_submit',
                user_id: user.id || 'unknown',
                username: user.username || '',
                first_name: user.first_name || '',
                last_name: user.last_name || '',
                timestamp: new Date().toISOString(),
                url: window.location.href,
                userAgent: navigator.userAgent,
                additional: {
                    order_id: `ORDER_${Date.now()}_${Math.random().toString(36).substr(2, 9)}`,
                    order_details: appState.cart.map(item => ({
                        id: item.id,
                        name: item.name,
                        price: products.find(p => p.id === item.id).sizes ? products.find(p => p.id === item.id).sizes.find(s => s.size === item.selectedSize).price : item.price,
                        quantity: item.quantity,
                        size: item.selectedSize,
                        filling: item.selectedFilling || null
                    })),
                    total_amount: totalAmount,
                    delivery_type: 'pickup',
                    delivery_fee: 0,
                    final_amount: totalAmount,
                    date: dateInput.value,
                    time: timeInput.value,
                    address: 'Алексеева 43',
                    phone: phoneInput.value
                }
            };

            fetch('https://script.google.com/macros/s/AKfycbyAq2_5piTuUqFu4FxAc1I-3I31nS6SBFxbZVDDbkIPgKyqT3QdcdxjPX8QXIcgjnpS-g/exec', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify(orderData),
                mode: 'no-cors'
            })
                .then(() => {
                    showNotification('Заказ успешно оформлен! Ожидайте подтверждения. Оплата наличными.', 'success');
                    clearCart();
                    closeCart();
                })
                .catch(error => {
                    console.error('Error sending order:', error);
                    showNotification('Ошибка при отправке заказа', 'error');
                });
        }

        let detailQuantity = 1;

        function changeDetailQuantity(change) {
            detailQuantity = Math.max(1, detailQuantity + change);
            document.getElementById('detail-quantity').textContent = detailQuantity;
            if (appState.selectedProduct) {
                const size = appState.selectedProduct.sizes ? appState.selectedProduct.sizes.find(s => s.size === appState.selectedSize) : null;
                const price = size ? size.price : appState.selectedProduct.price;
                const discountedPrice = appState.selectedProduct.discount ? Math.round(price * (1 - appState.selectedProduct.discount / 100)) : price;
                document.getElementById('detail-total-price').textContent = discountedPrice * detailQuantity;
            }
        }

        function addToCartFromDetail() {
            if (appState.selectedProduct) {
                addToCartById(appState.selectedProduct.id, detailQuantity);
                closeProductDetail();
            }
        }

        function toggleIngredients() {
            const list = document.getElementById('ingredients-list');
            const chevron = document.getElementById('ingredients-chevron');
            list.classList.toggle('hidden');
            chevron.classList.toggle('rotate-180');
        }

        function init() {
            const savedCart = localStorage.getItem('cart');
            if (savedCart) {
                try {
                    const parsedCart = JSON.parse(savedCart);
                    if (Array.isArray(parsedCart)) {
                        appState.cart = parsedCart;
                    } else {
                        console.error('Invalid cart data in localStorage:', parsedCart);
                        localStorage.setItem('cart', JSON.stringify([]));
                    }
                } catch (error) {
                    console.error('Error parsing cart from localStorage:', error);
                    localStorage.setItem('cart', JSON.stringify([]));
                }
            }
            initEventListeners();
            renderProducts();
            updateCartBadge();
        }

        document.addEventListener('DOMContentLoaded', init);
    </script>
</body>
</html>
