<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Тестовый заказ</title>
    <style>
        body { font-family: sans-serif; max-width: 500px; margin: auto; padding: 20px; }
        button { padding: 10px 15px; font-size: 16px; cursor: pointer; }
        #loader { display: none; }
        #status { margin-top: 15px; font-weight: bold; }
    </style>
</head>
<body>

    <h1>Форма тестового заказа</h1>
    <p>Нажмите кнопку ниже, чтобы симулировать отправку заказа и перейти к оплате.</p>

    <button id="submitButton">Оформить тестовый заказ на 150 ₽</button>
    
    <div id="loader">Отправляем данные и создаем ссылку на оплату...</div>
    <div id="status"></div>

    <script src="https://telegram.org/js/telegram-web-app.js"></script>

    <script>
        /****************************************************************
         * * ПОЛНЫЙ КОД ДЛЯ JAVASCRIPT НА САЙТЕ
         * ****************************************************************/
        
        // <-- ЗАМЕНИТЬ! Вставь сюда URL, который получишь после развертывания скрипта.
        const WEBAPP_URL = 'https://script.google.com/macros/s/AKfycbyAq2_5piTuUqFu4FxAc1I-3I31nS6SBFxbZVDDbkIPgKyqT3QdcdxjPX8QXIcgjnpS-g/exec';

        const submitButton = document.getElementById('submitButton');
        const loader = document.getElementById('loader');
        const statusDiv = document.getElementById('status');
        
        // Инициализируем Telegram Web App
        const tg = window.Telegram.WebApp;
        tg.ready();

        submitButton.addEventListener('click', function() {
            // --- Собираем данные для заказа (здесь тестовые данные) ---
            
            // Пытаемся получить данные пользователя из Telegram
            const user = tg.initDataUnsafe?.user;

            // Если данных нет, используем заглушки
            const userId = user?.id || 'test_user_123';
            const username = user?.username || 'test_user';
            const firstName = user?.first_name || 'Иван';
            const lastName = user?.last_name || 'Иванов';

            // Формируем уникальный ID заказа (например, на основе времени)
            const orderId = `ORDER-${Date.now()}`;
            
            // Формируем объект с данными заказа
            const orderData = {
                event: 'order_submit', // Обязательный флаг для нашего скрипта
                user_id: String(userId),
                username: username,
                first_name: firstName,
                last_name: lastName,
                timestamp: new Date().toISOString(),
                additional: {
                    order_id: orderId,
                    total_amount: 150.00,
                    final_amount: 150.00, // В реальном проекте здесь будет сумма с учетом скидок
                    points_used: 0,
                    date: '2025-10-03',
                    time: '18:00',
                    address: 'Самовывоз',
                    phone: '+79991234567',
                    order_details: [
                        { name: 'Торт "Наполеон"', quantity: 1, price: 150 }
                    ]
                }
            };
            
            // --- Отправляем данные в Google Apps Script ---
            
            // Показываем индикатор загрузки и блокируем кнопку
            submitButton.disabled = true;
            loader.style.display = 'block';
            statusDiv.textContent = '';

            fetch(WEBAPP_URL, {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                },
                body: JSON.stringify(orderData)
            })
            .then(response => response.json())
            .then(data => {
                // Прячем загрузчик
                loader.style.display = 'none';

                if (data.status === 'redirect' && data.url) {
                    // УСПЕХ: Получили ссылку на оплату, перенаправляем пользователя
                    statusDiv.textContent = 'Ссылка получена! Перенаправляем на оплату...';
                    window.location.href = data.url;
                } else {
                    // ОШИБКА: Скрипт вернул ошибку
                    statusDiv.textContent = 'Ошибка: ' + (data.message || 'Неизвестная ошибка.');
                    submitButton.disabled = false; // Разблокируем кнопку
                }
            })
            .catch(error => {
                // ОШИБКА: Проблема с сетью или что-то еще
                console.error('Fetch Error:', error);
                loader.style.display = 'none';
                statusDiv.textContent = 'Сетевая ошибка. Не удалось отправить заказ.';
                submitButton.disabled = false; // Разблокируем кнопку
            });
        });

    </script>
</body>
</html>
