<!DOCTYPE html>
<html lang="ru">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1,maximum-scale=1,user-scalable=no" />
  <title>Cenelle ‚Äî —Å –ª–æ—è–ª—å–Ω–æ—Å—Ç—å—é</title>
  <script src="https://cdn.tailwindcss.com"></script>
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.15.4/css/all.min.css">
  <style>
    /* –≤—Å—Ç–∞–≤—å—Ç–µ –≤–∞—à–∏ —Å—Ç–∏–ª–∏ (—Å–∫–æ–ø–∏—Ä–æ–≤–∞–Ω—ã –∏–∑ –∏—Å—Ö–æ–¥–Ω–æ–≥–æ + –¥–æ–ø–æ–ª–Ω–∏—Ç–µ–ª—å–Ω—ã–µ –¥–ª—è –ø—Ä–æ—Ñ–∏–ª—è) */
    body{font-family:Inter,system-ui; background:#1E2A25;color:#FAF3EC;margin:0;}
    .header-elements{position:fixed;top:0;left:0;right:0;height:56px;z-index:130;padding:0}
    /* ... –æ—Å—Ç–∞–ª—å–Ω—ã–µ —Å—Ç–∏–ª–∏ –∏–∑ –≤–∞—à–µ–≥–æ —Ñ–∞–π–ª–∞ –º–æ–∂–Ω–æ —Å–∫–æ–ø–∏—Ä–æ–≤–∞—Ç—å —Å—é–¥–∞ ... */
    .profile-modal { position: fixed; inset: 0; display:flex; align-items:center; justify-content:center; z-index:300; }
    .profile-card { background: #25352F; padding:16px; border-radius:12px; width:320px; color:#FAF3EC }
  </style>
</head>
<body>
  <main class="pt-24 pb-20 px-4 max-w-7xl mx-auto relative">
    <div class="header-elements" id="top-bar">
      <div style="position:absolute;left:12px;top:12px">
        <button id="cart-btn">üõí <span id="cart-badge" style="display:none;background:#A15E49;color:#fff;border-radius:999px;padding:2px 6px;font-size:12px">0</span></button>
      </div>
      <div style="position:absolute;left:50%;top:12px;transform:translateX(-50%);font-weight:700;font-size:20px">Cenelle</div>
      <div style="position:absolute;right:12px;top:8px">
        <button id="profile-btn" title="–ü—Ä–æ—Ñ–∏–ª—å">üë§</button>
      </div>
    </div>

    <!-- –∫–æ–Ω—Ç–µ–Ω—Ç: —Ç–æ–≤–∞—Ä—ã (—Å–∫–æ–ø–∏—Ä—É–π—Ç–µ –≤–∞—à—É —Å–µ—Ç–∫—É —Ç–æ–≤–∞—Ä–æ–≤) -->
    <div id="products-grid" class="grid grid-cols-2 gap-4 md:grid-cols-3 lg:grid-cols-4 mb-10"></div>

    <!-- Cart Modal (–∫–∞–∫ —É –≤–∞—Å) -->
    <div id="cart-modal" style="display:none;position:fixed;inset:0;z-index:200;background:rgba(0,0,0,0.4);">
      <div style="background:#1E2A25;height:100vh;padding:16px;overflow:auto;">
        <button id="cart-close-btn">–ó–∞–∫—Ä—ã—Ç—å</button>
        <div id="cart-content"></div>
      </div>
    </div>

    <!-- Checkout modal -->
    <div id="checkout-modal" style="display:none;position:fixed;inset:0;z-index:210;background:rgba(0,0,0,0.4);">
      <div style="background:#1E2A25;margin:auto;max-width:420px;border-radius:12px;padding:16px;">
        <h3>–û—Ñ–æ—Ä–º–ª–µ–Ω–∏–µ –∑–∞–∫–∞–∑–∞</h3>
        <div>
          <label>–î–∞—Ç–∞</label><input id="checkout-date" type="date">
          <label>–í—Ä–µ–º—è</label><input id="checkout-time" type="time" min="09:00" max="21:00">
          <label>–¢–µ–ª–µ—Ñ–æ–Ω</label><input id="checkout-phone" type="tel" placeholder="+7 (999) 123-45-67">
        </div>

        <div style="margin-top:12px">
          <div>–ò—Ç–æ–≥–æ: <span id="checkout-total">0 ‚ÇΩ</span></div>
          <div style="margin-top:8px">
            <label><input type="checkbox" id="use-points-checkbox"> –û–ø–ª–∞—Ç–∏—Ç—å –±–∞–ª–ª–∞–º–∏</label>
            <div id="use-points-controls" style="display:none;margin-top:6px">
              <div>–î–æ—Å—Ç—É–ø–Ω–æ: <span id="user-points">0</span> –±–∞–ª–ª–æ–≤</div>
              <div>–ú–∞–∫—Å –¥–ª—è –æ–ø–ª–∞—Ç—ã (–ø–æ –ø—Ä–∞–≤–∏–ª–∞–º): <span id="max-points-allowed">0</span> –±–∞–ª–ª–æ–≤</div>
              <label>–ü—Ä–∏–º–µ–Ω–∏—Ç—å –±–∞–ª–ª–æ–≤: <input id="apply-points-input" type="number" min="0" step="1" value="0"></label>
            </div>
          </div>
        </div>

        <div style="margin-top:12px">
          <button id="place-order-btn">–û—Ñ–æ—Ä–º–∏—Ç—å –∑–∞–∫–∞–∑</button>
          <button id="checkout-back-btn">–ù–∞–∑–∞–¥</button>
        </div>
      </div>
    </div>

    <!-- Profile modal -->
    <div id="profile-modal" style="display:none;position:fixed;inset:0;z-index:220;background:rgba(0,0,0,0.4);align-items:center;justify-content:center;">
      <div class="profile-card">
        <h3>–ü—Ä–æ—Ñ–∏–ª—å</h3>
        <div>–ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å: <span id="profile-username">@unknown</span></div>
        <div>–ë–∞–ª–ª—ã: <strong id="profile-points">0</strong></div>
        <div style="margin-top:8px"><button id="profile-close">–ó–∞–∫—Ä—ã—Ç—å</button></div>
      </div>
    </div>
  </main>

  <script>
    // URL –≤–∞—à–µ–≥–æ –æ–ø—É–±–ª–∏–∫–æ–≤–∞–Ω–Ω–æ–≥–æ Apps Script web app (doGet/doPost)
    const APPSCRIPT_WEBHOOK_URL = 'https://script.google.com/macros/s/AKfycbyAq2_5piTuUqFu4FxAc1I-3I31nS6SBFxbZVDDbkIPgKyqT3QdcdxjPX8QXIcgjnpS-g/exec'; // –ó–∞–º–µ–Ω–∏—Ç–µ

    // ---------- State ----------
    let appState = { cart: [], user: { user_id: null, username: null, points_balance: 0 }, config: null };

    // ---------- Init ----------
    async function init() {
      // –∑–∞–ø–æ–ª–Ω–∏–º —Ç–æ–≤–∞—Ä—ã (–º–æ–∂–Ω–æ –ø–æ–¥—Å—Ç–∞–≤–∏—Ç—å –≤–∞—à –º–∞—Å—Å–∏–≤ products)
      // –¥–ª—è –∫—Ä–∞—Ç–∫–æ—Å—Ç–∏ –≤–æ–∑—å–º—ë–º —Ç–µ –∂–µ –ø—Ä–æ–¥—É–∫—Ç—ã, –∫–æ—Ç–æ—Ä—ã–µ —É –≤–∞—Å –≤ –∏—Å—Ö–æ–¥–Ω–∏–∫–µ (–∑–¥–µ—Å—å ‚Äî —É–ø—Ä–æ—â—ë–Ω–Ω–æ)
      renderProductsFake(); // –≤—ã–∑–æ–≤ —Ñ—É–Ω–∫—Ü–∏–∏-–∑–∞–º–µ–Ω–∏—Ç–µ–ª—è (–Ω–∏–∂–µ)

      // –∑–∞–ø—Ä–æ—Å–∏–º –∫–æ–Ω—Ñ–∏–≥ –∏, –µ—Å–ª–∏ —É –Ω–∞—Å –µ—Å—Ç—å Telegram user id ‚Äî –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å—Å–∫–∏–µ –¥–∞–Ω–Ω—ã–µ
      // Telegram WebApp initDataUnsafe –¥–æ–ª–∂–µ–Ω —Å–æ–¥–µ—Ä–∂–∞—Ç—å user.id. –ï—Å–ª–∏ –Ω–µ ‚Äî –∏—Å–ø–æ–ª—å–∑—É–π—Ç–µ fallback 'unknown'
      const telegram = window.Telegram?.WebApp;
      const user = telegram?.initDataUnsafe?.user || {};
      appState.user.user_id = user.id ? String(user.id) : 'unknown';
      appState.user.username = user.username || '';

      await fetchConfig();
      await fetchUserInfo();

      updateUIAfterConfig();

      // —Å–æ–±—ã—Ç–∏—è
      document.getElementById('profile-btn').addEventListener('click', () => {
        document.getElementById('profile-modal').style.display = 'flex';
        document.getElementById('profile-username').textContent = appState.user.username ? '@' + appState.user.username : '‚Äî';
        document.getElementById('profile-points').textContent = appState.user.points_balance || 0;
      });
      document.getElementById('profile-close').addEventListener('click', () => document.getElementById('profile-modal').style.display='none');
      document.getElementById('cart-btn').addEventListener('click', openCart);
      document.getElementById('cart-close-btn').addEventListener('click', closeCart);
      document.getElementById('checkout-back-btn').addEventListener('click', closeCheckout);
      document.getElementById('place-order-btn').addEventListener('click', placeOrderFromCheckout);
      document.getElementById('use-points-checkbox').addEventListener('change', toggleUsePoints);
      document.getElementById('apply-points-input').addEventListener('input', onApplyPointsChange);

      updateCartBadge();
    }

    // ---------- Fetch config/user ----------
    async function fetchConfig() {
      try {
        const res = await fetch(APPSCRIPT_WEBHOOK_URL + '?action=config');
        const json = await res.json();
        if (json.status === 'ok') {
          appState.config = json.config;
          // –ø—Ä–∏–≤–µ–¥–µ–Ω–∏–µ —Ç–∏–ø–æ–≤
          appState.config.points_per_ruble = parseFloat(appState.config.points_per_ruble || '0.1');
          appState.config.points_multiplier = parseFloat(appState.config.points_multiplier || '1');
          appState.config.max_points_payment_share = parseFloat(appState.config.max_points_payment_share || '0.3');
        }
      } catch(e) {
        console.error('fetchConfig error', e);
      }
    }

    async function fetchUserInfo() {
      try {
        const res = await fetch(APPSCRIPT_WEBHOOK_URL + '?action=user&user_id=' + encodeURIComponent(appState.user.user_id));
        const json = await res.json();
        if (json.status === 'ok' && json.user) {
          appState.user.points_balance = Number(json.user.points_balance || 0);
          appState.user.username = json.user.username || appState.user.username;
        } else {
          appState.user.points_balance = 0;
        }
      } catch(e) {
        console.error('fetchUserInfo error', e);
        appState.user.points_balance = 0;
      }
    }

    // ---------- Cart / Products (basic) ----------
    function renderProductsFake() {
      // –î–ª—è –±—ã—Å—Ç—Ä–æ–≥–æ –ø—Ä–∏–º–µ—Ä–∞ ‚Äî –≤—Å—Ç–∞–≤—å—Ç–µ –≤–∞—à –º–∞—Å—Å–∏–≤ products –≤ —ç—Ç–æ—Ç –∫–æ–¥.
      // –Ø –¥–æ–±–∞–≤–∏–ª –º–∏–Ω–∏–º–∞–ª—å–Ω—ã–π –ø—Ä–∏–º–µ—Ä —Ç–æ–≤–∞—Ä–∞:
      const products = [
        { id:'1', name:'–ë–µ–Ω—Ç–æ-—Ç–æ—Ä—Ç', price:1400, cartImage:'https://i.postimg.cc/Wznctb7p/photo-2024-11-25-07-51-57.jpg' },
        { id:'2', name:'–ú–æ—Ç–∏', price:100, cartImage:'https://i.postimg.cc/kXVgzs0r/photo-2024-11-25-07-59-12.jpg' }
      ];
      const grid = document.getElementById('products-grid');
      grid.innerHTML = products.map(p => `
        <div class="product-card" style="background:#25352F;padding:8px;border-radius:8px;">
          <img src="${p.cartImage}" style="width:100%;height:140px;object-fit:cover;border-radius:6px"/>
          <div style="padding:8px">
            <div style="font-weight:600">${p.name}</div>
            <div style="color:#B89A6A;font-weight:700">${p.price} ‚ÇΩ</div>
            <div style="margin-top:8px">
              <button onclick="addToCart('${p.id}',1)" class="add-btn">–î–æ–±–∞–≤–∏—Ç—å</button>
            </div>
          </div>
        </div>`).join('');
      // –°–æ—Ö—Ä–∞–Ω–∏–º —Ñ–∏–∫—Ç–∏–≤–Ω—ã–µ –ø—Ä–æ–¥—É–∫—Ç—ã –≤ window –¥–ª—è –∏—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏—è –ø—Ä–∏ –æ—Ñ–æ—Ä–º–ª–µ–Ω–∏–∏
      window._demo_products = products;
    }

    function addToCart(productId, qty=1) {
      const prod = (window._demo_products || []).find(p => p.id === productId);
      if (!prod) return;
      const existing = appState.cart.find(c => c.id === prod.id);
      if (existing) existing.quantity += qty; else appState.cart.push({ ...prod, quantity: qty });
      updateCartBadge();
      showNotification(`${prod.name} –¥–æ–±–∞–≤–ª–µ–Ω –≤ –∫–æ—Ä–∑–∏–Ω—É`);
    }
    function updateCartBadge() {
      const cnt = appState.cart.reduce((s,i)=> s + (i.quantity||0), 0);
      const badge = document.getElementById('cart-badge');
      badge.style.display = cnt>0 ? 'inline-block' : 'none';
      badge.textContent = cnt;
    }

    function openCart() {
      document.getElementById('cart-modal').style.display = 'block';
      renderCart();
    }
    function closeCart() { document.getElementById('cart-modal').style.display = 'none'; }

    function renderCart() {
      const el = document.getElementById('cart-content');
      if (appState.cart.length === 0) { el.innerHTML = '<div>–ö–æ—Ä–∑–∏–Ω–∞ –ø—É—Å—Ç–∞</div>'; return; }
      const rows = appState.cart.map(i => `<div style="display:flex;gap:8px;margin-bottom:8px"><img src="${i.cartImage}" style="width:60px;height:60px;object-fit:cover;border-radius:6px"><div style="flex:1"><div>${i.name}</div><div>${i.price} ‚ÇΩ √ó ${i.quantity}</div></div><div><button onclick="removeFromCart('${i.id}')">‚úñ</button></div></div>`).join('');
      const total = appState.cart.reduce((s,i)=> s + i.price * i.quantity, 0);
      el.innerHTML = `${rows}<div style="margin-top:8px">–ò—Ç–æ–≥–æ: <strong id="cart-sum">${total} ‚ÇΩ</strong></div><div style="margin-top:8px"><button onclick="openCheckout()">–û—Ñ–æ—Ä–º–∏—Ç—å</button></div>`;
    }

    function removeFromCart(id) { appState.cart = appState.cart.filter(i=>i.id !== id); renderCart(); updateCartBadge(); }

    // ---------- Checkout (points logic) ----------
    function openCheckout() {
      // —Ä–∞—Å—Å—á–∏—Ç–∞—Ç—å –∏—Ç–æ–≥–∏
      const total = appState.cart.reduce((s,i) => s + i.price * i.quantity, 0);
      document.getElementById('checkout-total').textContent = total + ' ‚ÇΩ';
      // —Ä–∞—Å—Å—á–∏—Ç–∞—Ç—å –º–∞–∫—Å–∏–º–∞–ª—å–Ω–æ–µ –∫–æ–ª–∏—á–µ—Å—Ç–≤–æ –±–∞–ª–ª–æ–≤ –¥–ª—è –æ–ø–ª–∞—Ç—ã (–ø–æ –ø—Ä–∞–≤–∏–ª–∞–º)
      const maxShare = appState.config ? Number(appState.config.max_points_payment_share || 0.3) : 0.3;
      // –ø—Ä–µ–¥–ø–æ–ª–æ–∂–∏–º 1 –±–∞–ª–ª = 1 ‚ÇΩ (–µ—Å–ª–∏ –∏–Ω–æ–µ ‚Äî –ø–æ–º–µ–Ω—è—Ç—å)
      const maxByShare = Math.floor(total * maxShare);
      const maxByBalance = Math.floor(appState.user.points_balance || 0);
      const maxAllowed = Math.min(maxByShare, maxByBalance);
      document.getElementById('max-points-allowed').textContent = maxAllowed;
      document.getElementById('user-points').textContent = appState.user.points_balance || 0;
      document.getElementById('apply-points-input').max = maxAllowed;
      document.getElementById('apply-points-input').value = 0;
      document.getElementById('use-points-checkbox').checked = false;
      document.getElementById('use-points-controls').style.display = 'none';
      document.getElementById('checkout-modal').style.display = 'block';
    }

    function closeCheckout() { document.getElementById('checkout-modal').style.display = 'none'; }

    function toggleUsePoints(e) {
      document.getElementById('use-points-controls').style.display = e.target.checked ? 'block' : 'none';
    }

    function onApplyPointsChange(e) {
      const applied = Number(e.target.value || 0);
      const max = Number(document.getElementById('apply-points-input').max || 0);
      if (applied > max) {
        e.target.value = max;
      } else if (applied < 0) e.target.value = 0;
    }

    async function placeOrderFromCheckout() {
      const dateInput = document.getElementById('checkout-date');
      const timeInput = document.getElementById('checkout-time');
      const phoneInput = document.getElementById('checkout-phone');
      if (!dateInput.value || !timeInput.value || !phoneInput.value) { showNotification('–ó–∞–ø–æ–ª–Ω–∏—Ç–µ –≤—Å–µ –ø–æ–ª—è', 'error'); return; }
      if (appState.cart.length === 0) { showNotification('–ö–æ—Ä–∑–∏–Ω–∞ –ø—É—Å—Ç–∞', 'error'); return; }

      const totalAmount = appState.cart.reduce((s,i) => s + i.price * i.quantity, 0);
      const usingPoints = document.getElementById('use-points-checkbox').checked;
      const appliedPoints = usingPoints ? Math.floor(Number(document.getElementById('apply-points-input').value || 0)) : 0;
      // –ø—Ä–æ–≤–µ—Ä–∏—Ç—å –æ–≥—Ä–∞–Ω–∏—á–µ–Ω–∏–µ (max 30%)
      const maxShare = appState.config ? Number(appState.config.max_points_payment_share || 0.3) : 0.3;
      const maxByShare = Math.floor(totalAmount * maxShare);
      const allowed = Math.min(maxByShare, Math.floor(appState.user.points_balance || 0));
      const safeApplied = Math.min(appliedPoints, allowed);

      const finalAmount = Math.max(0, totalAmount - safeApplied);

      // –°—Ñ–æ—Ä–º–∏—Ä—É–µ–º orderData
      const telegram = window.Telegram?.WebApp;
      const user = telegram?.initDataUnsafe?.user || {};
      const orderData = {
        event: 'order_submit',
        user_id: user.id || 'unknown',
        username: user.username || '',
        first_name: user.first_name || '',
        last_name: user.last_name || '',
        timestamp: new Date().toISOString(),
        url: window.location.href,
        userAgent: navigator.userAgent,
        additional: {
          order_id: `ORDER_${Date.now()}_${Math.random().toString(36).substr(2,9)}`,
          order_details: appState.cart.map(item => ({ id: item.id, name: item.name, price: item.price, quantity: item.quantity })),
          total_amount: totalAmount,
          delivery_type: 'pickup',
          delivery_fee: 0,
          final_amount: finalAmount,
          date: dateInput.value,
          time: timeInput.value,
          address: '–ê–ª–µ–∫—Å–µ–µ–≤–∞ 43',
          phone: phoneInput.value,
          applied_points: safeApplied
        }
      };

      // –æ—Ç–ø—Ä–∞–≤–∫–∞ –Ω–∞ App Script (POST)
      try {
        await fetch(APPSCRIPT_WEBHOOK_URL, {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify(orderData)
        });
        showNotification('–ó–∞–∫–∞–∑ —É—Å–ø–µ—à–Ω–æ –æ—Ñ–æ—Ä–º–ª–µ–Ω! –û–∂–∏–¥–∞–π—Ç–µ –ø–æ–¥—Ç–≤–µ—Ä–∂–¥–µ–Ω–∏—è.', 'success');
        // –æ–±–Ω–æ–≤–∏–º –ª–æ–∫–∞–ª—å–Ω–æ: —Å–ø–∏—à–µ–º –ø—Ä–∏–º–µ–Ω—ë–Ω–Ω—ã–µ –±–∞–ª–ª—ã, –æ–±–Ω–æ–≤–∏–º –±–∞–ª–∞–Ω—Å —Å —Å–µ—Ä–≤–µ—Ä–∞
        appState.cart = [];
        updateCartBadge();
        await fetchUserInfo();
        document.getElementById('profile-points').textContent = appState.user.points_balance || 0;
        closeCheckout();
      } catch(e) {
        console.error(e);
        showNotification('–û—à–∏–±–∫–∞ –ø—Ä–∏ –æ—Ç–ø—Ä–∞–≤–∫–µ –∑–∞–∫–∞–∑–∞', 'error');
      }
    }

    function showNotification(text, type='success') {
      // –ø—Ä–æ—Å—Ç–æ–π –Ω–æ—Ç–∏—Ñ–∏–∫–µ–π—à–Ω
      alert(text);
    }

    // —Å—Ç–∞—Ä—Ç
    document.addEventListener('DOMContentLoaded', init);
  </script>
</body>
</html>
